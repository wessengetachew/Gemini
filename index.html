
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Modular Reduction Projection Research Portal v2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --main-color: #0f4c75;
            --accent-color: #3282b8;
            --text-color: #bbe1fa;
            --highlight-color: #ffd700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2c3e50;
            line-height: 1.6;
        }

        /* Header and Navigation */
        .site-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            text-align: center;
        }

        .site-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .site-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            font-style: italic;
        }

        /* Tab Navigation */
        .tab-nav {
            background: #2c3e50;
            padding: 0;
            display: flex;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-button {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: #bbe1fa;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background: rgba(255,255,255,0.1);
        }

        .tab-button.active {
            background: rgba(255,255,255,0.15);
            border-bottom-color: var(--highlight-color);
            color: var(--highlight-color);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Portal Tab Styles */
        .portal-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
        }

        .visualization-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .viz-header {
            border-bottom: 3px solid #667eea;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }

        .viz-title {
            font-size: 1.8rem;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .viz-meta {
            font-size: 1rem;
            color: #7f8c8d;
        }

        #vizContainer {
            width: 100%;
            aspect-ratio: 1;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            touch-action: none;
            cursor: grab;
        }

        #vizContainer:active {
            cursor: grabbing;
        }

        #vizSVG {
            width: 100%;
            height: 100%;
            display: block;
        }

        .controls-panel {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
        }

        .controls-panel h2 {
            font-size: 1.5rem;
            color: #667eea;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .control-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #ecf0f1;
        }

        .control-section:last-child {
            border-bottom: none;
        }

        .control-section h3 {
            font-size: 1.1rem;
            color: #34495e;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .control-row {
            margin-bottom: 1rem;
        }

        .control-label {
            display: block;
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 0.4rem;
            font-weight: 500;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input[type="number"],
        select,
        input[type="text"] {
            width: 100%;
            padding: 0.6rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus,
        select:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .value-display {
            display: inline-block;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #667eea;
            min-width: 60px;
            text-align: right;
        }

        button {
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 0.5rem;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            cursor: not-allowed;
            transform: none;
        }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .button-grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.4rem;
            margin-top: 0.8rem;
        }

        .preset-btn {
            padding: 0.5rem;
            font-size: 0.85rem;
            margin: 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 0.8rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #667eea30;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 0.3rem;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #667eea;
            font-family: 'Courier New', monospace;
        }

        .badge {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .badge-prime {
            background: #2ecc71;
            color: white;
        }

        .badge-composite {
            background: #e74c3c;
            color: white;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 0.6rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .info-text {
            font-size: 0.85rem;
            color: #7f8c8d;
            font-style: italic;
            margin-top: 0.5rem;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            z-index: 1000;
            display: none;
            border: 1px solid #667eea;
            font-family: 'Courier New', monospace;
            max-width: 250px;
        }

        .recording-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
            display: none;
            animation: pulse 1.5s infinite;
            z-index: 2000;
        }

        .recording-badge.active {
            display: block;
        }

        .gif-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 2rem 3rem;
            border-radius: 12px;
            font-weight: bold;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 3000;
            text-align: center;
            min-width: 300px;
        }

        .gif-progress.active {
            display: block;
        }

        .gif-progress-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .gif-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        /* Theory Tab Styles */
        .theory-container {
            max-width: 900px;
            margin: 2rem auto;
            background: #ffffff;
            padding: 3rem 4rem;
            box-shadow: 0 0 30px rgba(0,0,0,0.2);
            border: 1px solid #8b7355;
            font-family: 'Garamond', 'Georgia', 'Times New Roman', serif;
            color: #2c2416;
            line-height: 1.8;
        }

        .theory-container h1 {
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 0.5rem;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-bottom: 3px double #8b7355;
            padding-bottom: 1rem;
        }

        .theory-container h2 {
            font-size: 1.8rem;
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            font-weight: normal;
            border-left: 5px solid #8b7355;
            padding-left: 1rem;
        }

        .theory-container h3 {
            font-size: 1.4rem;
            margin-top: 2rem;
            margin-bottom: 0.8rem;
            font-weight: normal;
            font-style: italic;
        }

        .theory-container p {
            text-align: justify;
            margin-bottom: 1rem;
            text-indent: 2em;
        }

        .theory-container .no-indent {
            text-indent: 0;
        }

        .theorem, .definition, .proposition {
            background: #faf8f3;
            border-left: 4px solid #8b7355;
            padding: 1.5rem;
            margin: 1.5rem 0;
            font-style: italic;
        }

        .theorem::before {
            content: "Theorem. ";
            font-weight: bold;
            font-style: normal;
        }

        .definition::before {
            content: "Definition. ";
            font-weight: bold;
            font-style: normal;
        }

        .proposition::before {
            content: "Proposition. ";
            font-weight: bold;
            font-style: normal;
        }

        .divider {
            text-align: center;
            font-size: 1.5rem;
            color: #8b7355;
            margin: 2rem 0;
        }

        .equation {
            text-align: center;
            margin: 1.5rem 0;
            font-size: 1.1rem;
        }

        .list-roman {
            list-style-type: upper-roman;
            margin-left: 3rem;
            margin-bottom: 1rem;
        }

        blockquote {
            font-style: italic;
            margin: 1.5rem 2rem;
            padding-left: 1.5rem;
            border-left: 3px solid #8b7355;
            color: #5c4a3a;
        }

        .controls-panel::-webkit-scrollbar {
            width: 8px;
        }

        .controls-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .controls-panel::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .controls-panel::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        @media (max-width: 1024px) {
            .portal-container {
                grid-template-columns: 1fr;
            }

            .controls-panel {
                max-height: none;
            }

            .site-title {
                font-size: 1.5rem;
            }

            .theory-container {
                padding: 2rem;
            }

            #detailedAnalysis > div {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 640px) {
            .portal-container {
                padding: 0 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .tab-button {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
            }

            #detailedAnalysis {
                font-size: 0.8rem;
                padding: 1rem;
            }

            #detailedAnalysis h3 {
                font-size: 1rem;
            }
        }

        /* 3D Tab Mobile Responsive */
        @media (max-width: 1200px) {
            #chandelier-tab > div {
                padding: 0 1rem !important;
            }
            
            #chandelier-tab > div > div:nth-child(2) {
                display: block !important;
                grid-template-columns: 1fr !important;
            }
            
            #chandelier-tab canvas {
                width: 100% !important;
                height: auto !important;
                aspect-ratio: 1 !important;
            }
            
            #chandelier-tab h1 {
                font-size: 1.8rem !important;
            }
            
            #chandelier-tab > div > div:nth-child(2) > div {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="recording-badge" id="recordingBadge">RECORDING</div>
    <div class="gif-progress" id="gifProgress">
        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">Creating GIF...</div>
        <div id="gifProgressText" style="font-size: 0.9rem; color: #aaa;">Processing frames</div>
        <div class="gif-progress-bar">
            <div class="gif-progress-fill" id="gifProgressFill"></div>
        </div>
    </div>

    <header class="site-header">
        <div class="header-content">
            <h1 class="site-title">Modular Reduction Projection Research Portal</h1>
            <p class="site-subtitle">Interactive Visualization of Number-Theoretic Structures in ℤ/Mℤ</p>
        </div>
    </header>

    <nav class="tab-nav">
        <button class="tab-button active" onclick="switchTab('portal', event)">Interactive Portal</button>
        <button class="tab-button" onclick="switchTab('chandelier', event)">3D Divisor Lattice</button>
        <button class="tab-button" onclick="switchTab('analysis', event)">Analysis & Patterns</button>
        <button class="tab-button" onclick="switchTab('sequences', event)">Custom Sequences</button>
        <button class="tab-button" onclick="switchTab('sieve', event)">Sieve Animation</button>
        <button class="tab-button" onclick="switchTab('compare', event)">Comparative Visualizer</button>
        <button class="tab-button" onclick="switchTab('theory', event)">Mathematical Theory</button>
        <button class="tab-button" onclick="switchTab('about', event)">About</button>
    </nav>

    <!-- PORTAL TAB -->
    <div id="portal-tab" class="tab-content active">
        <div class="portal-container">
            <section class="visualization-section">
                <div class="viz-header">
                    <h2 class="viz-title" id="vizTitle">Modular Space: M = 32</h2>
                    <p class="viz-meta" id="vizMeta">Prime Factorization: 2⁵</p>
                </div>

                <div id="vizContainer">
                    <svg id="vizSVG" viewBox="-500 -500 1000 1000" preserveAspectRatio="xMidYMid meet">
                        <defs>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        <g id="vizGroup"></g>
                    </svg>
                </div>

                <div class="tooltip" id="tooltip"></div>

                <!-- Detailed Analysis Panel -->
                <div id="detailedAnalysis" style="margin-top: 2rem; padding: 1.5rem; background: #1a1a1a; border-radius: 8px; color: #fff; font-family: 'Courier New', monospace; font-size: 0.9rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h3 style="color: #00ffff; margin-bottom: 1rem; font-size: 1.2rem;">Configuration</h3>
                            <div id="configInfo" style="line-height: 1.8;">
                                <div><strong style="color: #00ffff;">Modulus M =</strong> <span id="detailM">32</span></div>
                                <div><strong>Prime Factorization:</strong> <span id="detailFactor">2⁵</span></div>
                                <div><strong>Display Mode:</strong> <span id="detailMode">Projection Lines</span></div>
                                <div><strong>Color Scheme:</strong> <span id="detailColor">Coprime vs Non-coprime</span></div>
                            </div>
                            
                            <h3 style="color: #00ffff; margin-top: 1.5rem; margin-bottom: 1rem; font-size: 1.2rem;">Statistics</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem;">
                                <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 6px; border-left: 3px solid #00ffff;">
                                    <div style="font-size: 0.75rem; color: #aaa;">φ(M)</div>
                                    <div style="font-size: 1.5rem; color: #00ffff;" id="detailPhi">16</div>
                                </div>
                                <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 6px; border-left: 3px solid #ff1493;">
                                    <div style="font-size: 0.75rem; color: #aaa;">Reducible Residues</div>
                                    <div style="font-size: 1.5rem; color: #ff1493;" id="detailReducible">16</div>
                                </div>
                                <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 6px; border-left: 3px solid #ffd700;">
                                    <div style="font-size: 0.75rem; color: #aaa;">Reducibility Ratio</div>
                                    <div style="font-size: 1.5rem; color: #ffd700;" id="detailRatio">50.0%</div>
                                </div>
                                <div style="background: #0a0a0a; padding: 0.8rem; border-radius: 6px; border-left: 3px solid #ffd700;">
                                    <div style="font-size: 0.75rem; color: #aaa;">Farey Channels</div>
                                    <div style="font-size: 1.5rem; color: #ffd700;" id="detailChannels">6</div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 style="color: #00ffff; margin-bottom: 1rem; font-size: 1.2rem;">Color Key</h3>
                            <div style="line-height: 2;">
                                <div><span style="display: inline-block; width: 20px; height: 20px; background: #00ffff; border-radius: 3px; vertical-align: middle; margin-right: 10px;"></span><strong>Cyan</strong> = Irreducible (gcd=1)</div>
                                <div><span style="display: inline-block; width: 20px; height: 20px; background: #ff1493; border-radius: 3px; vertical-align: middle; margin-right: 10px;"></span><strong>Red</strong> = Reducible (gcd>1)</div>
                                <div><span style="display: inline-block; width: 20px; height: 20px; background: #ffd700; border-radius: 3px; vertical-align: middle; margin-right: 10px;"></span><strong>Gold</strong> = Farey Channels & Lines</div>
                                <div><span style="display: inline-block; width: 20px; height: 20px; background: #ffffff; border-radius: 3px; vertical-align: middle; margin-right: 10px;"></span><strong>White</strong> = Outer ring (M circle)</div>
                            </div>
                            
                            <div style="margin-top: 1rem; padding: 1rem; background: #0a0a0a; border-radius: 6px; border-left: 3px solid #00ffff;">
                                <div style="color: #00ffff; font-weight: bold; margin-bottom: 0.5rem;">Farey Lines:</div>
                                <div style="font-size: 0.85rem; line-height: 1.6;">Curved gold lines connect each reducible residue r/M on the outer ring to its reduced form r'/M' on the corresponding inner channel ring.</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h3 style="color: #00ffff; margin-bottom: 1rem; font-size: 1.2rem;">Analysis</h3>
                            <div style="line-height: 1.8;">
                                <div><strong style="color: #00ffff;">Modulus M =</strong> <span id="analysisM">32</span> = <span id="analysisFactorization">2⁵</span></div>
                                <div style="margin-top: 0.8rem;"><strong style="color: #00ffff;">Coprime:</strong> <span id="analysisCoprime">16</span> residues (φ(M))</div>
                                <div><strong style="color: #ff1493;">Reducible:</strong> <span id="analysisReducible">16</span> residues</div>
                                <div><strong style="color: #ffd700;">Ratio:</strong> <span id="analysisRatioPercent">50.0%</span> reducible</div>
                            </div>
                            
                            <h4 style="color: #00ffff; margin-top: 1.5rem; margin-bottom: 0.8rem; font-size: 1rem;">Farey Channels:</h4>
                            <div id="channelBreakdown" style="font-size: 0.85rem; line-height: 1.6; max-height: 200px; overflow-y: auto;">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div>
                            <h3 style="color: #00ffff; margin-bottom: 1rem; font-size: 1.2rem;">Key Result</h3>
                            <div style="background: #0a0a0a; padding: 1.5rem; border-radius: 6px; border: 2px solid #00ffff;">
                                <div style="line-height: 1.8; font-size: 0.95rem;">
                                    <p style="margin-bottom: 1rem;">Every composite M has reducible residues projecting onto simpler Farey channels.</p>
                                    <p style="margin-bottom: 1rem;">The number projecting to channel M' is exactly <strong style="color: #00ffff;">d = M/M'</strong> (multiplicity).</p>
                                </div>
                            </div>
                            
                            <div style="margin-top: 1rem; padding: 1rem; background: #0a0a0a; border-radius: 6px; border-left: 3px solid #ffd700;">
                                <div style="color: #ffd700; font-weight: bold; margin-bottom: 0.5rem;">Note:</div>
                                <div style="font-size: 0.85rem; line-height: 1.6;">
                                    r=0 (with gcd(0,M)=M) is always placed at <strong style="color: #ffd700;">0° = 3 o'clock</strong> position. 
                                    All points are plotted at angle <strong style="color: #ffd700;">θ = 2πr/M</strong> measured counterclockwise from the right.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <aside class="controls-panel">
                <h2>Research Controls</h2>

                <div class="control-section">
                    <h3>Animation Controls</h3>
                    <div class="button-grid">
                        <button id="playBtn" onclick="startAnimation()">▶ Play</button>
                        <button id="stopBtn" onclick="stopAnimation()" disabled>⏸ Stop</button>
                    </div>
                    <div class="control-row">
                        <label class="control-label">Speed: <span class="value-display" id="speedVal">500</span> ms</label>
                        <input type="range" id="speedSlider" min="50" max="2000" step="50" value="500">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="loopCheck" checked>
                        <label for="loopCheck">Loop Animation</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="recordCheck">
                        <label for="recordCheck">Record Frames</label>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Modulus Configuration</h3>
                    <div class="control-row">
                        <label class="control-label">M = <span class="value-display" id="modVal">32</span></label>
                        <input type="range" id="modSlider" min="2" max="5000" value="32">
                    </div>
                    <div class="control-row">
                        <input type="number" id="modInput" min="2" max="10000" value="32" placeholder="Enter M">
                    </div>
                    <div class="preset-grid">
                        <button class="preset-btn" onclick="setM(12)">12</button>
                        <button class="preset-btn" onclick="setM(30)">30</button>
                        <button class="preset-btn" onclick="setM(60)">60</button>
                        <button class="preset-btn" onclick="setM(210)">210</button>
                        <button class="preset-btn" onclick="setM(420)">420</button>
                        <button class="preset-btn" onclick="setM(2310)">2310</button>
                        <button class="preset-btn" onclick="setM(17)">17 Prime</button>
                        <button class="preset-btn" onclick="setM(101)">101 Prime</button>
                        <button class="preset-btn" onclick="setM(1024)">2¹⁰</button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Multi-Modulus View</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="multiModMode">
                        <label for="multiModMode">Enable Multi-Modulus Mode</label>
                    </div>
                    
                    <div id="multiModControls" style="display: none;">
                        <div class="control-row">
                            <label class="control-label">Display Mode</label>
                            <select id="multiModDisplayMode">
                                <option value="consecutive">Consecutive (1 to M)</option>
                                <option value="range">Range (M₁ to M₂)</option>
                                <option value="custom">Custom List</option>
                                <option value="splitscreen">Split Screen (2 or 4)</option>
                                <option value="overlay">Overlay Comparison</option>
                                <option value="difference">Difference Highlight</option>
                            </select>
                        </div>

                        <div id="consecutiveControls">
                            <div class="control-row">
                                <label class="control-label">From: <span class="value-display" id="multiFromVal">1</span></label>
                                <input type="range" id="multiFromSlider" min="1" max="100" value="1">
                            </div>
                            <div class="control-row">
                                <label class="control-label">To: <span class="value-display" id="multiToVal">10</span></label>
                                <input type="range" id="multiToSlider" min="2" max="100" value="10">
                            </div>
                        </div>

                        <div id="rangeControls" style="display: none;">
                            <div class="control-row">
                                <label class="control-label">Start M: <span class="value-display" id="rangeStartVal">30</span></label>
                                <input type="range" id="rangeStartSlider" min="6" max="200" value="30">
                            </div>
                            <div class="control-row">
                                <label class="control-label">End M: <span class="value-display" id="rangeEndVal">40</span></label>
                                <input type="range" id="rangeEndSlider" min="6" max="200" value="40">
                            </div>
                        </div>

                        <div id="customControls" style="display: none;">
                            <div class="control-row">
                                <label class="control-label">Custom Moduli (comma-separated)</label>
                                <input type="text" id="customModList" value="1,3,4,6" 
                                       style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.5); 
                                              border: 1px solid rgba(255,215,0,0.5); color: #fff; 
                                              border-radius: 6px; font-family: monospace;">
                                <p style="font-size: 0.75rem; color: #7f8c8d; margin-top: 0.3rem;">
                                    Example: 1,3,4,6,12 or 30,60,120,210
                                </p>
                            </div>
                        </div>

                        <div id="splitscreenControls" style="display: none;">
                            <div class="control-row">
                                <label class="control-label">Layout</label>
                                <select id="splitLayout">
                                    <option value="2h">2 Horizontal</option>
                                    <option value="2v">2 Vertical</option>
                                    <option value="4">2×2 Grid</option>
                                </select>
                            </div>
                            <div class="control-row">
                                <label class="control-label">Moduli to Compare</label>
                                <input type="text" id="splitModList" value="30,60" 
                                       style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.5); 
                                              border: 1px solid rgba(255,215,0,0.5); color: #fff; 
                                              border-radius: 6px; font-family: monospace;">
                                <p style="font-size: 0.75rem; color: #7f8c8d; margin-top: 0.3rem;">
                                    2 or 4 values, e.g.: 30,60 or 30,60,90,120
                                </p>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="splitSyncZoom" checked>
                                <label for="splitSyncZoom">Sync Zoom & Pan</label>
                            </div>
                        </div>

                        <div id="overlayControls" style="display: none;">
                            <div class="control-row">
                                <label class="control-label">Primary M: <span class="value-display" id="overlayPrimaryVal">30</span></label>
                                <input type="number" id="overlayPrimaryInput" min="2" max="500" value="30" 
                                       style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.5); 
                                              border: 1px solid rgba(255,215,0,0.5); color: #fff; 
                                              border-radius: 6px;">
                            </div>
                            <div class="control-row">
                                <label class="control-label">Overlay M: <span class="value-display" id="overlaySecondVal">60</span></label>
                                <input type="number" id="overlaySecondInput" min="2" max="500" value="60" 
                                       style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.5); 
                                              border: 1px solid rgba(255,215,0,0.5); color: #fff; 
                                              border-radius: 6px;">
                            </div>
                            <div class="control-row">
                                <label class="control-label">Blend Mode</label>
                                <select id="overlayBlendMode">
                                    <option value="alpha">Alpha Blend</option>
                                    <option value="additive">Additive</option>
                                    <option value="difference">Difference</option>
                                    <option value="multiply">Multiply</option>
                                </select>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="overlayHighlightCommon" checked>
                                <label for="overlayHighlightCommon">Highlight Common Points</label>
                            </div>
                        </div>

                        <div id="differenceControls" style="display: none;">
                            <div class="control-row">
                                <label class="control-label">Base M: <span class="value-display" id="diffBaseVal">30</span></label>
                                <input type="number" id="diffBaseInput" min="2" max="500" value="30" 
                                       style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.5); 
                                              border: 1px solid rgba(255,215,0,0.5); color: #fff; 
                                              border-radius: 6px;">
                            </div>
                            <div class="control-row">
                                <label class="control-label">Compare M: <span class="value-display" id="diffCompVal">60</span></label>
                                <input type="number" id="diffCompInput" min="2" max="500" value="60" 
                                       style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.5); 
                                              border: 1px solid rgba(255,215,0,0.5); color: #fff; 
                                              border-radius: 6px;">
                            </div>
                            <div class="control-row">
                                <label class="control-label">Highlight</label>
                                <select id="diffHighlightMode">
                                    <option value="unique">Unique to Each</option>
                                    <option value="common">Common Points</option>
                                    <option value="both">Both (Different Colors)</option>
                                </select>
                            </div>
                        </div>

                        <div class="control-row">
                            <label class="control-label">Color Scheme</label>
                            <select id="multiModColorScheme">
                                <option value="rainbow">Rainbow (by position)</option>
                                <option value="hue">Hue Gradient</option>
                                <option value="distinct">Distinct Colors</option>
                                <option value="size">By Modulus Size</option>
                            </select>
                        </div>

                        <div class="control-row">
                            <label class="control-label">Layer Opacity: <span class="value-display" id="multiOpacityVal">0.7</span></label>
                            <input type="range" id="multiOpacitySlider" min="10" max="100" step="5" value="70">
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="multiStackMode">
                            <label for="multiStackMode">Stack Layers (Offset)</label>
                        </div>
                        
                        <button onclick="quickCompare()" style="width: 100%; padding: 0.7rem; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 0.5rem;">
                            ⚡ Quick Compare (30 vs 60)
                        </button>
                    </div>

                        <div class="control-row" id="stackSpacingControl" style="display: none;">
                            <label class="control-label">Offset: <span class="value-display" id="stackSpacingVal">20</span>px</label>
                            <input type="range" id="stackSpacingSlider" min="5" max="50" step="5" value="20">
                        </div>

                        <button onclick="applyMultiMod()">Apply Multi-Modulus</button>
                        <p style="font-size: 0.75rem; color: #aaa; margin-top: 0.5rem; font-style: italic;">
                            Visualize multiple moduli simultaneously
                        </p>
                    </div>
                </div>

                <div class="control-section">
                    <h3>View Controls</h3>
                    <div class="control-row">
                        <label class="control-label">Zoom: <span class="value-display" id="zoomVal">1.00</span>×</label>
                        <input type="range" id="zoomSlider" min="10" max="500" step="10" value="100">
                    </div>
                    <button onclick="resetView()">↻ Reset View</button>
                </div>

                <div class="control-section">
                    <h3>Statistical Summary</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Modulus</div>
                            <div class="stat-value" id="statM">32</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">φ(M)</div>
                            <div class="stat-value" id="statPhi">16</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Coprime</div>
                            <div class="stat-value" id="statCoprime">16</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Non-coprime</div>
                            <div class="stat-value" id="statNonCoprime">16</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Channels</div>
                            <div class="stat-value" id="statChannels">6</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Density</div>
                            <div class="stat-value" id="statDensity">50.0%</div>
                        </div>
                        <div class="stat-card" style="grid-column: 1 / -1;">
                            <div class="stat-label">Classification</div>
                            <div class="stat-value">
                                <span id="statClass">Composite</span>
                                <span id="statBadge" class="badge badge-composite">ω(M)=3</span>
                            </div>
                        </div>
                    </div>

                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.8rem; font-size: 1rem; color: #555;">Prime Constellations</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Twin (2)</div>
                            <div class="stat-value" id="statTwin">3</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Cousin (4)</div>
                            <div class="stat-value" id="statCousin">2</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Sexy (6)</div>
                            <div class="stat-value" id="statSexy">3</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Gap 8</div>
                            <div class="stat-value" id="statGap8">1</div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Visual Appearance</h3>
                    <div class="control-row">
                        <label class="control-label">Global Thickness Scale: <span class="value-display" id="thicknessVal">1.00</span>×</label>
                        <input type="range" id="thicknessSlider" min="10" max="300" step="10" value="100">
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.3rem; margin-top: 0.5rem;">
                            <button onclick="document.getElementById('thicknessSlider').value=30; document.getElementById('thicknessSlider').oninput({target:{value:30}});" style="padding: 0.3rem; font-size: 0.75rem; margin: 0;">0.3×</button>
                            <button onclick="document.getElementById('thicknessSlider').value=50; document.getElementById('thicknessSlider').oninput({target:{value:50}});" style="padding: 0.3rem; font-size: 0.75rem; margin: 0;">0.5×</button>
                            <button onclick="document.getElementById('thicknessSlider').value=100; document.getElementById('thicknessSlider').oninput({target:{value:100}});" style="padding: 0.3rem; font-size: 0.75rem; margin: 0;">1.0×</button>
                            <button onclick="document.getElementById('thicknessSlider').value=150; document.getElementById('thicknessSlider').oninput({target:{value:150}});" style="padding: 0.3rem; font-size: 0.75rem; margin: 0;">1.5×</button>
                            <button onclick="document.getElementById('thicknessSlider').value=200; document.getElementById('thicknessSlider').oninput({target:{value:200}});" style="padding: 0.3rem; font-size: 0.75rem; margin: 0;">2.0×</button>
                        </div>
                        <p style="font-size: 0.75rem; color: #7f8c8d; margin-top: 0.3rem; font-style: italic;">
                            Scales all points and lines uniformly. Increase for small M, decrease for large M.
                        </p>
                    </div>
                    <div class="control-row">
                        <label class="control-label">Color Scheme</label>
                        <select id="colorScheme">
                            <option value="type" selected>Coprime vs Non-coprime</option>
                            <option value="spf">Smallest Prime Factor</option>
                            <option value="lpf">Largest Prime Factor</option>
                            <option value="gcd">GCD Value</option>
                            <option value="depth">Channel Depth</option>
                            <option value="rainbow">Rainbow Spectrum</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label class="control-label">Point Size: <span class="value-display" id="pointSizeVal">3.0</span></label>
                        <input type="range" id="pointSizeSlider" min="1" max="10" step="0.5" value="3">
                    </div>
                    <div class="control-row">
                        <label class="control-label">Line Opacity: <span class="value-display" id="opacityVal">100</span>%</label>
                        <input type="range" id="opacitySlider" min="0" max="100" step="5" value="100">
                    </div>
                </div>

                <div class="control-section">
                    <h3>Geometric Parameters</h3>
                    <div class="control-row">
                        <label class="control-label">Ring Spacing: <span class="value-display" id="spacingVal">1.00</span></label>
                        <input type="range" id="spacingSlider" min="0" max="200" step="5" value="100">
                    </div>
                    <div class="control-row">
                        <label class="control-label">Minimum Ring (M'): <span class="value-display" id="minRingVal">1</span></label>
                        <input type="range" id="minRingSlider" min="1" max="100" step="1" value="1">
                    </div>
                    <div class="control-row">
                        <label class="control-label">Rotation Angle: <span class="value-display" id="rotationVal">0</span>°</label>
                        <input type="range" id="rotationSlider" min="0" max="360" step="1" value="0">
                    </div>
                </div>

                <div class="control-section">
                    <h3>Point Labels</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showLabels">
                        <label for="showLabels">Show Point Labels</label>
                    </div>
                    <div class="control-row">
                        <label class="control-label">Label Mode</label>
                        <select id="labelMode">
                            <option value="r" selected>Residue (r)</option>
                            <option value="r/M">Fraction (r/M)</option>
                            <option value="reduced">Reduced Fraction (r'/M')</option>
                            <option value="gcd">GCD(r,M)</option>
                            <option value="angle">Angle (degrees)</option>
                            <option value="angle-rad">Angle (radians)</option>
                            <option value="coprime">Coprime Status</option>
                            <option value="channel">Channel (M')</option>
                            <option value="all">All Info</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label class="control-label">Inner Ring Labels</label>
                        <select id="innerLabelMode">
                            <option value="none" selected>No Labels</option>
                            <option value="r">Residue (r)</option>
                            <option value="r/M">Fraction (r/M')</option>
                            <option value="gcd">GCD(r,M')</option>
                            <option value="same">Same as Outer</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label class="control-label">Label Size: <span class="value-display" id="labelSizeVal">12</span>px</label>
                        <input type="range" id="labelSizeSlider" min="6" max="48" step="2" value="12">
                    </div>
                    <div class="control-row">
                        <label class="control-label">Label Distance: <span class="value-display" id="labelDistVal">1.15</span>×</label>
                        <input type="range" id="labelDistSlider" min="100" max="200" step="5" value="115">
                        <p style="font-size: 0.75rem; color: #7f8c8d; margin-top: 0.3rem; font-style: italic;">
                            Distance from point center (1.0 = at point, >1.0 = outside)
                        </p>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="labelBackground">
                        <label for="labelBackground">Label Background</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="labelCoprimesOnly">
                        <label for="labelCoprimesOnly">Label Coprimes Only</label>
                    </div>
                    <div class="control-row">
                        <label class="control-label">Label Every Nth Point: <span class="value-display" id="labelEveryVal">1</span></label>
                        <input type="range" id="labelEverySlider" min="1" max="20" step="1" value="1">
                        <p style="font-size: 0.75rem; color: #7f8c8d; margin-top: 0.3rem; font-style: italic;">
                            For large M, label every 5th or 10th point to reduce clutter
                        </p>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Display Options</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showProjections" checked>
                        <label for="showProjections">Projection Lines</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showRings" checked>
                        <label for="showRings">Channel Rings</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showInnerRings" checked>
                        <label for="showInnerRings">Inner Ring Points</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="colorInner">
                        <label for="colorInner">Color Inner Points</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showSymmetry">
                        <label for="showSymmetry">Show Symmetry Axes</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="highlightPrimes">
                        <label for="highlightPrimes">Highlight Prime Residues</label>
                    </div>
                    <div class="control-row">
                        <label class="control-label">Constellation Highlight</label>
                        <select id="gapSelect">
                            <option value="none" selected>None</option>
                            <option value="2">Twin (Gap 2)</option>
                            <option value="4">Cousin (Gap 4)</option>
                            <option value="6">Sexy (Gap 6)</option>
                            <option value="8">Gap 8</option>
                            <option value="10">Gap 10</option>
                            <option value="12">Gap 12</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label class="control-label">Filter Residues</label>
                        <select id="filterType">
                            <option value="none" selected>All Residues</option>
                            <option value="prime">r is Prime</option>
                            <option value="square">r is Perfect Square</option>
                            <option value="fibonacci">r in Fibonacci Sequence</option>
                            <option value="power2">r is Power of 2</option>
                            <option value="quadratic">Quadratic Residues</option>
                        </select>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Advanced Analysis</h3>
                    <button onclick="analyzePattern()">Pattern Analysis</button>
                    <button onclick="compareModuli()">Compare Moduli</button>
                    <button onclick="findInteresting()">Find Interesting M</button>
                    <button onclick="showTheorems()">Mathematical Theorems</button>
                    <div id="analysisResults" style="margin-top: 1rem; padding: 0.8rem; background: #f0f0f0; border-radius: 6px; display: none; max-height: 300px; overflow-y: auto; font-size: 0.85rem; color: #333;"></div>
                </div>

                <div class="control-section">
                    <h3>Number Generators</h3>
                    <p style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 1rem; line-height: 1.5;">
                        Generate special numbers with rich mathematical structure
                    </p>
                    <div style="margin-bottom: 0.8rem;">
                        <button onclick="generatePrimorial()">Generate Primorial</button>
                        <p style="font-size: 0.8rem; color: #7f8c8d; margin-top: 0.3rem; margin-left: 0.5rem;">
                            Product of first n primes (e.g., 2×3×5 = 30)
                        </p>
                    </div>
                    <div style="margin-bottom: 0.8rem;">
                        <button onclick="generateFactorial()">Generate Factorial</button>
                        <p style="font-size: 0.8rem; color: #7f8c8d; margin-top: 0.3rem; margin-left: 0.5rem;">
                            n! - divisible by all numbers up to n
                        </p>
                    </div>
                    <div style="margin-bottom: 0.8rem;">
                        <button onclick="generateHighlyComposite()">Highly Composite</button>
                        <p style="font-size: 0.8rem; color: #7f8c8d; margin-top: 0.3rem; margin-left: 0.5rem;">
                            Numbers with maximum divisors for their size
                        </p>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Data Export</h3>
                    <div class="control-row">
                        <label class="control-label">Export Resolution (px)</label>
                        <input type="number" id="exportRes" value="3000" min="1000" max="8000" step="500">
                    </div>
                    <div class="button-grid-3">
                        <button onclick="exportPNG()">PNG</button>
                        <button onclick="exportCSV()">CSV</button>
                        <button onclick="exportJSON()">JSON</button>
                    </div>
                    <button onclick="exportFrames()">Export Frames (PNG)</button>
                    <button onclick="exportAnimationZIP()">📦 Export Animation (ZIP of PNGs)</button>
                    <button onclick="exportLaTeX()">Export LaTeX Code</button>
                </div>
            </aside>
        </div>
    </div>

    <!-- 3D FAREY DIVISOR LATTICE TAB -->
    <div id="chandelier-tab" class="tab-content">
        <div style="max-width: 1600px; margin: 2rem auto; padding: 0 2rem;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h1 style="color: #667eea; font-size: 2.5rem; margin-bottom: 0.5rem;">3D Farey Divisor Lattice</h1>
                <p style="color: #666; font-size: 1.2rem; font-style: italic;">
                    Hierarchical Structure of Modular Reduction in ℤ/Mℤ
                </p>
            </div>

            <div style="display: grid; grid-template-columns: 300px 1fr 300px; gap: 2rem; min-height: 800px;">
                <!-- Left Panel -->
                <div style="background: rgba(26, 26, 46, 0.05); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.3);">
                    <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin-bottom: 1rem;">Modulus</h3>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #666;">M = <span id="chandM" style="color: #667eea; font-weight: bold;">30</span></label>
                        <input type="range" id="chandMSlider" min="6" max="2000" value="30" style="width: 100%;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <input type="number" id="chandMInput" min="6" max="2000" value="30" 
                               style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <button onclick="setChandM(30)" style="padding: 0.5rem; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">30</button>
                        <button onclick="setChandM(60)" style="padding: 0.5rem; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">60</button>
                        <button onclick="setChandM(120)" style="padding: 0.5rem; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">120</button>
                        <button onclick="setChandM(210)" style="padding: 0.5rem; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">210</button>
                    </div>

                    <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin-bottom: 1rem;">3D Rotation</h3>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem; color: #666;">
                            X-Tilt: <span id="chandXTiltVal" style="color: #667eea; font-weight: bold;">45</span>°
                        </label>
                        <input type="range" id="chandXTiltSlider" min="-90" max="90" value="45" style="width: 100%;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem; color: #666;">
                            Y-Rotation: <span id="chandYRotVal" style="color: #667eea; font-weight: bold;">0</span>°
                        </label>
                        <input type="range" id="chandYRotSlider" min="0" max="360" value="0" style="width: 100%;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem; color: #666;">
                            Z-Spin: <span id="chandZSpinVal" style="color: #667eea; font-weight: bold;">0</span>°
                        </label>
                        <input type="range" id="chandZSpinSlider" min="0" max="360" value="0" style="width: 100%;">
                    </div>

                    <button onclick="resetChandRotation()" style="width: 100%; padding: 0.7rem; background: #764ba2; color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 1.5rem;">
                        Reset Rotation
                    </button>

                    <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin-bottom: 1rem;">Spacing</h3>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem; color: #666;">
                            Vertical: <span id="chandVSpaceVal" style="color: #667eea; font-weight: bold;">1.0</span>
                        </label>
                        <input type="range" id="chandVSpaceSlider" min="0" max="200" value="100" style="width: 100%;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem; color: #666;">
                            Radial: <span id="chandRadScaleVal" style="color: #667eea; font-weight: bold;">1.0</span>
                        </label>
                        <input type="range" id="chandRadScaleSlider" min="50" max="150" value="100" style="width: 100%;">
                    </div>

                    <div style="background: rgba(102, 126, 234, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1.5rem; font-size: 0.85rem; line-height: 1.6; color: #666;">
                        <strong style="color: #667eea;">💡 Tip:</strong> Drag on canvas to rotate! Press Space for auto-rotate.
                    </div>

                    <div style="background: rgba(26, 26, 46, 0.05); padding: 1rem; border-radius: 8px; margin-top: 1rem; font-size: 0.8rem; line-height: 1.6; color: #666; border-left: 3px solid #667eea;">
                        <strong style="color: #667eea;">Lattice Structure:</strong> The divisors of M form a partially ordered set (lattice) under divisibility. This visualization embeds the lattice vertically, with quotient rings ℤ/M'ℤ represented as horizontal layers. Farey chains connect each residue to its canonical representative under the reduction homomorphism.
                    </div>
                </div>

                <!-- Center Canvas -->
                <div style="background: #000; border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; border: 2px solid #667eea;">
                    <canvas id="chandelier-canvas" width="1200" height="1200" style="max-width: 100%; max-height: 100%; display: block;"></canvas>
                    <div style="position: absolute; top: 1rem; left: 1rem; background: rgba(0,0,0,0.8); padding: 1rem; border-radius: 8px; border: 1px solid #667eea;">
                        <div style="color: #ffd700; font-size: 1.1rem; font-weight: bold; margin-bottom: 0.3rem;">M = <span id="chandTitleM">30</span></div>
                        <div style="color: #aaa; font-size: 0.85rem;">Lattice Levels: <span id="chandTitleRings">8</span></div>
                        <div style="color: #aaa; font-size: 0.85rem;">Reduction Maps: <span id="chandTitleChains">22</span></div>
                    </div>
                </div>

                <!-- Right Panel -->
                <div style="background: rgba(26, 26, 46, 0.05); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.3);">
                    <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin-bottom: 1rem;">Ring Dynamics</h3>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem; color: #666;">
                            Inner→Outer: <span id="chandInnerSpeedVal" style="color: #667eea; font-weight: bold;">0</span>°/s
                        </label>
                        <input type="range" id="chandInnerSpeedSlider" min="-50" max="50" value="0" style="width: 100%;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem; color: #666;">
                            Outer→Inner: <span id="chandOuterSpeedVal" style="color: #667eea; font-weight: bold;">0</span>°/s
                        </label>
                        <input type="range" id="chandOuterSpeedSlider" min="-50" max="50" value="0" style="width: 100%;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem; color: #666;">
                            Individual: <span id="chandIndivSpeedVal" style="color: #667eea; font-weight: bold;">0</span>°/s
                        </label>
                        <input type="range" id="chandIndivSpeedSlider" min="-50" max="50" value="0" style="width: 100%;">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                        <button id="chandPlayBtn" onclick="playChandAnimation()" style="padding: 0.7rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            ▶ Play
                        </button>
                        <button id="chandStopBtn" onclick="stopChandAnimation()" style="padding: 0.7rem; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; display: none;">
                            ⬛ Stop
                        </button>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="chandAnimateCheck" style="margin-right: 0.5rem;">
                            <span style="color: #666;">Animate Rings</span>
                        </label>
                    </div>

                    <button onclick="resetChandRings()" style="width: 100%; padding: 0.7rem; background: #764ba2; color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 1.5rem;">
                        Reset Ring Rotations
                    </button>

                    <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin-bottom: 1rem;">Display</h3>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="chandShowChains" checked style="margin-right: 0.5rem;">
                            <span style="color: #666;">Show Farey Chains</span>
                        </label>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="chandShowLabels" style="margin-right: 0.5rem;">
                            <span style="color: #666;">Show Labels</span>
                        </label>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="chandAutoRotate" style="margin-right: 0.5rem;">
                            <span style="color: #666;">Auto-Rotate</span>
                        </label>
                    </div>

                    <button onclick="exportChandelier()" style="width: 100%; padding: 0.7rem; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 1rem;">
                        Export PNG
                    </button>

                    <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin: 1.5rem 0 1rem 0;">Color Legend</h3>
                    
                    <div style="padding: 0.8rem; background: rgba(0,0,0,0.05); border-radius: 6px;">
                        <div style="margin-bottom: 0.6rem; display: flex; align-items: center;">
                            <span style="display: inline-block; width: 16px; height: 16px; background: #00ffff; border-radius: 50%; margin-right: 0.5rem;"></span>
                            <span style="color: #00ffff; font-weight: bold; font-size: 0.9rem;">Coprime (gcd(r,M)=1)</span>
                        </div>
                        <div style="margin-bottom: 0.6rem; display: flex; align-items: center;">
                            <span style="display: inline-block; width: 16px; height: 16px; background: #ffff00; border-radius: 50%; margin-right: 0.5rem;"></span>
                            <span style="color: #cc9900; font-weight: bold; font-size: 0.9rem;">Reducible (gcd(r,M)>1)</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <span style="display: inline-block; width: 16px; height: 16px; background: #ff0000; border-radius: 50%; margin-right: 0.5rem;"></span>
                            <span style="color: #ff0000; font-weight: bold; font-size: 0.9rem;">Identity (r≡0)</span>
                        </div>
                    </div>

                    <div style="background: rgba(102, 126, 234, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1.5rem; font-size: 0.85rem; line-height: 1.6; color: #666;">
                        <strong style="color: #667eea;">⌨️ Shortcuts:</strong><br>
                        <code style="background: rgba(0,0,0,0.1); padding: 0.2rem 0.4rem; border-radius: 3px;">R</code> Reset rotation<br>
                        <code style="background: rgba(0,0,0,0.1); padding: 0.2rem 0.4rem; border-radius: 3px;">Space</code> Auto-rotate<br>
                        <code style="background: rgba(0,0,0,0.1); padding: 0.2rem 0.4rem; border-radius: 3px;">C</code> Toggle Farey chains<br>
                        <code style="background: rgba(0,0,0,0.1); padding: 0.2rem 0.4rem; border-radius: 3px;">L</code> Toggle labels
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ANALYSIS & PATTERNS TAB -->
    <div id="analysis-tab" class="tab-content">
        <div style="max-width: 1600px; margin: 2rem auto; padding: 0 2rem;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h1 style="color: #667eea; font-size: 2.5rem; margin-bottom: 0.5rem;">Analysis & Patterns</h1>
                <p style="color: #666; font-size: 1.2rem; font-style: italic;">
                    Deep Mathematical Analysis of Modular Structures
                </p>
            </div>

            <!-- Control Panel -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem; border-radius: 12px; margin-bottom: 2rem; color: white;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; align-items: end;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Primary Modulus (M₁)</label>
                        <input type="number" id="analysisM1" value="30" min="2" max="2000" 
                               style="width: 100%; padding: 0.7rem; border-radius: 6px; border: none; font-size: 1rem;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Compare with (M₂) - Optional</label>
                        <input type="number" id="analysisM2" value="60" min="2" max="2000" 
                               style="width: 100%; padding: 0.7rem; border-radius: 6px; border: none; font-size: 1rem;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Range Analysis</label>
                        <select id="analysisRange" style="width: 100%; padding: 0.7rem; border-radius: 6px; border: none; font-size: 1rem;">
                            <option value="single">Single M Value</option>
                            <option value="compare">Compare M₁ vs M₂</option>
                            <option value="range">Range M₁ to M₂</option>
                        </select>
                    </div>
                    <div>
                        <button onclick="runAnalysis()" style="width: 100%; padding: 0.7rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem;">
                            🔍 Analyze
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <!-- Key Statistics -->
                <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h2 style="color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 0.5rem; margin-bottom: 1.5rem;">Key Statistics</h2>
                    <div id="keyStats" style="font-size: 0.95rem; line-height: 1.8;"></div>
                </div>

                <!-- Channel Breakdown -->
                <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h2 style="color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 0.5rem; margin-bottom: 1.5rem;">Farey Channel Breakdown</h2>
                    <div id="channelBreakdown" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <!-- Gap Distribution -->
                <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h2 style="color: #667eea; margin-bottom: 1rem;">Gap Distribution</h2>
                    <canvas id="gapChart" style="max-height: 300px;"></canvas>
                </div>

                <!-- Density Analysis -->
                <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h2 style="color: #667eea; margin-bottom: 1rem;">Coprime Density</h2>
                    <canvas id="densityChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <!-- Totient Function -->
                <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h2 style="color: #667eea; margin-bottom: 1rem;">Euler Totient φ(M)</h2>
                    <canvas id="totientChart" style="max-height: 300px;"></canvas>
                </div>

                <!-- Divisor Count -->
                <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h2 style="color: #667eea; margin-bottom: 1rem;">Divisor Structure</h2>
                    <canvas id="divisorChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Pattern Detection -->
            <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                <h2 style="color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 0.5rem; margin-bottom: 1.5rem;">Pattern Detection</h2>
                <div id="patternDetection" style="font-size: 0.95rem; line-height: 1.8;"></div>
            </div>

            <!-- Export Section -->
            <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); padding: 2rem; border-radius: 12px; text-align: center;">
                <h2 style="color: white; margin-bottom: 1rem;">Export Analysis</h2>
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button onclick="exportAnalysisCSV()" style="padding: 1rem 2rem; background: white; color: #28a745; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        📊 Export CSV Data
                    </button>
                    <button onclick="exportAnalysisJSON()" style="padding: 1rem 2rem; background: white; color: #28a745; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        📋 Export JSON
                    </button>
                    <button onclick="exportAnalysisReport()" style="padding: 1rem 2rem; background: white; color: #28a745; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        📄 Export Full Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CUSTOM SEQUENCES TAB -->
    <div id="sequences-tab" class="tab-content">
        <div style="max-width: 1600px; margin: 2rem auto; padding: 0 2rem;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h1 style="color: #667eea; font-size: 2.5rem; margin-bottom: 0.5rem;">Custom Sequences Explorer</h1>
                <p style="color: #666; font-size: 1.2rem; font-style: italic;">
                    Visualize Any Sequence Modulo M
                </p>
            </div>

            <div style="display: grid; grid-template-columns: 350px 1fr; gap: 2rem;">
                <!-- Left Control Panel -->
                <div style="background: rgba(26, 26, 46, 0.05); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.3);">
                    <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin-bottom: 1rem;">Sequence Selection</h3>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #666;">Preset Sequences:</label>
                        <select id="seqPreset" style="width: 100%; padding: 0.7rem; border-radius: 6px; border: 1px solid #ddd; font-size: 0.95rem;">
                            <option value="fibonacci">Fibonacci Numbers</option>
                            <option value="primes">Prime Numbers</option>
                            <option value="squares">Perfect Squares (n²)</option>
                            <option value="cubes">Perfect Cubes (n³)</option>
                            <option value="triangular">Triangular Numbers</option>
                            <option value="pentagonal">Pentagonal Numbers</option>
                            <option value="catalan">Catalan Numbers</option>
                            <option value="factorial">Factorials (n!)</option>
                            <option value="powers2">Powers of 2 (2ⁿ)</option>
                            <option value="powers3">Powers of 3 (3ⁿ)</option>
                            <option value="lucas">Lucas Numbers</option>
                            <option value="tribonacci">Tribonacci Numbers</option>
                            <option value="collatz">Collatz Sequence (start=n)</option>
                            <option value="custom">Custom Formula...</option>
                        </select>
                    </div>

                    <div id="seqCustomFormula" style="margin-bottom: 1.5rem; display: none;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #666;">Custom Formula (use 'n'):</label>
                        <input type="text" id="seqFormula" placeholder="e.g., n*n + n + 1" 
                               style="width: 100%; padding: 0.7rem; border-radius: 6px; border: 1px solid #ddd; font-family: 'Courier New', monospace;">
                        <p style="font-size: 0.8rem; color: #999; margin-top: 0.3rem;">Supports: +, -, *, /, ^, %, sqrt(), abs()</p>
                    </div>

                    <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin: 1.5rem 0 1rem;">Parameters</h3>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #666;">Modulus M = <span id="seqM" style="color: #667eea; font-weight: bold;">30</span></label>
                        <input type="range" id="seqMSlider" min="2" max="500" value="30" style="width: 100%;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <input type="number" id="seqMInput" min="2" max="2000" value="30" 
                               style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px;">
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #666;">Terms to Show: <span id="seqTerms" style="color: #667eea; font-weight: bold;">100</span></label>
                        <input type="range" id="seqTermsSlider" min="10" max="500" value="100" style="width: 100%;">
                    </div>

                    <button onclick="generateSequence()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; margin-bottom: 1.5rem;">
                        🎲 Generate Sequence
                    </button>

                    <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin-bottom: 1rem;">Display Options</h3>
                    
                    <div style="margin-bottom: 0.8rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="seqShowConnections" checked style="margin-right: 0.5rem;">
                            <span style="color: #666;">Show Connections</span>
                        </label>
                    </div>
                    <div style="margin-bottom: 0.8rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="seqShowLabels" style="margin-right: 0.5rem;">
                            <span style="color: #666;">Show Value Labels</span>
                        </label>
                    </div>
                    <div style="margin-bottom: 0.8rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="seqHighlightPeriod" checked style="margin-right: 0.5rem;">
                            <span style="color: #666;">Highlight Period</span>
                        </label>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="seqAnimate" style="margin-right: 0.5rem;">
                            <span style="color: #666;">Animate Sequence</span>
                        </label>
                    </div>

                    <button onclick="exportSequenceData()" style="width: 100%; padding: 0.7rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 0.5rem;">
                        📊 Export Data (CSV)
                    </button>
                    <button onclick="exportSequenceImage()" style="width: 100%; padding: 0.7rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        🖼️ Export Image (PNG)
                    </button>

                    <div style="background: rgba(102, 126, 234, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1.5rem; font-size: 0.85rem; line-height: 1.6; color: #666;">
                        <strong style="color: #667eea;">💡 Examples:</strong><br>
                        • Fibonacci mod 10 (Pisano period)<br>
                        • Primes mod 6 (always 1 or 5)<br>
                        • Squares mod 8 (only 0,1,4)<br>
                        • Custom: n²+n+41 (prime-rich)
                    </div>
                </div>

                <!-- Right Visualization Panel -->
                <div>
                    <!-- Canvas -->
                    <div style="background: #000; border-radius: 12px; margin-bottom: 1.5rem; position: relative;">
                        <canvas id="sequenceCanvas" width="1000" height="1000" style="width: 100%; height: auto; display: block; border-radius: 12px;"></canvas>
                    </div>

                    <!-- Analysis Results -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <h3 style="color: #667eea; margin-bottom: 1rem; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem;">Period Analysis</h3>
                            <div id="seqPeriodInfo" style="font-size: 0.95rem; line-height: 1.8;"></div>
                        </div>

                        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <h3 style="color: #667eea; margin-bottom: 1rem; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem;">Distribution</h3>
                            <div id="seqDistInfo" style="font-size: 0.95rem; line-height: 1.8;"></div>
                        </div>
                    </div>

                    <!-- Sequence Values Table -->
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <h3 style="color: #667eea; margin-bottom: 1rem; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem;">Sequence Values</h3>
                        <div id="seqValuesTable" style="max-height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.9rem;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SIEVE ANIMATION TAB -->
    <div id="sieve-tab" class="tab-content">
        <div style="max-width: 1600px; margin: 2rem auto; padding: 0 2rem;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h1 style="color: #667eea; font-size: 2.5rem; margin-bottom: 0.5rem;">Sieve Animation</h1>
                <p style="color: #666; font-size: 1.2rem; font-style: italic;">
                    Watch Prime & Modular Sieves in Action
                </p>
            </div>

            <div style="display: grid; grid-template-columns: 320px 1fr; gap: 2rem;">
                <!-- Left Control Panel -->
                <div style="background: rgba(26, 26, 46, 0.05); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.3);">
                    <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin-bottom: 1rem;">Sieve Algorithm</h3>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <select id="sieveAlgorithm" style="width: 100%; padding: 0.7rem; border-radius: 6px; border: 1px solid #ddd; font-size: 0.95rem;">
                            <option value="eratosthenes">Eratosthenes (Primes)</option>
                            <option value="modular">Modular Reduction</option>
                            <option value="channel">Channel-by-Channel</option>
                            <option value="sundaram">Sundaram (Odd Primes)</option>
                        </select>
                    </div>

                    <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin-bottom: 1rem;">Parameters</h3>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #666;">Upper Limit N = <span id="sieveN" style="color: #667eea; font-weight: bold;">100</span></label>
                        <input type="range" id="sieveNSlider" min="10" max="500" value="100" style="width: 100%;">
                    </div>

                    <div id="sieveModulusControl" style="margin-bottom: 1rem; display: none;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #666;">Modulus M = <span id="sieveM" style="color: #667eea; font-weight: bold;">30</span></label>
                        <input type="range" id="sieveMSlider" min="6" max="100" value="30" style="width: 100%;">
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #666;">Speed: <span id="sieveSpeed" style="color: #667eea; font-weight: bold;">Medium</span></label>
                        <input type="range" id="sieveSpeedSlider" min="1" max="5" value="3" style="width: 100%;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #999; margin-top: 0.3rem;">
                            <span>Slow</span>
                            <span>Fast</span>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <button onclick="startSieve()" id="sieveStartBtn" style="padding: 0.8rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            ▶ Start
                        </button>
                        <button onclick="pauseSieve()" id="sievePauseBtn" style="padding: 0.8rem; background: #ffc107; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; display: none;">
                            ⏸ Pause
                        </button>
                        <button onclick="resetSieve()" style="padding: 0.8rem; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            ↺ Reset
                        </button>
                        <button onclick="stepSieve()" id="sieveStepBtn" style="padding: 0.8rem; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            ⏭ Step
                        </button>
                    </div>

                    <h3 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem; margin-bottom: 1rem;">Display</h3>
                    
                    <div style="margin-bottom: 0.8rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="sieveShowNumbers" checked style="margin-right: 0.5rem;">
                            <span style="color: #666;">Show Numbers</span>
                        </label>
                    </div>
                    <div style="margin-bottom: 0.8rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="sieveShowExplanation" checked style="margin-right: 0.5rem;">
                            <span style="color: #666;">Show Explanation</span>
                        </label>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="sieveShowStats" checked style="margin-right: 0.5rem;">
                            <span style="color: #666;">Show Statistics</span>
                        </label>
                    </div>

                    <button onclick="exportSieveGIF()" style="width: 100%; padding: 0.7rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 1rem;">
                        📹 Record & Export
                    </button>

                    <!-- Current Status -->
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="color: #667eea; margin-bottom: 0.5rem;">Current Status:</h4>
                        <div id="sieveStatus" style="font-size: 0.9rem; color: #666; line-height: 1.6;"></div>
                    </div>

                    <!-- Algorithm Info -->
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 1rem; border-radius: 8px; font-size: 0.85rem; line-height: 1.6; color: #666;">
                        <div id="sieveAlgoInfo"></div>
                    </div>
                </div>

                <!-- Right Visualization Area -->
                <div>
                    <!-- Main Canvas -->
                    <div style="background: #000; border-radius: 12px; margin-bottom: 1.5rem; position: relative;">
                        <canvas id="sieveCanvas" width="1200" height="800" style="width: 100%; height: auto; display: block; border-radius: 12px;"></canvas>
                    </div>

                    <!-- Explanation Panel -->
                    <div id="sieveExplanationPanel" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
                        <h3 style="color: #667eea; margin-bottom: 1rem;">Step Explanation</h3>
                        <div id="sieveExplanation" style="font-size: 1rem; line-height: 1.8; color: #333;"></div>
                    </div>

                    <!-- Statistics -->
                    <div id="sieveStatsPanel" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 2rem; color: #667eea; font-weight: bold;" id="sieveCountProcessed">0</div>
                            <div style="color: #666; margin-top: 0.5rem;">Numbers Processed</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 2rem; color: #28a745; font-weight: bold;" id="sieveCountKept">0</div>
                            <div style="color: #666; margin-top: 0.5rem;">Kept (Primes/Coprime)</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 2rem; color: #dc3545; font-weight: bold;" id="sieveCountEliminated">0</div>
                            <div style="color: #666; margin-top: 0.5rem;">Eliminated</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 2rem; color: #667eea; font-weight: bold;" id="sieveProgress">0%</div>
                            <div style="color: #666; margin-top: 0.5rem;">Progress</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- COMPARATIVE VISUALIZER TAB -->
    <div id="compare-tab" class="tab-content">
        <div style="max-width: 1800px; margin: 2rem auto; padding: 0 2rem;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h1 style="color: #667eea; font-size: 2.5rem; margin-bottom: 0.5rem;">Comparative Visualizer</h1>
                <p style="color: #666; font-size: 1.2rem; font-style: italic;">
                    Side-by-Side Comparison of Multiple Moduli
                </p>
            </div>

            <!-- Control Panel -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem; border-radius: 12px; margin-bottom: 2rem; color: white;">
                <h3 style="margin-bottom: 1rem;">Select Moduli to Compare (up to 4)</h3>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">M₁</label>
                        <input type="number" id="compareM1" value="30" min="2" max="500" 
                               style="width: 100%; padding: 0.7rem; border-radius: 6px; border: none; font-size: 1rem;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">M₂</label>
                        <input type="number" id="compareM2" value="60" min="2" max="500" 
                               style="width: 100%; padding: 0.7rem; border-radius: 6px; border: none; font-size: 1rem;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">M₃ (Optional)</label>
                        <input type="number" id="compareM3" value="" min="2" max="500" placeholder="Optional"
                               style="width: 100%; padding: 0.7rem; border-radius: 6px; border: none; font-size: 1rem;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">M₄ (Optional)</label>
                        <input type="number" id="compareM4" value="" min="2" max="500" placeholder="Optional"
                               style="width: 100%; padding: 0.7rem; border-radius: 6px; border: none; font-size: 1rem;">
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button onclick="generateComparison()" style="flex: 1; padding: 1rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem;">
                        🔍 Compare
                    </button>
                    <label style="display: flex; align-items: center; cursor: pointer; background: rgba(255,255,255,0.2); padding: 0.7rem 1rem; border-radius: 6px;">
                        <input type="checkbox" id="compareSyncZoom" checked style="margin-right: 0.5rem;">
                        <span>Sync Zoom/Pan</span>
                    </label>
                </div>
            </div>

            <!-- Comparison Grid -->
            <div id="compareGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                <!-- Visualization cards will be generated here -->
            </div>

            <!-- Unified Statistics Table -->
            <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                <h2 style="color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 0.5rem; margin-bottom: 1.5rem;">Comparative Statistics</h2>
                <div id="compareStats" style="overflow-x: auto;"></div>
            </div>

            <!-- Relationship Analysis -->
            <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                <h2 style="color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 0.5rem; margin-bottom: 1.5rem;">Relationship Analysis</h2>
                <div id="compareRelationships" style="font-size: 0.95rem; line-height: 1.8;"></div>
            </div>

            <!-- Export Section -->
            <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); padding: 2rem; border-radius: 12px; text-align: center;">
                <h2 style="color: white; margin-bottom: 1rem;">Export Comparison</h2>
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button onclick="exportComparisonCSV()" style="padding: 1rem 2rem; background: white; color: #28a745; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        📊 Export CSV
                    </button>
                    <button onclick="exportComparisonImages()" style="padding: 1rem 2rem; background: white; color: #28a745; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        🖼️ Export All Images
                    </button>
                    <button onclick="exportComparisonReport()" style="padding: 1rem 2rem; background: white; color: #28a745; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        📄 Full Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- THEORY TAB -->
    <div id="theory-tab" class="tab-content">
        <div class="theory-container">
            <div style="text-align: center; font-size: 2rem; color: #8b7355; margin-bottom: 1rem;">❦</div>
            
            <h1>Modular Reduction Projection</h1>
            
            <p class="subtitle no-indent" style="text-align: center; font-style: italic; font-size: 1.1rem; color: #5c4a3a; margin-bottom: 2rem;">
                A Geometric Visualization of Residue Class Structures in $\mathbb{Z}/M\mathbb{Z}$
            </p>

            <div class="divider">⁂</div>

            <h2>I. Mathematical Foundations</h2>

            <h3>§1. The Ring of Integers Modulo M</h3>

            <div class="definition">
                Let $M \in \mathbb{N}$, $M \geq 2$. The ring of integers modulo $M$ is $\mathbb{Z}/M\mathbb{Z} = \{0, 1, 2, \ldots, M-1\}$ with addition and multiplication modulo $M$.
            </div>

            <p>Each element $r \in \mathbb{Z}/M\mathbb{Z}$ represents an equivalence class of integers congruent to $r$ modulo $M$. The structure of this ring is fundamental to algebraic number theory, cryptography, and Diophantine equations.</p>

            <h3>§2. Euler's Totient Function</h3>

            <div class="definition">
                Euler's totient function $\varphi(M)$ counts integers $r \in \{1, 2, \ldots, M\}$ where $\gcd(r, M) = 1$. These form the group of units $(\mathbb{Z}/M\mathbb{Z})^*$.
            </div>

            <div class="theorem">
                For $M = p_1^{e_1} p_2^{e_2} \cdots p_k^{e_k}$:
                $$\varphi(M) = M \prod_{i=1}^{k} \left(1 - \frac{1}{p_i}\right)$$
            </div>

            <h3>§3. Geometric Representation</h3>

            <p>We map each residue $r \in \{0, 1, \ldots, M-1\}$ to the unit circle via:</p>

            <div class="equation">
                $$z_r = e^{2\pi i r / M}$$
            </div>

            <p class="no-indent"><strong>Important:</strong> This places $r=0$ at angle $0$ (the positive real axis, or 3 o'clock position), and subsequent residues proceed counterclockwise. This matches the standard unit circle convention in mathematics.</p>

            <div class="definition">
                For residue $r$ with $\gcd(r, M) = d$, define $r' = r/d$ and $M' = M/d$. We call $M'$ the <em>reduction channel</em> of $r$.
            </div>

            <h2>II. Key Properties</h2>

            <div class="theorem">
                The number of reduction channels equals $\tau(M)$, the divisor function.
            </div>

            <div class="proposition">
                Coprime residues ($\gcd(r,M)=1$) appear on the outer circle. Non-coprime residues project to inner circles corresponding to their channels $M' \mid M$.
            </div>

            <h3>Prime Constellations</h3>

            <p>The visualization reveals patterns in coprime pairs $(r_1, r_2)$ with fixed gaps $k = r_2 - r_1$:</p>

            <ul class="list-roman">
                <li><strong>Twin Primes</strong> ($k=2$): Adjacent coprime residues</li>
                <li><strong>Cousin Primes</strong> ($k=4$): Gap-4 coprime pairs</li>
                <li><strong>Sexy Primes</strong> ($k=6$): Gap-6 coprime pairs</li>
            </ul>

            <h2>III. The Chinese Remainder Theorem</h2>

            <p>For coprime $m_1, m_2$ with $M = m_1 m_2$, the isomorphism:</p>

            <div class="equation">
                $$\mathbb{Z}/M\mathbb{Z} \cong \mathbb{Z}/m_1\mathbb{Z} \times \mathbb{Z}/m_2\mathbb{Z}$$
            </div>

            <p class="no-indent">manifests geometrically as factorization of the circular structure.</p>

            <h2>IV. Applications</h2>

            <p>This visualization serves multiple purposes in mathematical research and education:</p>

            <ul class="list-roman">
                <li>Visual intuition for abstract algebraic concepts</li>
                <li>Pattern discovery before formal proof</li>
                <li>Connection between number theory and geometry</li>
                <li>Computational experimentation platform</li>
            </ul>

            <blockquote>
                "The purpose of computation is insight, not numbers." — Richard Hamming
            </blockquote>

            <h2>V. Special Cases</h2>

            <div class="proposition">
                For prime $M=p$: All $p-1$ non-zero residues are coprime, yielding a uniform circle.
            </div>

            <p>Primorial numbers $M = 2 \cdot 3 \cdot 5 \cdot 7 \cdots$ exhibit maximal channel richness, while highly composite numbers provide intricate symmetry patterns with numerous divisors.</p>

            <div class="divider">⁂</div>

            <p class="no-indent" style="text-align: center; font-style: italic; margin-top: 2rem;">
                For interactive exploration, return to the Portal tab above.
            </p>
        </div>
    </div>

    <!-- ABOUT TAB -->
    <div id="about-tab" class="tab-content">
        <div class="theory-container">
            <h1>About This Research Tool</h1>

            <div class="divider">⁂</div>

            <h2>Author</h2>

            <p class="no-indent" style="text-align: center; font-size: 1.2rem; margin: 1.5rem 0;">
                <strong>Wessen Getachew</strong><br>
                <a href="https://twitter.com/7dview" target="_blank" style="color: #667eea; text-decoration: none;">@7dview</a>
            </p>

            <p>This Modular Reduction Projection tool represents an expansion of the standalone composite visualization originally featured in the <a href="https://wessengetachew.github.io/Farey/" target="_blank" style="color: #667eea;">Farey Triangle Explorer</a>. All tools in this series employ the fundamental $2\pi r/M$ unit circle method combined with Farey fraction analysis of $r/M$ to reveal deep patterns in number theory.</p>

            <h2>Related Research Tools</h2>

            <p class="no-indent">Explore the complete suite of interactive number theory visualizations:</p>

            <div style="margin: 2rem 0; padding: 1.5rem; background: #faf8f3; border-left: 4px solid #8b7355;">
                <p style="text-indent: 0; margin-bottom: 1rem;">
                    <strong><a href="https://wessengetachew.github.io/Farey/" target="_blank" style="color: #667eea; text-decoration: none;">Farey Triangle & Cayley Transform</a></strong><br>
                    <span style="font-size: 0.9rem; color: #5c4a3a;">Composite visualization suite featuring Farey fractions on the unit circle</span>
                </p>

                <p style="text-indent: 0; margin-bottom: 1rem;">
                    <strong><a href="https://wessengetachew.github.io/GCD/" target="_blank" style="color: #667eea; text-decoration: none;">GCD Farey Circle</a></strong><br>
                    <span style="font-size: 0.9rem; color: #5c4a3a;">Farey sequences mapped to unit circle with GCD analysis</span>
                </p>

                <p style="text-indent: 0; margin-bottom: 1rem;">
                    <strong><a href="https://wessengetachew.github.io/Primes/" target="_blank" style="color: #667eea; text-decoration: none;">Prime Constellation Explorer</a></strong><br>
                    <span style="font-size: 0.9rem; color: #5c4a3a;">Advanced twin/cousin/sexy prime detection up to mod 3000</span>
                </p>

                <p style="text-indent: 0; margin-bottom: 1rem;">
                    <strong><a href="https://wessengetachew.github.io/Ethiopian/" target="_blank" style="color: #667eea; text-decoration: none;">Euler Product Calculator</a></strong><br>
                    <span style="font-size: 0.9rem; color: #5c4a3a;">Computes π and ζ(2) using prime-only relative error methods</span>
                </p>

                <p style="text-indent: 0; margin-bottom: 0;">
                    <strong><a href="https://wessengetachew.github.io/2pir/" target="_blank" style="color: #667eea; text-decoration: none;">Fractional Slice Primality</a></strong><br>
                    <span style="font-size: 0.9rem; color: #5c4a3a;">Unit circle fraction decomposition for primality testing</span>
                </p>
            </div>

            <h2>Overview</h2>

            <p>The Modular Reduction Projection Research Portal is a comprehensive web-based platform for exploring number-theoretic structures through geometric visualization. It combines rigorous mathematical foundations with interactive exploration capabilities.</p>

            <h2>Features</h2>

            <h3>Visualization</h3>
            <ul>
                <li>Real-time SVG rendering with smooth animations</li>
                <li>Touch-optimized controls (pinch zoom, pan)</li>
                <li>6 different color schemes</li>
                <li>Configurable rotation and symmetry display</li>
                <li>Prime residue highlighting</li>
            </ul>

            <h3>Analysis Tools</h3>
            <ul>
                <li>Automatic pattern detection and analysis</li>
                <li>Statistical summaries and comparisons</li>
                <li>Prime constellation identification</li>
                <li>Mathematical theorem reference</li>
            </ul>

            <h3>Export Capabilities</h3>
            <ul>
                <li>High-resolution PNG images (up to 8000×8000px)</li>
                <li>Animated GIF sequences</li>
                <li>CSV and JSON data formats</li>
                <li>LaTeX document generation</li>
                <li>Frame-by-frame export for video creation</li>
            </ul>

            <h2>Mathematical Content</h2>

            <p>This tool implements and visualizes:</p>
            <ul>
                <li>Euler's totient function φ(M)</li>
                <li>Greatest common divisor calculations</li>
                <li>Prime factorization</li>
                <li>Reduction channel decomposition</li>
                <li>Chinese Remainder Theorem structure</li>
                <li>Prime constellation patterns</li>
            </ul>

            <h2>Educational Applications</h2>

            <p>Suitable for:</p>
            <ul>
                <li>Undergraduate number theory courses</li>
                <li>Abstract algebra visualization</li>
                <li>Cryptography foundations</li>
                <li>Mathematical research and exploration</li>
                <li>Computational mathematics demonstrations</li>
            </ul>

            <h2>Technical Details</h2>

            <p class="no-indent"><strong>Browser Requirements:</strong> Modern browser with JavaScript and SVG support</p>
            <p class="no-indent"><strong>Performance:</strong> Optimized for M up to 10,000</p>
            <p class="no-indent"><strong>External Libraries:</strong> GIF.js (animation export), MathJax (equation rendering)</p>

            <h2>Usage Tips</h2>

            <ol>
                <li>Start with small moduli (M < 100) to understand patterns</li>
                <li>Try primorials (30, 210, 2310) for rich structure</li>
                <li>Use prime moduli (17, 101) to see uniform distributions</li>
                <li>Enable animation recording before playback</li>
                <li>Experiment with different color schemes</li>
                <li>Use filters to isolate specific residue properties</li>
            </ol>

            <div class="divider">⁂</div>

            <p class="no-indent" style="text-align: center; font-style: italic;">
                Exploring the intersection of number theory, geometry, and computation<br>
                <span style="font-size: 0.9rem; margin-top: 0.5rem; display: inline-block;">
                    By <strong>Wessen Getachew</strong> • <a href="https://twitter.com/7dview" target="_blank" style="color: #667eea;">@7dview</a>
                </span>
            </p>
        </div>
    </div>

    <script>
        // Tab Switching
        function switchTab(tabName, event) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Activate button - find the button that was clicked
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: find button by onclick attribute
                document.querySelectorAll('.tab-button').forEach(btn => {
                    if (btn.onclick && btn.onclick.toString().includes(tabName)) {
                        btn.classList.add('active');
                    }
                });
            }
            // If switching to portal and not initialized, initialize
            if (tabName === 'portal' && !window.portalInitialized) {
                setupEvents();
                calculate();
                render();
                window.portalInitialized = true;
            }
            
            // If switching to chandelier, initialize if needed
            if (tabName === 'chandelier' && !window.chandelierInitialized) {
                initChandelier();
                window.chandelierInitialized = true;
            }
            
            // If switching to analysis, run default analysis
            if (tabName === 'analysis' && !window.analysisInitialized) {
                runAnalysis();
                window.analysisInitialized = true;
            }
            
            // If switching to sequences, initialize if needed
            if (tabName === 'sequences' && !window.sequencesInitialized) {
                initSequences();
                window.sequencesInitialized = true;
            }
            
            // If switching to sieve, initialize if needed
            if (tabName === 'sieve' && !window.sieveInitialized) {
                initSieve();
                window.sieveInitialized = true;
            }
            
            // If switching to compare, initialize if needed
            if (tabName === 'compare' && !window.compareInitialized) {
                initCompare();
                window.compareInitialized = true;
            }
        }

        // Math utilities
        function gcd(a, b) { while (b) { [a, b] = [b, a % b]; } return a; }
        function phi(n) { let r = n, p = 2; while (p * p <= n) { if (n % p === 0) { while (n % p === 0) n /= p; r -= r / p; } p++; } if (n > 1) r -= r / n; return Math.round(r); }
        function isPrime(n) { if (n < 2) return false; if (n === 2) return true; if (n % 2 === 0) return false; for (let i = 3; i * i <= n; i += 2) if (n % i === 0) return false; return true; }
        function omega(n) { let c = 0, p = 2; while (p * p <= n) { if (n % p === 0) { c++; while (n % p === 0) n /= p; } p++; } if (n > 1) c++; return c; }
        function smallestPrimeFactor(n) { if (n <= 1) return 1; if (n % 2 === 0) return 2; for (let i = 3; i * i <= n; i += 2) if (n % i === 0) return i; return n; }
        function largestPrimeFactor(n) { let l = -1, t = n; while (t % 2 === 0) { l = 2; t /= 2; } for (let i = 3; i * i <= t; i += 2) { while (t % i === 0) { l = i; t /= i; } } if (t > 2) l = t; return l; }
        
        function primeFactorization(n) {
            const f = []; let d = 2;
            while (n > 1) {
                let c = 0;
                while (n % d === 0) { c++; n /= d; }
                if (c > 0) f.push({ p: d, e: c });
                d++; if (d * d > n && n > 1) { f.push({ p: n, e: 1 }); break; }
            }
            return f;
        }
        
        function formatFactorization(f) {
            const sup = '⁰¹²³⁴⁵⁶⁷⁸⁹';
            return f.map(x => x.e === 1 ? x.p : `${x.p}${x.e.toString().split('').map(d => sup[d]).join('')}`).join(' × ');
        }
        
        function getDivisors(n) {
            const d = new Set();
            for (let i = 1; i * i <= n; i++) if (n % i === 0) { d.add(i); d.add(n / i); }
            return Array.from(d).sort((a, b) => a - b);
        }

        function isPerfectSquare(n) {
            const sqrt = Math.floor(Math.sqrt(n));
            return sqrt * sqrt === n;
        }

        function isFibonacci(n) {
            return isPerfectSquare(5 * n * n + 4) || isPerfectSquare(5 * n * n - 4);
        }

        function isPowerOf2(n) {
            return n > 0 && (n & (n - 1)) === 0;
        }

        function isQuadraticResidue(a, p) {
            if (gcd(a, p) !== 1) return false;
            const exp = (p - 1) / 2;
            let result = 1, base = a % p, e = exp;
            while (e > 0) {
                if (e % 2 === 1) result = (result * base) % p;
                base = (base * base) % p;
                e = Math.floor(e / 2);
            }
            return result === 1;
        }

        function getPrimorial(n) {
            const primes = [];
            for (let i = 2; primes.length < n; i++) {
                if (isPrime(i)) primes.push(i);
            }
            return primes.reduce((a, b) => a * b, 1);
        }

        function factorial(n) {
            let result = 1;
            for (let i = 2; i <= n; i++) result *= i;
            return result;
        }

        const highlyCompositeNumbers = [1, 2, 4, 6, 12, 24, 36, 48, 60, 120, 180, 240, 360, 720, 840, 1260, 1680, 2520, 5040];

        // 3D projection helpers
        function project3D(x, y, z, xTilt, yRot, zSpin) {
            // Convert degrees to radians
            const xRad = xTilt * Math.PI / 180;
            const yRad = yRot * Math.PI / 180;
            const zRad = zSpin * Math.PI / 180;
            
            // Apply Z rotation (spin)
            let x1 = x * Math.cos(zRad) - y * Math.sin(zRad);
            let y1 = x * Math.sin(zRad) + y * Math.cos(zRad);
            let z1 = z;
            
            // Apply X rotation (tilt)
            let x2 = x1;
            let y2 = y1 * Math.cos(xRad) - z1 * Math.sin(xRad);
            let z2 = y1 * Math.sin(xRad) + z1 * Math.cos(xRad);
            
            // Apply Y rotation
            let x3 = x2 * Math.cos(yRad) + z2 * Math.sin(yRad);
            let y3 = y2;
            let z3 = -x2 * Math.sin(yRad) + z2 * Math.cos(yRad);
            
            // Perspective projection
            const perspective = 1000;
            const scale = perspective / (perspective + z3);
            
            return {
                x: x3 * scale,
                y: y3 * scale,
                z: z3,
                scale: scale
            };
        }

        function getRingHeight(channelM, totalM, vSpacing) {
            // Outer ring (M) at top (z=0), inner rings below
            const ratio = channelM / totalM;
            return -vSpacing * 500 * (1 - ratio);
        }

        function getRingRotation(channelM) {
            return ringRotations.get(channelM) || 0;
        }

        function getLabelText(point, mode) {
            switch(mode) {
                case 'r':
                    return point.r.toString();
                case 'r/M':
                    return `${point.r}/${point.M}`;
                case 'reduced':
                    return point.gcd === 1 ? `${point.r}/${point.M}` : `${point.rr}/${point.channel}`;
                case 'gcd':
                    return `gcd=${point.gcd}`;
                case 'angle':
                    return Math.round((point.angle * 180 / Math.PI) % 360) + '°';
                case 'angle-rad':
                    return (point.angle / Math.PI).toFixed(3) + 'π';
                case 'coprime':
                    return point.coprime ? '✓' : '✗';
                case 'channel':
                    return `M'=${point.channel}`;
                case 'all':
                    const angleD = Math.round((point.angle * 180 / Math.PI) % 360);
                    return `${point.r}\n${point.r}/${point.M}\ngcd=${point.gcd}\n${angleD}°`;
                default:
                    return point.r.toString();
            }
        }

        function shouldShowLabel(point, index) {
            if (!config.showLabels) return false;
            if (config.labelCoprimesOnly && !point.coprime) return false;
            if (config.labelEvery > 1 && index % config.labelEvery !== 0) return false;
            return shouldShowPoint(point);
        }

        function createLabel(text, x, y, fontSize, background = false) {
            const textEl = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textEl.setAttribute('x', x);
            textEl.setAttribute('y', y);
            textEl.setAttribute('text-anchor', 'middle');
            textEl.setAttribute('dominant-baseline', 'middle');
            textEl.setAttribute('font-size', fontSize);
            textEl.setAttribute('font-family', 'Arial, sans-serif');
            textEl.setAttribute('font-weight', 'bold');
            textEl.setAttribute('pointer-events', 'none');
            
            if (background) {
                textEl.setAttribute('fill', '#000');
                textEl.setAttribute('stroke', '#fff');
                textEl.setAttribute('stroke-width', '3');
                textEl.setAttribute('paint-order', 'stroke');
            } else {
                textEl.setAttribute('fill', '#fff');
                textEl.setAttribute('stroke', '#000');
                textEl.setAttribute('stroke-width', '0.5');
                textEl.setAttribute('paint-order', 'stroke');
            }
            
            // Handle multi-line labels
            if (text.includes('\n')) {
                const lines = text.split('\n');
                const lineHeight = fontSize * 1.1;
                const startY = y - (lines.length - 1) * lineHeight / 2;
                
                lines.forEach((line, i) => {
                    const tspan = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                    tspan.setAttribute('x', x);
                    tspan.setAttribute('y', startY + i * lineHeight);
                    tspan.textContent = line;
                    textEl.appendChild(tspan);
                });
            } else {
                textEl.textContent = text;
            }
            
            return textEl;
        }

        // Multi-modulus functions
        function getMultiModColor(M, index, total) {
            switch(config.multiModColorScheme) {
                case 'rainbow':
                    const hue = (index / total) * 360;
                    return `hsl(${hue}, 80%, 60%)`;
                case 'hue':
                    const h = (index / total) * 300; // 0-300 to avoid red duplication
                    return `hsl(${h}, 70%, 55%)`;
                case 'distinct':
                    const distinctColors = [
                        '#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff',
                        '#ff8000', '#8000ff', '#00ff80', '#ff0080', '#80ff00', '#0080ff'
                    ];
                    return distinctColors[index % distinctColors.length];
                case 'size':
                    const maxM = Math.max(...config.multiModList);
                    const ratio = M / maxM;
                    return `hsl(${240 - ratio * 240}, 80%, 60%)`;
                default:
                    return `hsl(${(index / total) * 360}, 80%, 60%)`;
            }
        }

        function computeModulusData(M) {
            const pts = [];
            for (let r = 0; r < M; r++) {
                const g = gcd(r, M);
                pts.push({
                    r: r,
                    M: M,
                    angle: (2 * Math.PI * r) / M,
                    gcd: g,
                    coprime: g === 1,
                    channel: M / g,
                    rr: r / g
                });
            }
            return pts;
        }

        function applyMultiMod() {
            const mode = document.getElementById('multiModDisplayMode').value;
            let modList = [];

            switch(mode) {
                case 'consecutive':
                    const from = config.multiModFrom;
                    const to = config.multiModTo;
                    for (let m = from; m <= to; m++) {
                        modList.push(m);
                    }
                    break;
                case 'range':
                    const start = parseInt(document.getElementById('rangeStartSlider').value);
                    const end = parseInt(document.getElementById('rangeEndSlider').value);
                    for (let m = start; m <= end; m++) {
                        modList.push(m);
                    }
                    break;
                case 'custom':
                    const customInput = document.getElementById('customModList').value;
                    modList = customInput.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n) && n > 0);
                    break;
            }

            config.multiModList = modList;
            
            // Pre-compute data for all moduli
            multiModData.clear();
            modList.forEach(M => {
                multiModData.set(M, computeModulusData(M));
            });

            renderMultiMod();
        }

        function renderMultiMod() {
            if (!svgGroup) return;
            svgGroup.innerHTML = '';
            
            const baseR = 400;
            const thickness = config.thicknessScale;
            const opacity = config.multiModOpacity;

            config.multiModList.forEach((M, index) => {
                const points = multiModData.get(M) || computeModulusData(M);
                const color = getMultiModColor(M, index, config.multiModList.length);
                const offset = config.multiStackMode ? index * config.stackSpacing : 0;

                // Draw ring
                const ringRadius = baseR * (M / Math.max(...config.multiModList));
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', offset);
                circle.setAttribute('cy', offset);
                circle.setAttribute('r', ringRadius);
                circle.setAttribute('fill', 'none');
                circle.setAttribute('stroke', color);
                circle.setAttribute('stroke-width', 2 * thickness);
                circle.setAttribute('opacity', opacity);
                svgGroup.appendChild(circle);

                // Draw points
                points.forEach(p => {
                    const x = offset + ringRadius * Math.cos(p.angle);
                    const y = offset + ringRadius * Math.sin(p.angle);
                    const pt = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    pt.setAttribute('cx', x);
                    pt.setAttribute('cy', y);
                    pt.setAttribute('r', config.pointSize * thickness);
                    pt.setAttribute('fill', p.coprime ? color : `${color}80`);
                    pt.setAttribute('opacity', p.coprime ? 1 : 0.5);
                    svgGroup.appendChild(pt);
                });

                // Add label for M
                const labelText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                labelText.setAttribute('x', offset + ringRadius + 20);
                labelText.setAttribute('y', offset);
                labelText.setAttribute('fill', color);
                labelText.setAttribute('font-size', '14');
                labelText.setAttribute('font-weight', 'bold');
                labelText.textContent = `M=${M}`;
                svgGroup.appendChild(labelText);
            });
        }

        function shouldShowPoint(p) {
            if (config.filterType === 'none') return true;
            if (config.filterType === 'prime') return isPrime(p.r);
            if (config.filterType === 'square') return isPerfectSquare(p.r);
            if (config.filterType === 'fibonacci') return isFibonacci(p.r);
            if (config.filterType === 'power2') return isPowerOf2(p.r);
            if (config.filterType === 'quadratic') return isQuadraticResidue(p.r, p.M);
            return true;
        }

        // State
        let config = {
            M: 32, zoom: 1, panX: 0, panY: 0, colorScheme: 'type', pointSize: 3,
            opacity: 1, spacingFactor: 1, minRing: 1, showProjections: true,
            showRings: true, showInnerRings: true, colorInner: false, gapHighlight: 'none',
            animSpeed: 500, loop: true, recording: false, rotation: 0, showSymmetry: false,
            highlightPrimes: false, filterType: 'none', thicknessScale: 1.0,
            enable3D: false, xTilt: 0, yRot: 0, zSpin: 0, vSpacing: 0.5,
            animateRings: false, innerToOuterSpeed: 0, outerToInnerSpeed: 0, indivSpeed: 0,
            showLabels: false, labelMode: 'r', innerLabelMode: 'none', labelSize: 12,
            labelDist: 1.15, labelBackground: false, labelCoprimesOnly: false, labelEvery: 1,
            multiModMode: false, multiModList: [32], multiModDisplayMode: 'consecutive',
            multiModFrom: 1, multiModTo: 10, multiModColorScheme: 'rainbow',
            multiModOpacity: 0.7, multiStackMode: false, stackSpacing: 20
        };

        let multiModData = new Map(); // Stores computed data for each modulus

        let ringRotations = new Map(); // Store individual ring rotations
        let ringAnimationFrame = null;

        let points = [], channels = new Map(), innerRings = new Map();
        let gapPairs = { 2: [], 4: [], 6: [], 8: [], 10: [], 12: [] };
        let animInterval = null, recordedFrames = [];
        let isDragging = false, lastPos = { x: 0, y: 0 };
        let svgGroup, tooltip, vizContainer;

        // Color schemes
        const colors = {
            type: p => p.coprime ? '#00ffff' : '#ff1493',
            spf: p => p.coprime ? '#00ffff' : ['#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff'][p.spf % 6],
            lpf: p => p.coprime ? '#00ffff' : ['#f00', '#0f0', '#00f', '#ff0', '#f0f'][p.lpf % 5],
            gcd: p => {
                const pct = p.gcd / config.M;
                const r = Math.round(130 + (255 - 130) * pct);
                const g = Math.round(80 + (20 - 80) * pct);
                const b = Math.round(223 + (147 - 223) * pct);
                return `rgb(${r},${g},${b})`;
            },
            depth: p => `hsl(${(p.channel / config.M) * 360}, 70%, 60%)`,
            rainbow: p => `hsl(${(p.r / p.M) * 360}, 70%, 60%)`
        };

        function getColor(p) {
            return colors[config.colorScheme](p);
        }

        // Calculate
        function calculate() {
            const M = config.M;
            points = [];
            channels.clear();
            innerRings.clear();
            Object.keys(gapPairs).forEach(k => gapPairs[k] = []);

            const coprimes = new Set();
            for (let r = 0; r < M; r++) {
                const g = gcd(r, M);
                const coprime = g === 1;
                const rr = r / g, rm = M / g;
                const angle = (2 * Math.PI * r) / M;  // Now 0° is at 3 o'clock (right side)
                
                if (coprime) coprimes.add(r);

                points.push({
                    r, M, gcd: g, coprime, rr, channel: rm, angle,
                    spf: smallestPrimeFactor(g === 1 ? M : g),
                    lpf: largestPrimeFactor(g === 1 ? M : g)
                });

                if (!channels.has(rm)) channels.set(rm, { M: rm, mult: M / rm, pts: [], count: 0 });
                channels.get(rm).pts.push(r);
                channels.get(rm).count++;
            }

            getDivisors(M).forEach(d => {
                if (d < config.minRing) return;
                const rpts = [];
                for (let r = 0; r < d; r++) {
                    const g = gcd(r, d);
                    rpts.push({
                        r, M: d, gcd: g, coprime: g === 1, channel: d / g,
                        angle: (2 * Math.PI * r) / d,  // Consistent angle mapping
                        spf: smallestPrimeFactor(g === 1 ? d : g),
                        lpf: largestPrimeFactor(g === 1 ? d : g)
                    });
                }
                innerRings.set(d, rpts);
            });

            for (let gap = 2; gap <= 12; gap += 2) {
                const seen = new Set();
                for (let r = 0; r < M; r++) {
                    const r2 = (r + gap) % M;
                    if (coprimes.has(r) && coprimes.has(r2)) {
                        const key = [r, r2].sort((a, b) => a - b).join('-');
                        if (!seen.has(key)) { seen.add(key); gapPairs[gap].push([r, r2]); }
                    }
                }
            }

            updateStats();
        }

        function updateStats() {
            const M = config.M;
            const f = primeFactorization(M);
            const p = phi(M);
            const coprime = points.filter(x => x.coprime).length;
            const reducible = M - coprime;
            const prime = isPrime(M);
            const w = omega(M);
            const formattedFactor = formatFactorization(f);

            document.getElementById('vizTitle').textContent = `Modular Space: M = ${M}`;
            document.getElementById('vizMeta').textContent = `Prime Factorization: ${formattedFactor}`;
            document.getElementById('modVal').textContent = M;
            document.getElementById('modInput').value = M;
            document.getElementById('statM').textContent = M;
            document.getElementById('statPhi').textContent = p;
            document.getElementById('statCoprime').textContent = coprime;
            document.getElementById('statNonCoprime').textContent = reducible;
            document.getElementById('statChannels').textContent = channels.size;
            document.getElementById('statDensity').textContent = (p / M * 100).toFixed(1) + '%';
            document.getElementById('statClass').textContent = prime ? 'Prime' : 'Composite';
            
            const badge = document.getElementById('statBadge');
            badge.textContent = prime ? 'Prime' : `ω(M)=${w}`;
            badge.className = prime ? 'badge badge-prime' : 'badge badge-composite';
            
            document.getElementById('statTwin').textContent = gapPairs[2].length;
            document.getElementById('statCousin').textContent = gapPairs[4].length;
            document.getElementById('statSexy').textContent = gapPairs[6].length;
            document.getElementById('statGap8').textContent = gapPairs[8].length;

            // Update detailed analysis panel
            document.getElementById('detailM').textContent = M;
            document.getElementById('detailFactor').textContent = formattedFactor;
            document.getElementById('detailPhi').textContent = p;
            document.getElementById('detailReducible').textContent = reducible;
            document.getElementById('detailRatio').textContent = ((reducible / M) * 100).toFixed(1) + '%';
            document.getElementById('detailChannels').textContent = channels.size;
            
            // Color scheme name
            const colorNames = {
                'type': 'Coprime vs Non-coprime',
                'spf': 'Smallest Prime Factor',
                'lpf': 'Largest Prime Factor',
                'gcd': 'GCD Value',
                'depth': 'Channel Depth',
                'rainbow': 'Rainbow Spectrum'
            };
            document.getElementById('detailColor').textContent = colorNames[config.colorScheme];
            
            // Display mode
            let displayMode = [];
            if (config.showProjections) displayMode.push('Projection Lines');
            if (config.showRings) displayMode.push('Channel Rings');
            if (config.showInnerRings) displayMode.push('Inner Points');
            document.getElementById('detailMode').textContent = displayMode.join(', ') || 'Basic';
            
            // Analysis section
            document.getElementById('analysisM').textContent = M;
            document.getElementById('analysisFactorization').textContent = formattedFactor;
            document.getElementById('analysisCoprime').textContent = coprime;
            document.getElementById('analysisReducible').textContent = reducible;
            document.getElementById('analysisRatioPercent').textContent = ((reducible / M) * 100).toFixed(1) + '%';
            
            // Channel breakdown
            const channelDiv = document.getElementById('channelBreakdown');
            channelDiv.innerHTML = '';
            
            // Sort channels by M' descending
            const sortedChannels = Array.from(channels.entries())
                .filter(([mp, data]) => mp < M) // Exclude M itself
                .sort((a, b) => b[0] - a[0]);
            
            sortedChannels.forEach(([mp, data]) => {
                const d = M / mp;
                const line = document.createElement('div');
                line.style.marginBottom = '0.4rem';
                line.innerHTML = `<strong>M' = ${mp}:</strong> ${data.count} residues (d = ${d})`;
                channelDiv.appendChild(line);
            });
        }

        // Render
        function render() {
            if (!svgGroup) return;
            
            // Check if multi-modulus mode is enabled
            if (config.multiModMode) {
                renderMultiMod();
                return;
            }
            
            svgGroup.innerHTML = '';
            const baseR = 400;
            const thickness = config.thicknessScale;

            // Apply rotation
            if (config.rotation !== 0) {
                svgGroup.setAttribute('transform', `rotate(${config.rotation})`);
            } else {
                svgGroup.removeAttribute('transform');
            }

            // Symmetry axes
            if (config.showSymmetry) {
                const numAxes = omega(config.M) > 0 ? Math.min(phi(config.M), 12) : 8;
                for (let i = 0; i < numAxes; i++) {
                    const angle = (Math.PI * 2 * i) / numAxes;
                    const x = baseR * 1.1 * Math.cos(angle);
                    const y = baseR * 1.1 * Math.sin(angle);
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', 0);
                    line.setAttribute('y1', 0);
                    line.setAttribute('x2', x);
                    line.setAttribute('y2', y);
                    line.setAttribute('stroke', '#444444');
                    line.setAttribute('stroke-width', 0.5 * thickness);
                    line.setAttribute('opacity', '0.3');
                    line.setAttribute('stroke-dasharray', '5,5');
                    svgGroup.appendChild(line);
                }
            }

            // Gap highlights
            if (config.gapHighlight !== 'none') {
                const gap = parseInt(config.gapHighlight);
                const pairs = gapPairs[gap] || [];
                pairs.forEach(([r1, r2]) => {
                    const p1 = points[r1], p2 = points[r2];
                    if (!shouldShowPoint(p1) || !shouldShowPoint(p2)) return;
                    const x1 = baseR * Math.cos(p1.angle);
                    const y1 = baseR * Math.sin(p1.angle);
                    const x2 = baseR * Math.cos(p2.angle);
                    const y2 = baseR * Math.sin(p2.angle);
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x1);
                    line.setAttribute('y1', y1);
                    line.setAttribute('x2', x2);
                    line.setAttribute('y2', y2);
                    line.setAttribute('stroke', '#ffcc00');
                    line.setAttribute('stroke-width', 2 * thickness);
                    line.setAttribute('opacity', '0.6');
                    svgGroup.appendChild(line);
                });
            }

            // Projection lines
            if (config.showProjections) {
                points.forEach(p => {
                    if (!p.coprime && shouldShowPoint(p)) {
                        const ox = baseR * Math.cos(p.angle);
                        const oy = baseR * Math.sin(p.angle);
                        const cr = baseR * Math.pow(p.channel / config.M, config.spacingFactor);
                        const ta = (2 * Math.PI * p.rr) / p.channel;
                        const ix = cr * Math.cos(ta);
                        const iy = cr * Math.sin(ta);
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', ox);
                        line.setAttribute('y1', oy);
                        line.setAttribute('x2', ix);
                        line.setAttribute('y2', iy);
                        line.setAttribute('stroke', '#ff1493');
                        line.setAttribute('stroke-width', 0.5 * thickness);
                        line.setAttribute('opacity', config.opacity);
                        svgGroup.appendChild(line);
                    }
                });
            }

            // Rings
            if (config.showRings) {
                getDivisors(config.M).filter(d => channels.has(d) && d >= config.minRing).forEach(d => {
                    const r = baseR * Math.pow(d / config.M, config.spacingFactor);
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', 0);
                    circle.setAttribute('cy', 0);
                    circle.setAttribute('r', r);
                    circle.setAttribute('fill', 'none');
                    circle.setAttribute('stroke', '#ffd700');
                    circle.setAttribute('stroke-width', 1 * thickness);
                    svgGroup.appendChild(circle);
                });
            }

            // Inner points
            if (config.showInnerRings) {
                getDivisors(config.M).forEach(d => {
                    if (d === config.M || d < config.minRing) return;
                    const rpts = innerRings.get(d);
                    if (!rpts) return;
                    const r = baseR * Math.pow(d / config.M, config.spacingFactor);
                    rpts.forEach((p, index) => {
                        if (!p.coprime && !config.colorInner) return;
                        if (!shouldShowPoint(p)) return;
                        const x = r * Math.cos(p.angle);
                        const y = r * Math.sin(p.angle);
                        const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        c.setAttribute('cx', x);
                        c.setAttribute('cy', y);
                        c.setAttribute('r', config.pointSize * 0.7 * thickness);
                        c.setAttribute('fill', config.colorInner ? getColor(p) : '#ffd700');
                        svgGroup.appendChild(c);
                        
                        // Add label for inner ring points
                        if (config.innerLabelMode !== 'none' && (index % config.labelEvery === 0)) {
                            const labelMode = config.innerLabelMode === 'same' ? config.labelMode : config.innerLabelMode;
                            const labelText = getLabelText(p, labelMode);
                            const labelDist = config.labelDist * 0.9; // Slightly closer for inner rings
                            const labelX = x * labelDist;
                            const labelY = y * labelDist;
                            const labelSize = config.labelSize * 0.8; // Smaller for inner rings
                            const label = createLabel(labelText, labelX, labelY, labelSize, config.labelBackground);
                            svgGroup.appendChild(label);
                        }
                    });
                });
            }

            // Outer points
            points.forEach((p, index) => {
                if (!shouldShowPoint(p)) return;
                const x = baseR * Math.cos(p.angle);
                const y = baseR * Math.sin(p.angle);
                const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                c.setAttribute('cx', x);
                c.setAttribute('cy', y);
                c.setAttribute('r', config.pointSize * thickness);
                
                // Highlight primes
                let color = getColor(p);
                if (config.highlightPrimes && isPrime(p.r) && p.coprime) {
                    color = '#ffff00';
                    c.setAttribute('r', config.pointSize * 1.3 * thickness);
                }
                
                c.setAttribute('fill', color);
                c.setAttribute('data-r', p.r);
                c.style.cursor = 'pointer';
                svgGroup.appendChild(c);
                
                // Add label
                if (shouldShowLabel(p, index)) {
                    const labelText = getLabelText(p, config.labelMode);
                    const labelX = x * config.labelDist;
                    const labelY = y * config.labelDist;
                    const label = createLabel(labelText, labelX, labelY, config.labelSize, config.labelBackground);
                    svgGroup.appendChild(label);
                }
            });
        }

        // Animation
        function startAnimation() {
            if (animInterval) return;
            animInterval = setInterval(() => {
                let next = config.M + 1;
                if (next > 5000) next = config.loop ? 2 : (stopAnimation(), config.M);
                setM(next);
                if (config.recording) recordedFrames.push({ M: config.M, svg: svgGroup.innerHTML });
            }, config.animSpeed);
            document.getElementById('playBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            if (config.recording) document.getElementById('recordingBadge').classList.add('active');
        }

        function stopAnimation() {
            if (!animInterval) return;
            clearInterval(animInterval);
            animInterval = null;
            document.getElementById('playBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('recordingBadge').classList.remove('active');
        }

        function resetView() {
            config.zoom = 1;
            config.panX = 0;
            config.panY = 0;
            document.getElementById('zoomSlider').value = 100;
            document.getElementById('zoomVal').textContent = '1.00';
            updateViewBox();
        }

        function updateViewBox() {
            const svg = document.getElementById('vizSVG');
            const s = 500 / config.zoom;
            svg.setAttribute('viewBox', `${-s + config.panX} ${-s + config.panY} ${s * 2} ${s * 2}`);
        }

        function setM(m) {
            config.M = m;
            document.getElementById('modSlider').value = Math.min(m, 5000);
            calculate();
            render();
        }

        // Analysis Functions (condensed for space)
        function analyzePattern() {
            const M = config.M;
            const phiM = phi(M);
            let report = `<h4 style="color: #667eea; margin-bottom: 0.5rem;">Pattern Analysis for M = ${M}</h4>`;
            report += `<p><strong>φ(M):</strong> ${phiM}</p>`;
            report += `<p><strong>Density:</strong> ${(phiM/M*100).toFixed(2)}%</p>`;
            report += `<p><strong>Channels:</strong> ${channels.size}</p>`;
            document.getElementById('analysisResults').innerHTML = report;
            document.getElementById('analysisResults').style.display = 'block';
        }

        function compareModuli() {
            const current = config.M;
            const candidates = [current - 1, current + 1, current * 2, Math.floor(current / 2)].filter(m => m >= 2 && m <= 10000);
            let report = `<h4 style="color: #667eea;">Comparative Analysis</h4><table style="width:100%; font-size:0.85em;"><tr style="background:#667eea;color:white;"><th>M</th><th>φ(M)</th></tr>`;
            candidates.forEach(m => {
                const p = phi(m);
                report += `<tr style="${m===current?'background:#ffffcc;':''}cursor:pointer;" onclick="setM(${m})"><td>${m}</td><td>${p}</td></tr>`;
            });
            report += `</table>`;
            document.getElementById('analysisResults').innerHTML = report;
            document.getElementById('analysisResults').style.display = 'block';
        }

        function findInteresting() {
            const interestingNumbers = [
                { m: 30, type: "Primorial", desc: "2×3×5 - First 3 primes" },
                { m: 210, type: "Primorial", desc: "2×3×5×7 - First 4 primes" },
                { m: 2310, type: "Primorial", desc: "2×3×5×7×11 - First 5 primes" },
                { m: 1024, type: "Power of 2", desc: "2¹⁰" },
                { m: 4096, type: "Power of 2", desc: "2¹²" },
                { m: 60, type: "Highly Composite", desc: "12 divisors" },
                { m: 120, type: "Highly Composite", desc: "16 divisors" },
                { m: 360, type: "Highly Composite", desc: "24 divisors" },
                { m: 840, type: "Highly Composite", desc: "32 divisors" },
                { m: 2520, type: "Highly Composite", desc: "48 divisors - LCM(1..10)" },
                { m: 5040, type: "Highly Composite", desc: "60 divisors - 7!" },
                { m: 128, type: "Power of 2", desc: "2⁷" },
                { m: 256, type: "Power of 2", desc: "2⁸" },
                { m: 512, type: "Power of 2", desc: "2⁹" },
                { m: 64, type: "Power of 2", desc: "2⁶" },
                { m: 12, type: "Small Composite", desc: "2²×3 - Rich structure" },
                { m: 24, type: "Small Composite", desc: "2³×3" },
                { m: 36, type: "Small Composite", desc: "2²×3²" },
                { m: 48, type: "Small Composite", desc: "2⁴×3" },
                { m: 72, type: "Small Composite", desc: "2³×3²" },
                { m: 144, type: "Small Composite", desc: "2⁴×3² - 12²" },
                { m: 180, type: "Highly Composite", desc: "2²×3²×5" },
                { m: 420, type: "Abundant", desc: "2²×3×5×7" },
                { m: 1680, type: "Highly Composite", desc: "2⁴×3×5×7" }
            ];
            
            // Shuffle and pick 6 random numbers
            const shuffled = interestingNumbers.sort(() => Math.random() - 0.5).slice(0, 6);
            
            let report = `<h4 style="color:#667eea; margin-bottom: 1rem;">Interesting Moduli</h4>`;
            report += `<p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">Click any number to visualize it:</p>`;
            
            shuffled.forEach(({m, type, desc}) => {
                report += `<div style="padding: 0.8rem; margin: 0.6rem 0; background: #f8f9fa; border-left: 4px solid #667eea; border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-size: 1.1rem; font-weight: bold; color: #667eea; margin-bottom: 0.3rem;">M = ${m}</div>
                            <div style="font-size: 0.85rem; color: #888; margin-bottom: 0.2rem;">${type}</div>
                            <div style="font-size: 0.8rem; color: #666;">${desc}</div>
                        </div>
                        <button onclick="setM(${m}); document.getElementById('analysisResults').style.display='none';" 
                                style="padding: 0.6rem 1.2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                       color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; 
                                       font-weight: 600; white-space: nowrap; margin-left: 1rem;">
                            Visualize
                        </button>
                    </div>
                </div>`;
            });
            
            report += `<button onclick="findInteresting()" 
                              style="width: 100%; margin-top: 1rem; padding: 0.8rem; background: #28a745; 
                                     color: white; border: none; border-radius: 6px; cursor: pointer; 
                                     font-size: 0.95rem; font-weight: 600;">
                        Show Different Numbers
                    </button>`;
            
            document.getElementById('analysisResults').innerHTML = report;
            document.getElementById('analysisResults').style.display = 'block';
        }

        function showTheorems() {
            let report = `<h4 style="color:#667eea;">Mathematical Theorems</h4>`;
            report += `<p style="margin:0.5rem 0;"><strong>Euler's Theorem:</strong> If gcd(a,M)=1, then a<sup>φ(M)</sup> ≡ 1 (mod M)</p>`;
            report += `<p style="margin:0.5rem 0;"><strong>Chinese Remainder:</strong> ℤ/(m₁m₂)ℤ ≅ ℤ/m₁ℤ × ℤ/m₂ℤ</p>`;
            document.getElementById('analysisResults').innerHTML = report;
            document.getElementById('analysisResults').style.display = 'block';
        }

        function generatePrimorial() {
            const n = parseInt(prompt("Generate Primorial(n) - Product of first n primes\n\nExamples:\n• n=3 → 2×3×5 = 30\n• n=4 → 2×3×5×7 = 210\n• n=5 → 2×3×5×7×11 = 2310\n\nThese have rich Farey channel structure.\n\nEnter n (1-8):", "4"));
            if (n && n >= 1 && n <= 8) {
                const result = getPrimorial(n);
                setM(result);
                alert(`Primorial(${n}) = ${result}\n\nThis is the product of the first ${n} prime numbers.`);
            }
        }

        function generateFactorial() {
            const n = parseInt(prompt("Generate n! - Factorial\n\nExamples:\n• 4! = 24\n• 5! = 120\n• 6! = 720\n• 7! = 5040\n\nFactorials contain all divisors up to n.\n\nEnter n (2-7):", "5"));
            if (n && n >= 2 && n <= 7) {
                const result = factorial(n);
                setM(result);
                alert(`${n}! = ${result}\n\nThis number is divisible by all integers from 1 to ${n}.`);
            }
        }

        function generateHighlyComposite() {
            const available = highlyCompositeNumbers.filter(x => x <= 10000);
            const list = available.join(', ');
            const message = `Highly Composite Numbers\n\nThese have more divisors than any smaller number.\n\nAvailable values (≤10000):\n${list}\n\nEnter a number from the list:`;
            const input = parseInt(prompt(message, "2520"));
            if (input && available.includes(input)) {
                setM(input);
                const divCount = getDivisors(input).length;
                alert(`M = ${input}\n\nThis highly composite number has ${divCount} divisors.`);
            } else if (input) {
                alert("Please choose a number from the list of highly composite numbers.");
            }
        }

        function exportPNG() {
            const res = parseInt(document.getElementById('exportRes').value);
            const titleHeight = res * 0.08;
            const vizWidth = res * 0.65;
            const legendWidth = res * 0.35;
            const vizHeight = res - titleHeight;
            
            const canvas = document.createElement('canvas');
            canvas.width = res;
            canvas.height = res;
            const ctx = canvas.getContext('2d');
            
            // Background
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, res, res);
            
            // Title bar
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, res, titleHeight);
            
            ctx.font = `bold ${titleHeight * 0.35}px Arial`;
            ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('Modular Reduction Projection', res / 2, titleHeight * 0.35);
            
            ctx.font = `bold ${titleHeight * 0.30}px Arial`;
            ctx.fillStyle = '#ffd700';
            ctx.fillText(`M = ${config.M}`, res / 2, titleHeight * 0.75);
            
            const factors = primeFactorization(config.M);
            ctx.font = `${titleHeight * 0.18}px Arial`;
            ctx.fillStyle = '#aaaaaa';
            ctx.fillText(formatFactorization(factors), res / 2, titleHeight * 0.95);
            
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, titleHeight);
            ctx.lineTo(res, titleHeight);
            ctx.stroke();
            
            // Visualization
            const vizCanvas = document.createElement('canvas');
            vizCanvas.width = vizWidth;
            vizCanvas.height = vizHeight;
            const vizCtx = vizCanvas.getContext('2d');
            
            vizCtx.fillStyle = '#000000';
            vizCtx.fillRect(0, 0, vizWidth, vizHeight);
            
            const svgData = new XMLSerializer().serializeToString(document.getElementById('vizSVG'));
            const img = new Image();
            const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            img.onload = () => {
                const vizSize = Math.min(vizWidth, vizHeight);
                const offsetX = (vizWidth - vizSize) / 2;
                const offsetY = (vizHeight - vizSize) / 2;
                vizCtx.drawImage(img, offsetX, offsetY, vizSize, vizSize);
                URL.revokeObjectURL(url);
                
                ctx.drawImage(vizCanvas, 0, titleHeight);
                
                // Legend panel
                const lx = vizWidth;
                const ly = titleHeight;
                
                ctx.fillStyle = '#000000';
                ctx.fillRect(lx, ly, legendWidth, vizHeight);
                
                ctx.strokeStyle = '#333333';
                ctx.lineWidth = 2;
                ctx.strokeRect(lx, ly, legendWidth, vizHeight);
                
                let yPos = ly + res * 0.025;
                const leftMargin = lx + res * 0.015;
                const fontSize = res * 0.010;
                const lineHeight = res * 0.016;
                
                ctx.textAlign = 'left';
                
                // Configuration section
                ctx.font = `bold ${fontSize * 1.4}px Arial`;
                ctx.fillStyle = '#00ffff';
                ctx.fillText('Configuration', leftMargin, yPos);
                yPos += lineHeight * 1.8;
                
                ctx.font = `bold ${fontSize * 1.1}px Arial`;
                ctx.fillStyle = '#00ffff';
                ctx.fillText(`Modulus M = ${config.M}`, leftMargin, yPos);
                yPos += lineHeight * 1.2;
                
                ctx.font = `${fontSize * 0.9}px Arial`;
                ctx.fillStyle = '#cccccc';
                ctx.fillText(`Prime Factorization: ${formatFactorization(factors)}`, leftMargin, yPos);
                yPos += lineHeight * 0.95;
                
                const colorNames = {
                    'type': 'Coprime vs Non-coprime',
                    'spf': 'Smallest Prime Factor',
                    'lpf': 'Largest Prime Factor',
                    'gcd': 'GCD Value',
                    'depth': 'Channel Depth',
                    'rainbow': 'Rainbow Spectrum'
                };
                ctx.fillText(`Color: ${colorNames[config.colorScheme]}`, leftMargin, yPos);
                yPos += lineHeight * 1.8;
                
                // Statistics section
                ctx.font = `bold ${fontSize * 1.4}px Arial`;
                ctx.fillStyle = '#00ffff';
                ctx.fillText('Statistics', leftMargin, yPos);
                yPos += lineHeight * 1.8;
                
                const M = config.M;
                const phiM = phi(M);
                const coprime = points.filter(x => x.coprime).length;
                const reducible = M - coprime;
                const ratio = ((reducible / M) * 100).toFixed(1);
                
                // Stats grid
                const statBoxWidth = legendWidth * 0.45;
                const statBoxHeight = res * 0.045;
                const statGap = res * 0.01;
                
                // Row 1: φ(M) and Reducible
                ctx.fillStyle = '#0a0a0a';
                ctx.fillRect(leftMargin, yPos, statBoxWidth, statBoxHeight);
                ctx.strokeStyle = '#00ffff';
                ctx.lineWidth = 2;
                ctx.strokeRect(leftMargin, yPos, statBoxWidth, statBoxHeight);
                
                ctx.font = `${fontSize * 0.75}px Arial`;
                ctx.fillStyle = '#aaaaaa';
                ctx.fillText('φ(M)', leftMargin + res * 0.005, yPos + statBoxHeight * 0.35);
                ctx.font = `bold ${fontSize * 1.5}px Arial`;
                ctx.fillStyle = '#00ffff';
                ctx.fillText(phiM, leftMargin + res * 0.005, yPos + statBoxHeight * 0.75);
                
                const col2X = leftMargin + statBoxWidth + statGap;
                ctx.fillStyle = '#0a0a0a';
                ctx.fillRect(col2X, yPos, statBoxWidth, statBoxHeight);
                ctx.strokeStyle = '#ff1493';
                ctx.strokeRect(col2X, yPos, statBoxWidth, statBoxHeight);
                
                ctx.font = `${fontSize * 0.75}px Arial`;
                ctx.fillStyle = '#aaaaaa';
                ctx.fillText('Reducible Residues', col2X + res * 0.005, yPos + statBoxHeight * 0.35);
                ctx.font = `bold ${fontSize * 1.5}px Arial`;
                ctx.fillStyle = '#ff1493';
                ctx.fillText(reducible, col2X + res * 0.005, yPos + statBoxHeight * 0.75);
                
                yPos += statBoxHeight + statGap;
                
                // Row 2: Ratio and Channels
                ctx.fillStyle = '#0a0a0a';
                ctx.fillRect(leftMargin, yPos, statBoxWidth, statBoxHeight);
                ctx.strokeStyle = '#ffd700';
                ctx.strokeRect(leftMargin, yPos, statBoxWidth, statBoxHeight);
                
                ctx.font = `${fontSize * 0.75}px Arial`;
                ctx.fillStyle = '#aaaaaa';
                ctx.fillText('Reducibility Ratio', leftMargin + res * 0.005, yPos + statBoxHeight * 0.35);
                ctx.font = `bold ${fontSize * 1.5}px Arial`;
                ctx.fillStyle = '#ffd700';
                ctx.fillText(`${ratio}%`, leftMargin + res * 0.005, yPos + statBoxHeight * 0.75);
                
                ctx.fillStyle = '#0a0a0a';
                ctx.fillRect(col2X, yPos, statBoxWidth, statBoxHeight);
                ctx.strokeStyle = '#ffd700';
                ctx.strokeRect(col2X, yPos, statBoxWidth, statBoxHeight);
                
                ctx.font = `${fontSize * 0.75}px Arial`;
                ctx.fillStyle = '#aaaaaa';
                ctx.fillText('Farey Channels', col2X + res * 0.005, yPos + statBoxHeight * 0.35);
                ctx.font = `bold ${fontSize * 1.5}px Arial`;
                ctx.fillStyle = '#ffd700';
                ctx.fillText(channels.size, col2X + res * 0.005, yPos + statBoxHeight * 0.75);
                
                yPos += statBoxHeight + lineHeight * 2;
                
                // Color Key section
                ctx.font = `bold ${fontSize * 1.4}px Arial`;
                ctx.fillStyle = '#00ffff';
                ctx.fillText('Color Key', leftMargin, yPos);
                yPos += lineHeight * 1.6;
                
                ctx.font = `${fontSize * 0.9}px Arial`;
                const colorBoxSize = res * 0.012;
                
                // Cyan
                ctx.fillStyle = '#00ffff';
                ctx.fillRect(leftMargin, yPos - colorBoxSize * 0.5, colorBoxSize, colorBoxSize);
                ctx.fillStyle = '#cccccc';
                ctx.fillText('Cyan = Irreducible (gcd=1)', leftMargin + colorBoxSize * 1.5, yPos);
                yPos += lineHeight * 1.1;
                
                // Red
                ctx.fillStyle = '#ff1493';
                ctx.fillRect(leftMargin, yPos - colorBoxSize * 0.5, colorBoxSize, colorBoxSize);
                ctx.fillStyle = '#cccccc';
                ctx.fillText('Red = Reducible (gcd>1)', leftMargin + colorBoxSize * 1.5, yPos);
                yPos += lineHeight * 1.1;
                
                // Gold
                ctx.fillStyle = '#ffd700';
                ctx.fillRect(leftMargin, yPos - colorBoxSize * 0.5, colorBoxSize, colorBoxSize);
                ctx.fillStyle = '#cccccc';
                ctx.fillText('Gold = Farey Channels', leftMargin + colorBoxSize * 1.5, yPos);
                yPos += lineHeight * 1.1;
                
                // White
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(leftMargin, yPos - colorBoxSize * 0.5, colorBoxSize, colorBoxSize);
                ctx.fillStyle = '#cccccc';
                ctx.fillText('White = Outer ring (M)', leftMargin + colorBoxSize * 1.5, yPos);
                yPos += lineHeight * 2;
                
                // Analysis section
                ctx.font = `bold ${fontSize * 1.4}px Arial`;
                ctx.fillStyle = '#00ffff';
                ctx.fillText('Analysis', leftMargin, yPos);
                yPos += lineHeight * 1.6;
                
                ctx.font = `${fontSize * 0.85}px Arial`;
                ctx.fillStyle = '#cccccc';
                ctx.fillText(`Coprime: ${coprime} residues (φ(M))`, leftMargin, yPos);
                yPos += lineHeight * 0.9;
                ctx.fillText(`Reducible: ${reducible} residues`, leftMargin, yPos);
                yPos += lineHeight * 0.9;
                ctx.fillText(`Ratio: ${ratio}% reducible`, leftMargin, yPos);
                yPos += lineHeight * 1.6;
                
                // Channel breakdown
                ctx.font = `bold ${fontSize * 1.1}px Arial`;
                ctx.fillStyle = '#00ffff';
                ctx.fillText('Farey Channels:', leftMargin, yPos);
                yPos += lineHeight * 1.2;
                
                ctx.font = `${fontSize * 0.8}px Arial`;
                ctx.fillStyle = '#cccccc';
                
                const sortedChannels = Array.from(channels.entries())
                    .filter(([mp, data]) => mp < M)
                    .sort((a, b) => b[0] - a[0])
                    .slice(0, 10); // Limit to top 10 for space
                
                sortedChannels.forEach(([mp, data]) => {
                    const d = M / mp;
                    ctx.fillText(`M' = ${mp}: ${data.count} residues (d = ${d})`, leftMargin, yPos);
                    yPos += lineHeight * 0.85;
                });
                
                // Footer
                yPos = ly + vizHeight - lineHeight * 3;
                ctx.font = `bold ${fontSize * 0.9}px Arial`;
                ctx.fillStyle = '#ffd700';
                ctx.fillText('By Wessen Getachew', leftMargin, yPos);
                yPos += lineHeight * 1.1;
                ctx.font = `${fontSize * 0.8}px Arial`;
                ctx.fillStyle = '#888888';
                ctx.fillText('@7dview', leftMargin, yPos);
                
                canvas.toBlob(blob => {
                    const a = document.createElement('a');
                    a.download = `modular-M${config.M}-${res}px.png`;
                    a.href = URL.createObjectURL(blob);
                    a.click();
                });
            };
            img.src = url;
        }

        function exportCSV() {
            let csv = `Residue,Modulus,GCD,Status,Channel\n`;
            points.forEach(p => csv += `${p.r},${p.M},${p.gcd},${p.coprime?'Coprime':'Non-coprime'},${p.channel}\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.download = `modular-M${config.M}.csv`;
            a.href = URL.createObjectURL(blob);
            a.click();
        }

        function exportJSON() {
            const data = {
                M: config.M,
                phi: phi(config.M),
                points: points.map(p => ({ r: p.r, gcd: p.gcd, coprime: p.coprime, channel: p.channel }))
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.download = `modular-M${config.M}.json`;
            a.href = URL.createObjectURL(blob);
            a.click();
        }

        function exportFrames() {
            if (recordedFrames.length === 0) return alert('No frames recorded');
            alert(`Exporting ${recordedFrames.length} frames...`);
            recordedFrames.forEach((frame, i) => {
                setTimeout(() => {
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = 2000;
                    tempCanvas.height = 2000;
                    const ctx = tempCanvas.getContext('2d');
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, 2000, 2000);
                    const svgStr = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="-500 -500 1000 1000" width="2000" height="2000"><rect x="-500" y="-500" width="1000" height="1000" fill="#000"/>${frame.svg}</svg>`;
                    const img = new Image();
                    const blob = new Blob([svgStr], { type: 'image/svg+xml;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, 2000, 2000);
                        URL.revokeObjectURL(url);
                        tempCanvas.toBlob(b => {
                            const a = document.createElement('a');
                            a.download = `frame_${String(i).padStart(4,'0')}_M${frame.M}.png`;
                            a.href = URL.createObjectURL(b);
                            a.click();
                        });
                    };
                    img.src = url;
                }, i * 100);
            });
        }

        async function exportAnimationZIP() {
            if (recordedFrames.length === 0) {
                alert('No frames recorded. Please:\n1. Enable "Record Frames" checkbox\n2. Click Play to record animation\n3. Click Stop when done\n4. Then export ZIP');
                return;
            }
            
            const frameCount = recordedFrames.length;
            
            // Show progress
            const progressDiv = document.getElementById('gifProgress');
            const progressText = document.getElementById('gifProgressText');
            const progressFill = document.getElementById('gifProgressFill');
            progressDiv.classList.add('active');
            progressText.textContent = 'Creating PNG frames...';
            progressFill.style.width = '0%';
            
            const zip = new JSZip();
            const folder = zip.folder('animation-frames');
            
            // Process each frame
            for (let i = 0; i < frameCount; i++) {
                const frame = recordedFrames[i];
                
                // Create canvas for this frame
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 1000;
                tempCanvas.height = 1000;
                const ctx = tempCanvas.getContext('2d');
                
                // Black background
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, 1000, 1000);
                
                // Create SVG image
                const svgStr = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="-500 -500 1000 1000" width="1000" height="1000">
                    <rect x="-500" y="-500" width="1000" height="1000" fill="#000"/>
                    ${frame.svg}
                </svg>`;
                
                // Convert to PNG
                await new Promise((resolve) => {
                    const img = new Image();
                    const blob = new Blob([svgStr], { type: 'image/svg+xml;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, 1000, 1000);
                        URL.revokeObjectURL(url);
                        
                        // Add M value overlay
                        ctx.font = 'bold 32px Arial';
                        ctx.fillStyle = '#fff';
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 5;
                        const text = `M = ${frame.M}`;
                        ctx.strokeText(text, 20, 45);
                        ctx.fillText(text, 20, 45);
                        
                        // Convert to blob and add to ZIP
                        tempCanvas.toBlob((blob) => {
                            const paddedIndex = String(i + 1).padStart(4, '0');
                            folder.file(`frame_${paddedIndex}_M${frame.M}.png`, blob);
                            
                            const progress = ((i + 1) / frameCount) * 100;
                            progressFill.style.width = progress + '%';
                            progressText.textContent = `Processing frame ${i + 1}/${frameCount}`;
                            
                            resolve();
                        }, 'image/png');
                    };
                    
                    img.src = url;
                });
            }
            
            // Generate ZIP
            progressText.textContent = 'Creating ZIP file...';
            progressFill.style.width = '100%';
            
            zip.generateAsync({ type: 'blob' }).then((content) => {
                // Download
                const link = document.createElement('a');
                link.download = `modular-animation-${frameCount}-frames.zip`;
                link.href = URL.createObjectURL(content);
                link.click();
                
                // Hide progress
                setTimeout(() => {
                    progressDiv.classList.remove('active');
                }, 1000);
            });
        }

        function exportGIF() {
            if (recordedFrames.length === 0) {
                alert('No frames recorded. Please:\n1. Enable "Record Frames" checkbox\n2. Click Play to record animation\n3. Click Stop when done\n4. Then export GIF');
                return;
            }
            
            const frameCount = recordedFrames.length;
            
            // Show progress indicator
            const progressDiv = document.getElementById('gifProgress');
            const progressText = document.getElementById('gifProgressText');
            const progressFill = document.getElementById('gifProgressFill');
            progressDiv.classList.add('active');
            progressText.textContent = 'Processing frames...';
            progressFill.style.width = '0%';
            
            const gif = new GIF({
                workers: 2,
                quality: 10,
                width: 800,
                height: 800,
                workerScript: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js'
            });
            
            let processedCount = 0;
            const totalFrames = recordedFrames.length;
            
            // Process frames sequentially to ensure proper ordering
            const processFrame = (index) => {
                if (index >= totalFrames) {
                    // All frames added, now render
                    progressText.textContent = 'Encoding GIF...';
                    progressFill.style.width = '50%';
                    console.log('All frames added, rendering GIF...');
                    gif.render();
                    return;
                }
                
                const frame = recordedFrames[index];
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 800;
                tempCanvas.height = 800;
                const ctx = tempCanvas.getContext('2d');
                
                // Black background
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, 800, 800);
                
                // Create SVG image
                const svgStr = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="-500 -500 1000 1000" width="800" height="800">
                    <rect x="-500" y="-500" width="1000" height="1000" fill="#000"/>
                    ${frame.svg}
                </svg>`;
                
                const img = new Image();
                const blob = new Blob([svgStr], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, 800, 800);
                    URL.revokeObjectURL(url);
                    
                    // Add M value overlay
                    ctx.font = 'bold 24px Arial';
                    ctx.fillStyle = '#fff';
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 4;
                    const text = `M = ${frame.M}`;
                    ctx.strokeText(text, 15, 35);
                    ctx.fillText(text, 15, 35);
                    
                    // Add frame to GIF
                    gif.addFrame(tempCanvas, { delay: config.animSpeed, copy: true });
                    
                    processedCount++;
                    const progress = (processedCount / totalFrames) * 50; // 0-50% for frame processing
                    progressFill.style.width = progress + '%';
                    progressText.textContent = `Processing frame ${processedCount}/${totalFrames}`;
                    console.log(`Processed frame ${processedCount}/${totalFrames}`);
                    
                    // Process next frame
                    setTimeout(() => processFrame(index + 1), 10);
                };
                
                img.onerror = () => {
                    console.error(`Error loading frame ${index}`);
                    URL.revokeObjectURL(url);
                    // Skip this frame and continue
                    processFrame(index + 1);
                };
                
                img.src = url;
            };
            
            // Set up finish handler before starting
            gif.on('finished', (gifBlob) => {
                console.log('GIF rendering complete');
                progressFill.style.width = '100%';
                progressText.textContent = 'Download starting...';
                
                const a = document.createElement('a');
                a.download = `modular-animation-M${recordedFrames[0].M}-to-M${recordedFrames[recordedFrames.length-1].M}.gif`;
                a.href = URL.createObjectURL(gifBlob);
                a.click();
                
                // Hide progress after short delay
                setTimeout(() => {
                    progressDiv.classList.remove('active');
                    alert(`GIF created successfully!\n\n${frameCount} frames\nFile: ${a.download}`);
                }, 1000);
            });
            
            gif.on('progress', (progress) => {
                const encodingProgress = 50 + (progress * 50); // 50-100% for encoding
                progressFill.style.width = encodingProgress + '%';
                progressText.textContent = `Encoding GIF... ${(progress * 100).toFixed(0)}%`;
                console.log(`GIF encoding progress: ${(progress * 100).toFixed(1)}%`);
            });
            
            // Start processing frames
            processFrame(0);
        }

        function exportLaTeX() {
            const M = config.M;
            const factors = primeFactorization(M);
            const phiM = phi(M);
            let latex = `\\documentclass{article}\n\\usepackage{amsmath}\n\\begin{document}\n\\section*{Modular Reduction: $M = ${M}$}\n$$M = ${factors.map(f => f.e===1?`${f.p}`:`${f.p}^{${f.e}}`).join(' \\cdot ')}$$\n$$\\varphi(${M}) = ${phiM}$$\n\\end{document}`;
            const blob = new Blob([latex], { type: 'text/plain' });
            const a = document.createElement('a');
            a.download = `modular-M${M}.tex`;
            a.href = URL.createObjectURL(blob);
            a.click();
        }

        // Events
        function setupEvents() {
            svgGroup = document.getElementById('vizGroup');
            tooltip = document.getElementById('tooltip');
            vizContainer = document.getElementById('vizContainer');

            let startDist = 0;
            vizContainer.addEventListener('mousedown', e => {
                isDragging = true;
                lastPos = { x: e.clientX, y: e.clientY };
            });
            vizContainer.addEventListener('mousemove', e => {
                if (isDragging) {
                    const dx = e.clientX - lastPos.x;
                    const dy = e.clientY - lastPos.y;
                    config.panX -= dx / config.zoom;
                    config.panY -= dy / config.zoom;
                    lastPos = { x: e.clientX, y: e.clientY };
                    updateViewBox();
                }
                
                const target = e.target;
                if (target.hasAttribute('data-r')) {
                    const r = parseInt(target.getAttribute('data-r'));
                    const p = points[r];
                    tooltip.style.display = 'block';
                    tooltip.style.left = (e.pageX + 15) + 'px';
                    tooltip.style.top = (e.pageY + 15) + 'px';
                    tooltip.innerHTML = `<strong>r = ${p.r}</strong><br>M = ${p.M}<br>GCD = ${p.gcd}<br>${p.coprime ? 'Coprime' : `Channel M' = ${p.channel}`}<br>Angle: ${((p.angle * 180 / Math.PI) % 360).toFixed(1)}°`;
                } else {
                    tooltip.style.display = 'none';
                }
            });
            vizContainer.addEventListener('mouseup', () => isDragging = false);
            vizContainer.addEventListener('mouseleave', () => {
                isDragging = false;
                tooltip.style.display = 'none';
            });

            vizContainer.addEventListener('wheel', e => {
                e.preventDefault();
                const delta = e.deltaY < 0 ? 1.1 : 0.9;
                config.zoom = Math.min(Math.max(config.zoom * delta, 0.1), 5);
                document.getElementById('zoomSlider').value = Math.round(config.zoom * 100);
                document.getElementById('zoomVal').textContent = config.zoom.toFixed(2);
                updateViewBox();
            }, { passive: false });

            vizContainer.addEventListener('touchstart', e => {
                if (e.touches.length === 2) {
                    const t1 = e.touches[0], t2 = e.touches[1];
                    startDist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
                } else if (e.touches.length === 1) {
                    isDragging = true;
                    lastPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            });

            vizContainer.addEventListener('touchmove', e => {
                e.preventDefault();
                if (e.touches.length === 2) {
                    const t1 = e.touches[0], t2 = e.touches[1];
                    const dist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
                    const delta = dist / startDist;
                    config.zoom = Math.min(Math.max(config.zoom * delta, 0.1), 5);
                    startDist = dist;
                    document.getElementById('zoomSlider').value = Math.round(config.zoom * 100);
                    document.getElementById('zoomVal').textContent = config.zoom.toFixed(2);
                    updateViewBox();
                } else if (e.touches.length === 1 && isDragging) {
                    const dx = e.touches[0].clientX - lastPos.x;
                    const dy = e.touches[0].clientY - lastPos.y;
                    config.panX -= dx / config.zoom;
                    config.panY -= dy / config.zoom;
                    lastPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                    updateViewBox();
                }
            }, { passive: false });

            vizContainer.addEventListener('touchend', () => {
                isDragging = false;
                startDist = 0;
            });

            document.getElementById('modSlider').oninput = e => setM(parseInt(e.target.value));
            document.getElementById('modInput').oninput = e => {
                const v = parseInt(e.target.value);
                if (v >= 2 && v <= 10000) setM(v);
            };
            document.getElementById('zoomSlider').oninput = e => {
                config.zoom = parseInt(e.target.value) / 100;
                document.getElementById('zoomVal').textContent = config.zoom.toFixed(2);
                updateViewBox();
            };
            document.getElementById('speedSlider').oninput = e => {
                config.animSpeed = parseInt(e.target.value);
                document.getElementById('speedVal').textContent = e.target.value;
            };
            document.getElementById('thicknessSlider').oninput = e => {
                config.thicknessScale = parseInt(e.target.value) / 100;
                document.getElementById('thicknessVal').textContent = config.thicknessScale.toFixed(2);
                render();
            };
            document.getElementById('pointSizeSlider').oninput = e => {
                config.pointSize = parseFloat(e.target.value);
                document.getElementById('pointSizeVal').textContent = config.pointSize.toFixed(1);
                render();
            };
            document.getElementById('opacitySlider').oninput = e => {
                config.opacity = parseInt(e.target.value) / 100;
                document.getElementById('opacityVal').textContent = e.target.value;
                render();
            };
            document.getElementById('spacingSlider').oninput = e => {
                config.spacingFactor = parseInt(e.target.value) / 100;
                document.getElementById('spacingVal').textContent = config.spacingFactor.toFixed(2);
                calculate();
                render();
            };
            document.getElementById('minRingSlider').oninput = e => {
                config.minRing = parseInt(e.target.value);
                document.getElementById('minRingVal').textContent = e.target.value;
                calculate();
                render();
            };
            document.getElementById('rotationSlider').oninput = e => {
                config.rotation = parseInt(e.target.value);
                document.getElementById('rotationVal').textContent = e.target.value;
                render();
            };
            document.getElementById('colorScheme').onchange = e => {
                config.colorScheme = e.target.value;
                render();
            };
            document.getElementById('gapSelect').onchange = e => {
                config.gapHighlight = e.target.value;
                render();
            };
            document.getElementById('filterType').onchange = e => {
                config.filterType = e.target.value;
                render();
            };
            document.getElementById('showLabels').onchange = e => {
                config.showLabels = e.target.checked;
                render();
            };
            document.getElementById('labelMode').onchange = e => {
                config.labelMode = e.target.value;
                render();
            };
            document.getElementById('innerLabelMode').onchange = e => {
                config.innerLabelMode = e.target.value;
                render();
            };
            document.getElementById('labelSizeSlider').oninput = e => {
                config.labelSize = parseInt(e.target.value);
                document.getElementById('labelSizeVal').textContent = e.target.value;
                render();
            };
            document.getElementById('labelDistSlider').oninput = e => {
                config.labelDist = parseInt(e.target.value) / 100;
                document.getElementById('labelDistVal').textContent = config.labelDist.toFixed(2);
                render();
            };
            document.getElementById('labelBackground').onchange = e => {
                config.labelBackground = e.target.checked;
                render();
            };
            document.getElementById('labelCoprimesOnly').onchange = e => {
                config.labelCoprimesOnly = e.target.checked;
                render();
            };
            document.getElementById('labelEverySlider').oninput = e => {
                config.labelEvery = parseInt(e.target.value);
                document.getElementById('labelEveryVal').textContent = e.target.value;
                render();
            };
            
            // Multi-modulus controls
            document.getElementById('multiModMode').onchange = e => {
                config.multiModMode = e.target.checked;
                document.getElementById('multiModControls').style.display = e.target.checked ? 'block' : 'none';
                if (e.target.checked) {
                    applyMultiMod();
                } else {
                    render();
                }
            };
            
            document.getElementById('multiModDisplayMode').onchange = e => {
                const mode = e.target.value;
                document.getElementById('consecutiveControls').style.display = mode === 'consecutive' ? 'block' : 'none';
                document.getElementById('rangeControls').style.display = mode === 'range' ? 'block' : 'none';
                document.getElementById('customControls').style.display = mode === 'custom' ? 'block' : 'none';
            };
            
            document.getElementById('multiFromSlider').oninput = e => {
                config.multiModFrom = parseInt(e.target.value);
                document.getElementById('multiFromVal').textContent = e.target.value;
            };
            
            document.getElementById('multiToSlider').oninput = e => {
                config.multiModTo = parseInt(e.target.value);
                document.getElementById('multiToVal').textContent = e.target.value;
            };
            
            document.getElementById('rangeStartSlider').oninput = e => {
                document.getElementById('rangeStartVal').textContent = e.target.value;
            };
            
            document.getElementById('rangeEndSlider').oninput = e => {
                document.getElementById('rangeEndVal').textContent = e.target.value;
            };
            
            document.getElementById('multiModColorScheme').onchange = e => {
                config.multiModColorScheme = e.target.value;
                if (config.multiModMode) renderMultiMod();
            };
            
            document.getElementById('multiOpacitySlider').oninput = e => {
                config.multiModOpacity = parseInt(e.target.value) / 100;
                document.getElementById('multiOpacityVal').textContent = config.multiModOpacity.toFixed(2);
                if (config.multiModMode) renderMultiMod();
            };
            
            document.getElementById('multiStackMode').onchange = e => {
                config.multiStackMode = e.target.checked;
                document.getElementById('stackSpacingControl').style.display = e.target.checked ? 'block' : 'none';
                if (config.multiModMode) renderMultiMod();
            };
            
            document.getElementById('stackSpacingSlider').oninput = e => {
                config.stackSpacing = parseInt(e.target.value);
                document.getElementById('stackSpacingVal').textContent = e.target.value;
                if (config.multiModMode) renderMultiMod();
            };
            
            document.getElementById('showProjections').onchange = e => {
                config.showProjections = e.target.checked;
                render();
            };
            document.getElementById('showRings').onchange = e => {
                config.showRings = e.target.checked;
                render();
            };
            document.getElementById('showInnerRings').onchange = e => {
                config.showInnerRings = e.target.checked;
                render();
            };
            document.getElementById('colorInner').onchange = e => {
                config.colorInner = e.target.checked;
                render();
            };
            document.getElementById('showSymmetry').onchange = e => {
                config.showSymmetry = e.target.checked;
                render();
            };
            document.getElementById('highlightPrimes').onchange = e => {
                config.highlightPrimes = e.target.checked;
                render();
            };
            document.getElementById('loopCheck').onchange = e => {
                config.loop = e.target.checked;
            };
            document.getElementById('recordCheck').onchange = e => {
                config.recording = e.target.checked;
                if (config.recording) recordedFrames = [];
            };
        }

        // Initialize when portal tab is first opened
        window.portalInitialized = false;
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            setupEvents();
            calculate();
            render();
            window.portalInitialized = true;
        });

        // ═══════════════════════════════════════════════════════════
        // 3D FAREY DIVISOR LATTICE TAB IMPLEMENTATION
        // Visualizes the hierarchical structure of modular reduction
        // through a geometric embedding of the divisor lattice
        // ═══════════════════════════════════════════════════════════

        // ═══════════════════════════════════════════════════════════
        // BATCH PROCESSING TAB IMPLEMENTATION
        // ═══════════════════════════════════════════════════════════

        let batchState = {
            data: [],
            isProcessing: false,
            startTime: 0,
            chart: null
        };

        function initBatch() {
            setupBatchEvents();
            updateBatchCount();
        }

        function setupBatchEvents() {
            ['batchStart', 'batchEnd'].forEach(id => {
                document.getElementById(id).oninput = updateBatchCount;
            });

            ['batchPrimesOnly', 'batchPrimePowersOnly', 'batchCompositeOnly', 'batchHighlyComposite'].forEach(id => {
                document.getElementById(id).onchange = updateBatchCount;
            });
        }

        function updateBatchCount() {
            const start = parseInt(document.getElementById('batchStart').value);
            const end = parseInt(document.getElementById('batchEnd').value);
            const count = Math.max(0, end - start + 1);
            
            document.getElementById('batchCount').textContent = count;
            
            if (count > 1000) {
                document.getElementById('batchWarning').innerHTML = '⚠️ Large range may take several minutes';
                document.getElementById('batchWarning').style.color = '#ffc107';
            } else if (count > 5000) {
                document.getElementById('batchWarning').innerHTML = '⚠️ Very large range - expect long processing time';
                document.getElementById('batchWarning').style.color = '#dc3545';
            } else {
                document.getElementById('batchWarning').innerHTML = '';
            }
        }

        async function startBatchProcessing() {
            if (batchState.isProcessing) return;

            const start = parseInt(document.getElementById('batchStart').value);
            const end = parseInt(document.getElementById('batchEnd').value);
            const type = document.getElementById('batchType').value;
            
            if (start >= end) {
                alert('Start must be less than End');
                return;
            }

            batchState.isProcessing = true;
            batchState.data = [];
            batchState.startTime = Date.now();
            
            document.getElementById('batchStartBtn').disabled = true;
            document.getElementById('batchProgressBar').style.display = 'block';
            document.getElementById('batchStatus').textContent = 'Processing...';

            // Process in chunks for responsiveness
            const chunkSize = 50;
            let processed = 0;
            const total = end - start + 1;

            for (let M = start; M <= end; M++) {
                if (shouldIncludeInBatch(M)) {
                    const result = await processBatchValue(M, type);
                    if (result) batchState.data.push(result);
                }

                processed++;
                const progress = Math.round((processed / total) * 100);
                document.getElementById('batchProgressFill').style.width = progress + '%';
                document.getElementById('batchProgressFill').textContent = progress + '%';
                document.getElementById('batchProgressText').textContent = `Processing M=${M}...`;

                // Update live stats
                updateBatchStats();

                // Yield to UI every chunk
                if (processed % chunkSize === 0) {
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }

            batchState.isProcessing = false;
            document.getElementById('batchStartBtn').disabled = false;
            document.getElementById('batchStatus').textContent = `Complete! ${batchState.data.length} values processed.`;
            document.getElementById('batchProgressText').textContent = 'Processing complete!';
            
            document.getElementById('batchExportCSV').disabled = false;
            document.getElementById('batchExportJSON').disabled = false;
            document.getElementById('batchExportCSV').style.opacity = '1';
            document.getElementById('batchExportJSON').style.opacity = '1';

            renderBatchResults();
            updateBatchChart();
        }

        function shouldIncludeInBatch(M) {
            const primesOnly = document.getElementById('batchPrimesOnly').checked;
            const primePowersOnly = document.getElementById('batchPrimePowersOnly').checked;
            const compositeOnly = document.getElementById('batchCompositeOnly').checked;
            const highlyComposite = document.getElementById('batchHighlyComposite').checked;

            if (primesOnly && !isPrime(M)) return false;
            if (primePowersOnly && !isPrimePower(M)) return false;
            if (compositeOnly && (isPrime(M) || M === 1)) return false;
            if (highlyComposite && getDivisors(M).length < 10) return false;

            return true;
        }

        function processBatchValue(M, type) {
            switch(type) {
                case 'totient':
                    return { M, phi: phi(M), density: phi(M)/M };
                
                case 'coprime_density':
                    const phiM = phi(M);
                    const coprimes = [];
                    for (let i = 0; i < M; i++) {
                        if (gcd(i, M) === 1) coprimes.push(i);
                    }
                    return { M, phi: phiM, density: phiM/M, coprimes: coprimes.length };
                
                case 'divisor_counts':
                    const divs = getDivisors(M);
                    return { M, tau: divs.length, divisors: divs.join(',') };
                
                case 'gap_statistics':
                    const gaps = [];
                    let last = -1;
                    for (let i = 0; i < M; i++) {
                        if (gcd(i, M) === 1) {
                            if (last >= 0) gaps.push(i - last);
                            last = i;
                        }
                    }
                    return { 
                        M, 
                        avgGap: gaps.length > 0 ? (gaps.reduce((a,b) => a+b, 0) / gaps.length).toFixed(2) : 0,
                        maxGap: gaps.length > 0 ? Math.max(...gaps) : 0,
                        minGap: gaps.length > 0 ? Math.min(...gaps) : 0
                    };
                
                case 'channel_structure':
                    const channels = new Map();
                    for (let r = 0; r < M; r++) {
                        const g = gcd(r, M);
                        if (g > 1) {
                            const ch = M / g;
                            channels.set(ch, (channels.get(ch) || 0) + 1);
                        }
                    }
                    return { M, channels: channels.size, channelList: Array.from(channels.keys()).join(',') };
                
                case 'sequence_periods':
                    // Fibonacci Pisano period
                    const period = findPisanoPeriod(M);
                    return { M, pisanoPeriod: period };
                
                case 'prime_factors':
                    const pf = getPrimeFactorization(M);
                    const omegaM = omega(M);
                    return { M, factorization: pf, omega: omegaM, isPrime: isPrime(M) };
                
                case 'full_analysis':
                    const fullData = computeAnalysis(M);
                    return {
                        M,
                        phi: fullData.phi,
                        density: fullData.density.toFixed(4),
                        divisors: fullData.divisorCount,
                        avgGap: fullData.avgGap.toFixed(2),
                        maxGap: fullData.maxGap,
                        omega: fullData.omegaM,
                        factorization: fullData.primeFactorization
                    };
                
                default:
                    return { M };
            }
        }

        function findPisanoPeriod(M) {
            const maxPeriod = M * M; // Upper bound
            let a = 0, b = 1;
            for (let i = 0; i < maxPeriod; i++) {
                [a, b] = [b, (a + b) % M];
                if (a === 0 && b === 1) return i + 1;
            }
            return maxPeriod;
        }

        function updateBatchStats() {
            const elapsed = ((Date.now() - batchState.startTime) / 1000).toFixed(1);
            document.getElementById('batchTotalProcessed').textContent = batchState.data.length;
            document.getElementById('batchTimeElapsed').textContent = elapsed + 's';
            
            // Estimate data points
            const fields = Object.keys(batchState.data[0] || {}).length;
            document.getElementById('batchDataPoints').textContent = batchState.data.length * fields;
            
            // Estimate file size (rough)
            const estSize = Math.round((JSON.stringify(batchState.data).length / 1024));
            document.getElementById('batchEstSize').textContent = estSize + ' KB';
        }

        function renderBatchResults() {
            if (batchState.data.length === 0) {
                document.getElementById('batchResultsTable').innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">No data generated.</p>';
                return;
            }

            const headers = Object.keys(batchState.data[0]);
            let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;"><thead><tr style="background: #667eea; color: white; position: sticky; top: 0;">';
            
            headers.forEach(h => {
                html += `<th style="padding: 0.5rem; text-align: left; border: 1px solid #ddd;">${h}</th>`;
            });
            html += '</tr></thead><tbody>';

            const preview = batchState.data.slice(0, 100);
            preview.forEach(row => {
                html += '<tr style="border-bottom: 1px solid #eee;">';
                headers.forEach(h => {
                    html += `<td style="padding: 0.5rem; border: 1px solid #eee;">${row[h]}</td>`;
                });
                html += '</tr>';
            });

            if (batchState.data.length > 100) {
                html += `<tr><td colspan="${headers.length}" style="text-align: center; padding: 1rem; color: #999; font-style: italic;">... ${batchState.data.length - 100} more rows (use export to see all)</td></tr>`;
            }

            html += '</tbody></table>';
            document.getElementById('batchResultsTable').innerHTML = html;
        }

        function updateBatchChart() {
            if (batchState.data.length === 0) return;

            const ctx = document.getElementById('batchPreviewChart');
            if (batchState.chart) batchState.chart.destroy();

            const type = document.getElementById('batchType').value;
            let labels, data, label;

            if (type === 'totient' || type === 'coprime_density') {
                labels = batchState.data.map(d => d.M);
                data = batchState.data.map(d => d.density);
                label = 'φ(M)/M Density';
            } else if (type === 'divisor_counts') {
                labels = batchState.data.map(d => d.M);
                data = batchState.data.map(d => d.tau);
                label = 'τ(M) Divisor Count';
            } else if (type === 'gap_statistics') {
                labels = batchState.data.map(d => d.M);
                data = batchState.data.map(d => parseFloat(d.avgGap));
                label = 'Average Gap';
            } else {
                labels = batchState.data.map(d => d.M);
                data = batchState.data.map((d, i) => i);
                label = 'Index';
            }

            batchState.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.slice(0, Math.min(100, labels.length)),
                    datasets: [{
                        label: label,
                        data: data.slice(0, Math.min(100, data.length)),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: true } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: label } },
                        x: { title: { display: true, text: 'Modulus M' } }
                    }
                }
            });
        }

        function exportBatchCSV() {
            if (batchState.data.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = Object.keys(batchState.data[0]);
            let csv = headers.join(',') + '\n';
            
            batchState.data.forEach(row => {
                csv += headers.map(h => {
                    const val = row[h];
                    return typeof val === 'string' && val.includes(',') ? `"${val}"` : val;
                }).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const type = document.getElementById('batchType').value;
            const start = document.getElementById('batchStart').value;
            const end = document.getElementById('batchEnd').value;
            link.download = `batch_${type}_${start}-${end}.csv`;
            link.click();
        }

        function exportBatchJSON() {
            if (batchState.data.length === 0) {
                alert('No data to export');
                return;
            }

            const blob = new Blob([JSON.stringify(batchState.data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const type = document.getElementById('batchType').value;
            const start = document.getElementById('batchStart').value;
            const end = document.getElementById('batchEnd').value;
            link.download = `batch_${type}_${start}-${end}.json`;
            link.click();
        }

        // ═══════════════════════════════════════════════════════════
        // COMPARATIVE VISUALIZER TAB IMPLEMENTATION
        // ═══════════════════════════════════════════════════════════

        let compareState = {
            moduli: [],
            canvases: [],
            contexts: [],
            data: [],
            syncZoom: true,
            currentZoom: 1,
            currentOffset: { x: 0, y: 0 }
        };

        function initCompare() {
            // Initialize on first use
        }

        function generateComparison() {
            const M1 = parseInt(document.getElementById('compareM1').value);
            const M2 = parseInt(document.getElementById('compareM2').value);
            const M3 = document.getElementById('compareM3').value ? parseInt(document.getElementById('compareM3').value) : null;
            const M4 = document.getElementById('compareM4').value ? parseInt(document.getElementById('compareM4').value) : null;

            compareState.moduli = [M1, M2];
            if (M3) compareState.moduli.push(M3);
            if (M4) compareState.moduli.push(M4);

            compareState.syncZoom = document.getElementById('compareSyncZoom').checked;

            // Generate data for all moduli
            compareState.data = compareState.moduli.map(M => computeAnalysis(M));

            renderComparisonGrid();
            renderComparisonStats();
            renderRelationshipAnalysis();
        }

        function renderComparisonGrid() {
            const grid = document.getElementById('compareGrid');
            grid.innerHTML = '';
            compareState.canvases = [];
            compareState.contexts = [];

            compareState.moduli.forEach((M, idx) => {
                const card = document.createElement('div');
                card.style.cssText = 'background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';

                const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe'];
                const color = colors[idx % colors.length];

                card.innerHTML = `
                    <h3 style="color: ${color}; margin-bottom: 1rem; border-bottom: 3px solid ${color}; padding-bottom: 0.5rem;">
                        M = ${M}
                    </h3>
                    <canvas id="compareCanvas${idx}" width="600" height="600" style="width: 100%; height: auto; display: block; background: #000; border-radius: 8px; margin-bottom: 1rem;"></canvas>
                    <div style="font-size: 0.9rem; line-height: 1.6; color: #666;">
                        <div><strong>φ(M):</strong> ${compareState.data[idx].phi}</div>
                        <div><strong>Density:</strong> ${(compareState.data[idx].density * 100).toFixed(2)}%</div>
                        <div><strong>Divisors:</strong> ${compareState.data[idx].divisorCount}</div>
                        <div><strong>Factorization:</strong> ${compareState.data[idx].primeFactorization}</div>
                    </div>
                `;

                grid.appendChild(card);

                const canvas = document.getElementById(`compareCanvas${idx}`);
                const ctx = canvas.getContext('2d');
                compareState.canvases.push(canvas);
                compareState.contexts.push(ctx);

                renderCompareVisualization(ctx, compareState.data[idx], 600, 600, color);
            });
        }

        function renderCompareVisualization(ctx, data, w, h, color) {
            const M = data.M;
            const cx = w / 2, cy = h / 2;
            const radius = Math.min(w, h) * 0.4;

            // Clear
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);

            // Draw circle
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0, Math.PI * 2);
            ctx.stroke();

            // Draw all residues
            for (let r = 0; r < M; r++) {
                const angle = -Math.PI / 2 + (2 * Math.PI * r / M);
                const x = cx + radius * Math.cos(angle);
                const y = cy + radius * Math.sin(angle);

                const g = gcd(r, M);
                const isCoprime = g === 1;

                // Point
                ctx.fillStyle = isCoprime ? color : '#ff0000';
                ctx.beginPath();
                ctx.arc(x, y, isCoprime ? 5 : 3, 0, Math.PI * 2);
                ctx.fill();

                // Label key points
                if (M <= 60 && (isCoprime || r % 5 === 0)) {
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 10px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const lx = cx + (radius + 15) * Math.cos(angle);
                    const ly = cy + (radius + 15) * Math.sin(angle);
                    ctx.fillText(r, lx, ly);
                }

                // Draw Farey channels with different intensities
                if (!isCoprime) {
                    const targetM = M / g;
                    const targetR = r / g;
                    const targetAngle = -Math.PI / 2 + (2 * Math.PI * targetR / targetM);
                    const targetDist = radius * targetM / M;
                    const tx = cx + targetDist * Math.cos(targetAngle);
                    const ty = cy + targetDist * Math.sin(targetAngle);

                    ctx.strokeStyle = `rgba(255, 255, 0, ${0.2 / Math.log(g + 1)})`;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(tx, ty);
                    ctx.stroke();
                }
            }

            // Title
            ctx.fillStyle = color;
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`ℤ/${M}ℤ`, cx, 30);
        }

        function renderComparisonStats() {
            const data = compareState.data;
            const moduli = compareState.moduli;

            let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;"><thead><tr style="background: #667eea; color: white;">';
            html += '<th style="padding: 0.8rem; text-align: left;">Property</th>';
            moduli.forEach((M, idx) => {
                const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe'];
                html += `<th style="padding: 0.8rem; text-align: center; background: ${colors[idx]};">M = ${M}</th>`;
            });
            html += '</tr></thead><tbody>';

            const rows = [
                ['Prime Factorization', d => d.primeFactorization],
                ['φ(M) (Totient)', d => d.phi],
                ['Coprime Density', d => (d.density * 100).toFixed(2) + '%'],
                ['Divisor Count τ(M)', d => d.divisorCount],
                ['Farey Chains', d => d.nonCoprimes.length],
                ['ω(M) (Distinct Primes)', d => d.omegaM],
                ['Average Gap', d => d.avgGap.toFixed(2)],
                ['Maximum Gap', d => d.maxGap],
                ['Classification', d => d.isPrime ? 'Prime' : d.isPrimePower ? 'Prime Power' : 'Composite']
            ];

            rows.forEach(([label, getter], rowIdx) => {
                const bg = rowIdx % 2 === 0 ? '#f9f9f9' : 'white';
                html += `<tr style="background: ${bg};"><td style="padding: 0.7rem; font-weight: bold; border-bottom: 1px solid #ddd;">${label}</td>`;
                data.forEach(d => {
                    html += `<td style="padding: 0.7rem; text-align: center; border-bottom: 1px solid #ddd;">${getter(d)}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            document.getElementById('compareStats').innerHTML = html;
        }

        function renderRelationshipAnalysis() {
            const moduli = compareState.moduli;
            const data = compareState.data;
            const relationships = [];

            // Pairwise analysis
            for (let i = 0; i < moduli.length; i++) {
                for (let j = i + 1; j < moduli.length; j++) {
                    const M1 = moduli[i], M2 = moduli[j];
                    const g = gcd(M1, M2);
                    const lcmVal = (M1 * M2) / g;

                    relationships.push(`<div style="padding: 1rem; background: rgba(102, 126, 234, 0.1); border-left: 4px solid #667eea; margin-bottom: 1rem; border-radius: 4px;">
                        <strong style="color: #667eea;">M₁=${M1} vs M₂=${M2}</strong><br>
                        • gcd(${M1}, ${M2}) = ${g}${g > 1 ? ' → Share common factors' : ' → Coprime'}<br>
                        • lcm(${M1}, ${M2}) = ${lcmVal}<br>
                        ${M2 % M1 === 0 ? `• ${M2} is a multiple of ${M1}<br>` : ''}
                        ${M1 % M2 === 0 ? `• ${M1} is a multiple of ${M2}<br>` : ''}
                        • Density ratio: ${(data[j].density / data[i].density).toFixed(3)}<br>
                        • Totient ratio: φ(${M2})/φ(${M1}) = ${(data[j].phi / data[i].phi).toFixed(3)}
                    </div>`);
                }
            }

            // Global patterns
            const avgDensity = data.reduce((s, d) => s + d.density, 0) / data.length;
            const maxPhi = Math.max(...data.map(d => d.phi));
            const minPhi = Math.min(...data.map(d => d.phi));

            relationships.push(`<div style="padding: 1rem; background: rgba(40, 167, 69, 0.1); border-left: 4px solid #28a745; margin-bottom: 1rem; border-radius: 4px;">
                <strong style="color: #28a745;">Overall Patterns</strong><br>
                • Average coprime density: ${(avgDensity * 100).toFixed(2)}%<br>
                • Totient range: ${minPhi} to ${maxPhi}<br>
                • Total distinct primes across all M: ${countDistinctPrimes(data)}<br>
                • ${data.filter(d => d.isPrime).length} prime moduli, ${data.filter(d => d.isPrimePower).length} prime powers
            </div>`);

            document.getElementById('compareRelationships').innerHTML = relationships.join('');
        }

        function countDistinctPrimes(dataArray) {
            const primes = new Set();
            dataArray.forEach(d => {
                d.divisors.forEach(div => {
                    if (isPrime(div)) primes.add(div);
                });
            });
            return primes.size;
        }

        function exportComparisonCSV() {
            const moduli = compareState.moduli;
            const data = compareState.data;

            let csv = 'M,Factorization,phi(M),Density,Divisors,Chains,AvgGap,MaxGap,Classification\n';
            data.forEach((d, idx) => {
                csv += `${moduli[idx]},${d.primeFactorization},${d.phi},${d.density.toFixed(4)},${d.divisorCount},${d.nonCoprimes.length},${d.avgGap.toFixed(2)},${d.maxGap},${d.isPrime ? 'Prime' : d.isPrimePower ? 'PrimePower' : 'Composite'}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `comparison-${moduli.join('-')}.csv`;
            link.click();
        }

        function exportComparisonImages() {
            compareState.canvases.forEach((canvas, idx) => {
                const link = document.createElement('a');
                link.download = `comparison-M${compareState.moduli[idx]}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function exportComparisonReport() {
            const moduli = compareState.moduli;
            const data = compareState.data;

            let report = 'COMPARATIVE ANALYSIS REPORT\n';
            report += '============================\n\n';
            report += `Moduli: ${moduli.join(', ')}\n\n`;

            moduli.forEach((M, idx) => {
                const d = data[idx];
                report += `\nM = ${M}\n`;
                report += `${'='.repeat(30)}\n`;
                report += `Prime Factorization: ${d.primeFactorization}\n`;
                report += `φ(${M}) = ${d.phi}\n`;
                report += `Coprime Density: ${(d.density * 100).toFixed(2)}%\n`;
                report += `Divisor Count: ${d.divisorCount}\n`;
                report += `Average Gap: ${d.avgGap.toFixed(2)}\n`;
                report += `Maximum Gap: ${d.maxGap}\n`;
                report += `Classification: ${d.isPrime ? 'Prime' : d.isPrimePower ? 'Prime Power' : 'Composite'}\n`;
            });

            report += '\n\nRELATIONSHIPS\n';
            report += '=============\n\n';

            for (let i = 0; i < moduli.length; i++) {
                for (let j = i + 1; j < moduli.length; j++) {
                    const M1 = moduli[i], M2 = moduli[j];
                    const g = gcd(M1, M2);
                    report += `gcd(${M1}, ${M2}) = ${g}\n`;
                    if (M2 % M1 === 0) report += `${M2} is a multiple of ${M1}\n`;
                }
            }

            report += '\n\nGenerated by Modular Reduction Projection Research Portal\n';
            report += 'wessengetachew.github.io\n';

            const blob = new Blob([report], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `comparison-report-${moduli.join('-')}.txt`;
            link.click();
        }

        // ═══════════════════════════════════════════════════════════
        // SIEVE ANIMATION TAB IMPLEMENTATION
        // ═══════════════════════════════════════════════════════════

        let sieveState = {
            canvas: null, ctx: null,
            algorithm: 'eratosthenes',
            N: 100, M: 30,
            numbers: [],
            currentPrime: 2,
            step: 0,
            isRunning: false,
            isPaused: false,
            speed: 3,
            animationFrame: null,
            lastUpdate: 0
        };

        function initSieve() {
            sieveState.canvas = document.getElementById('sieveCanvas');
            sieveState.ctx = sieveState.canvas.getContext('2d');
            setupSieveEvents();
            updateAlgorithmInfo();
            resetSieve();
        }

        function setupSieveEvents() {
            document.getElementById('sieveAlgorithm').onchange = e => {
                sieveState.algorithm = e.target.value;
                const showM = e.target.value === 'modular' || e.target.value === 'channel';
                document.getElementById('sieveModulusControl').style.display = showM ? 'block' : 'none';
                updateAlgorithmInfo();
                resetSieve();
            };

            document.getElementById('sieveNSlider').oninput = e => {
                sieveState.N = parseInt(e.target.value);
                document.getElementById('sieveN').textContent = e.target.value;
                resetSieve();
            };

            document.getElementById('sieveMSlider').oninput = e => {
                sieveState.M = parseInt(e.target.value);
                document.getElementById('sieveM').textContent = e.target.value;
                resetSieve();
            };

            document.getElementById('sieveSpeedSlider').oninput = e => {
                sieveState.speed = parseInt(e.target.value);
                const speeds = ['Very Slow', 'Slow', 'Medium', 'Fast', 'Very Fast'];
                document.getElementById('sieveSpeed').textContent = speeds[e.target.value - 1];
            };

            ['sieveShowNumbers', 'sieveShowExplanation', 'sieveShowStats'].forEach(id => {
                document.getElementById(id).onchange = () => {
                    updateSieveDisplay();
                    renderSieve();
                };
            });
        }

        function updateAlgorithmInfo() {
            const infos = {
                eratosthenes: '<strong>Sieve of Eratosthenes:</strong><br>Ancient algorithm to find all primes up to N. Iteratively mark multiples of each prime starting from 2.',
                modular: '<strong>Modular Sieve:</strong><br>Find coprime residues in ℤ/Mℤ by eliminating multiples of each prime factor of M.',
                channel: '<strong>Channel Sieve:</strong><br>Eliminate residues channel-by-channel based on GCD with M, showing Farey structure formation.',
                sundaram: '<strong>Sieve of Sundaram:</strong><br>Generates odd primes by eliminating numbers of form i+j+2ij from {1,2,...,k}.'
            };
            document.getElementById('sieveAlgoInfo').innerHTML = infos[sieveState.algorithm];
        }

        function resetSieve() {
            sieveState.isRunning = false;
            sieveState.isPaused = false;
            sieveState.step = 0;
            sieveState.currentPrime = 2;
            
            if (sieveState.animationFrame) {
                cancelAnimationFrame(sieveState.animationFrame);
                sieveState.animationFrame = null;
            }

            // Initialize numbers based on algorithm
            const N = sieveState.N;
            const M = sieveState.M;
            
            if (sieveState.algorithm === 'eratosthenes') {
                sieveState.numbers = Array.from({length: N+1}, (_, i) => ({
                    value: i,
                    state: i < 2 ? 'eliminated' : 'unmarked',
                    highlight: false
                }));
            } else if (sieveState.algorithm === 'sundaram') {
                const k = Math.floor((N - 1) / 2);
                sieveState.numbers = Array.from({length: k+1}, (_, i) => ({
                    value: i,
                    state: i < 1 ? 'eliminated' : 'unmarked',
                    highlight: false
                }));
            } else {
                // Modular or channel
                sieveState.numbers = Array.from({length: M}, (_, i) => ({
                    value: i,
                    state: 'unmarked',
                    highlight: false,
                    gcd: gcd(i, M)
                }));
            }

            document.getElementById('sieveStartBtn').style.display = 'block';
            document.getElementById('sievePauseBtn').style.display = 'none';
            
            updateSieveStats();
            updateSieveStatus();
            renderSieve();
        }

        function startSieve() {
            if (!sieveState.isRunning) {
                sieveState.isRunning = true;
                sieveState.isPaused = false;
                document.getElementById('sieveStartBtn').style.display = 'none';
                document.getElementById('sievePauseBtn').style.display = 'block';
                sieveState.lastUpdate = Date.now();
                animateSieve();
            }
        }

        function pauseSieve() {
            sieveState.isPaused = true;
            sieveState.isRunning = false;
            document.getElementById('sieveStartBtn').style.display = 'block';
            document.getElementById('sievePauseBtn').style.display = 'none';
            if (sieveState.animationFrame) {
                cancelAnimationFrame(sieveState.animationFrame);
            }
        }

        function stepSieve() {
            if (!sieveState.isRunning) {
                executeNextSieveStep();
                renderSieve();
                updateSieveStats();
                updateSieveStatus();
            }
        }

        function animateSieve() {
            if (!sieveState.isRunning) return;

            const now = Date.now();
            const delays = [1000, 500, 200, 100, 50]; // ms per step based on speed
            const delay = delays[sieveState.speed - 1];

            if (now - sieveState.lastUpdate >= delay) {
                const shouldContinue = executeNextSieveStep();
                renderSieve();
                updateSieveStats();
                updateSieveStatus();
                sieveState.lastUpdate = now;

                if (!shouldContinue) {
                    pauseSieve();
                    return;
                }
            }

            sieveState.animationFrame = requestAnimationFrame(animateSieve);
        }

        function executeNextSieveStep() {
            const algo = sieveState.algorithm;
            
            if (algo === 'eratosthenes') {
                return stepEratosthenes();
            } else if (algo === 'sundaram') {
                return stepSundaram();
            } else if (algo === 'modular') {
                return stepModular();
            } else if (algo === 'channel') {
                return stepChannel();
            }
            return false;
        }

        function stepEratosthenes() {
            const nums = sieveState.numbers;
            const N = sieveState.N;
            
            // Clear previous highlights
            nums.forEach(n => n.highlight = false);

            // Find next prime
            while (sieveState.currentPrime <= Math.sqrt(N)) {
                if (nums[sieveState.currentPrime].state === 'unmarked') {
                    nums[sieveState.currentPrime].state = 'prime';
                    nums[sieveState.currentPrime].highlight = true;
                    
                    // Mark multiples
                    for (let i = sieveState.currentPrime * sieveState.currentPrime; i <= N; i += sieveState.currentPrime) {
                        if (nums[i].state === 'unmarked') {
                            nums[i].state = 'eliminated';
                        }
                    }
                    
                    sieveState.currentPrime++;
                    return true;
                }
                sieveState.currentPrime++;
            }

            // Mark remaining unmarked as prime
            for (let i = 2; i <= N; i++) {
                if (nums[i].state === 'unmarked') {
                    nums[i].state = 'prime';
                }
            }
            
            return false;
        }

        function stepSundaram() {
            const nums = sieveState.numbers;
            const k = nums.length - 1;
            
            nums.forEach(n => n.highlight = false);

            const i = Math.floor(Math.sqrt(sieveState.step)) + 1;
            const j = sieveState.step - i * (i - 1);
            
            if (i <= k / 2) {
                const eliminate = i + j + 2 * i * j;
                if (eliminate <= k && nums[eliminate] && nums[eliminate].state === 'unmarked') {
                    nums[eliminate].state = 'eliminated';
                    nums[eliminate].highlight = true;
                }
                sieveState.step++;
                return true;
            }

            // Convert remaining to primes
            for (let i = 1; i < nums.length; i++) {
                if (nums[i].state === 'unmarked') {
                    nums[i].state = 'prime';
                    nums[i].value = 2 * i + 1;
                }
            }
            
            return false;
        }

        function stepModular() {
            const nums = sieveState.numbers;
            const M = sieveState.M;
            const primeFactors = getPrimeFactors(M);
            
            nums.forEach(n => n.highlight = false);

            if (sieveState.step < primeFactors.length) {
                const p = primeFactors[sieveState.step];
                
                for (let i = 0; i < M; i++) {
                    if (i % p === 0 && nums[i].state === 'unmarked') {
                        nums[i].state = 'eliminated';
                        nums[i].highlight = true;
                    }
                }
                
                sieveState.step++;
                return true;
            }

            // Mark coprime as kept
            for (let i = 0; i < M; i++) {
                if (nums[i].state === 'unmarked') {
                    nums[i].state = 'coprime';
                }
            }
            
            return false;
        }

        function stepChannel() {
            const nums = sieveState.numbers;
            const M = sieveState.M;
            const divisors = getDivisors(M).filter(d => d < M).sort((a,b) => b - a);
            
            nums.forEach(n => n.highlight = false);

            if (sieveState.step < divisors.length) {
                const channel = divisors[sieveState.step];
                
                for (let i = 0; i < M; i++) {
                    const g = gcd(i, M);
                    if (M / g === channel && nums[i].state === 'unmarked') {
                        nums[i].state = 'channel' + sieveState.step;
                        nums[i].highlight = true;
                        nums[i].channelM = channel;
                    }
                }
                
                sieveState.step++;
                return true;
            }

            return false;
        }

        function getPrimeFactors(n) {
            const factors = [];
            let temp = n;
            for (let p = 2; p * p <= temp; p++) {
                if (temp % p === 0) {
                    factors.push(p);
                    while (temp % p === 0) temp /= p;
                }
            }
            if (temp > 1) factors.push(temp);
            return factors;
        }

        function renderSieve() {
            const ctx = sieveState.ctx;
            const w = 1200, h = 800;
            const nums = sieveState.numbers;
            const showNums = document.getElementById('sieveShowNumbers').checked;
            
            // Clear
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);

            // Grid layout
            const cols = Math.ceil(Math.sqrt(nums.length * 1.5));
            const rows = Math.ceil(nums.length / cols);
            const cellW = (w - 40) / cols;
            const cellH = (h - 100) / rows;
            const size = Math.min(cellW, cellH) - 4;

            nums.forEach((num, idx) => {
                const col = idx % cols;
                const row = Math.floor(idx / cols);
                const x = 20 + col * cellW + cellW / 2;
                const y = 60 + row * cellH + cellH / 2;

                // Color based on state
                let color = '#444';
                if (num.state === 'prime' || num.state === 'coprime') color = '#00ff00';
                else if (num.state === 'eliminated') color = '#ff0000';
                else if (num.state.startsWith('channel')) {
                    const hue = (parseInt(num.state.replace('channel', '')) * 60) % 360;
                    color = `hsl(${hue}, 70%, 50%)`;
                }

                // Highlight
                if (num.highlight) {
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.3)';
                    ctx.fillRect(x - size/2 - 5, y - size/2 - 5, size + 10, size + 10);
                }

                // Box
                ctx.fillStyle = color;
                ctx.fillRect(x - size/2, y - size/2, size, size);

                // Number
                if (showNums && size > 15) {
                    ctx.fillStyle = '#000';
                    ctx.font = `bold ${Math.min(size * 0.4, 16)}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(num.value, x, y);
                }
            });

            // Title
            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            const titles = {
                eratosthenes: 'Sieve of Eratosthenes',
                sundaram: 'Sieve of Sundaram',
                modular: `Modular Sieve (M=${sieveState.M})`,
                channel: `Channel Sieve (M=${sieveState.M})`
            };
            ctx.fillText(titles[sieveState.algorithm], w/2, 30);
        }

        function updateSieveStats() {
            const nums = sieveState.numbers;
            const processed = nums.filter(n => n.state !== 'unmarked').length;
            const kept = nums.filter(n => n.state === 'prime' || n.state === 'coprime' || n.state.startsWith('channel')).length;
            const eliminated = nums.filter(n => n.state === 'eliminated').length;
            const progress = Math.round((processed / nums.length) * 100);

            if (document.getElementById('sieveShowStats').checked) {
                document.getElementById('sieveCountProcessed').textContent = processed;
                document.getElementById('sieveCountKept').textContent = kept;
                document.getElementById('sieveCountEliminated').textContent = eliminated;
                document.getElementById('sieveProgress').textContent = progress + '%';
                document.getElementById('sieveStatsPanel').style.display = 'grid';
            } else {
                document.getElementById('sieveStatsPanel').style.display = 'none';
            }
        }

        function updateSieveStatus() {
            let status = '';
            const algo = sieveState.algorithm;
            
            if (algo === 'eratosthenes') {
                status = `Current prime: ${sieveState.currentPrime}<br>Marking multiples...`;
            } else if (algo === 'modular') {
                const pf = getPrimeFactors(sieveState.M);
                if (sieveState.step < pf.length) {
                    status = `Eliminating multiples of ${pf[sieveState.step]}`;
                } else {
                    status = 'Complete! Coprime residues found.';
                }
            } else if (algo === 'channel') {
                const divs = getDivisors(sieveState.M).filter(d => d < sieveState.M);
                if (sieveState.step < divs.length) {
                    status = `Channel M'=${divs[sieveState.step]}`;
                } else {
                    status = 'Complete! All channels identified.';
                }
            } else {
                status = `Step ${sieveState.step}`;
            }

            document.getElementById('sieveStatus').innerHTML = status;

            // Update explanation
            if (document.getElementById('sieveShowExplanation').checked) {
                updateSieveExplanation();
                document.getElementById('sieveExplanationPanel').style.display = 'block';
            } else {
                document.getElementById('sieveExplanationPanel').style.display = 'none';
            }
        }

        function updateSieveExplanation() {
            const algo = sieveState.algorithm;
            let exp = '';

            if (algo === 'eratosthenes') {
                exp = `<strong>Step:</strong> Marking multiples of ${sieveState.currentPrime - 1}.<br>`;
                exp += `All multiples of ${sieveState.currentPrime - 1} are composite, so we eliminate them.<br>`;
                exp += `The remaining unmarked numbers will be prime.`;
            } else if (algo === 'modular') {
                const pf = getPrimeFactors(sieveState.M);
                if (sieveState.step < pf.length) {
                    exp = `<strong>Prime factor:</strong> ${pf[sieveState.step]}<br>`;
                    exp += `Eliminating all residues divisible by ${pf[sieveState.step]}.<br>`;
                    exp += `These residues share this factor with M, so gcd(r,M) > 1.`;
                } else {
                    exp = `<strong>Complete!</strong> All remaining residues are coprime to M.<br>`;
                    exp += `These form the multiplicative group (ℤ/Mℤ)×.`;
                }
            } else if (algo === 'channel') {
                exp = `<strong>Channel-by-channel elimination:</strong><br>`;
                exp += `Grouping residues by their target channel M/gcd(r,M).<br>`;
                exp += `This reveals the hierarchical Farey structure.`;
            }

            document.getElementById('sieveExplanation').innerHTML = exp;
        }

        function updateSieveDisplay() {
            // Handle visibility toggles
            renderSieve();
        }

        function exportSieveGIF() {
            alert('GIF recording feature: Reset and click Start to record!\nEach step will be captured for export.');
        }

        // ═══════════════════════════════════════════════════════════
        // CUSTOM SEQUENCES TAB IMPLEMENTATION
        // ═══════════════════════════════════════════════════════════

        let seqData = { sequence: [], modSequence: [], M: 30, type: 'fibonacci' };
        let seqCanvas, seqCtx;
        let seqAnimFrame = null;

        function initSequences() {
            seqCanvas = document.getElementById('sequenceCanvas');
            seqCtx = seqCanvas.getContext('2d');
            setupSequenceEvents();
            generateSequence();
        }

        function setupSequenceEvents() {
            document.getElementById('seqPreset').onchange = e => {
                const isCustom = e.target.value === 'custom';
                document.getElementById('seqCustomFormula').style.display = isCustom ? 'block' : 'none';
                if (!isCustom) generateSequence();
            };

            document.getElementById('seqMSlider').oninput = e => {
                document.getElementById('seqM').textContent = e.target.value;
                document.getElementById('seqMInput').value = e.target.value;
            };

            document.getElementById('seqMInput').oninput = e => {
                const v = parseInt(e.target.value);
                if (v >= 2 && v <= 2000) {
                    document.getElementById('seqMSlider').value = Math.min(500, v);
                    document.getElementById('seqM').textContent = v;
                }
            };

            document.getElementById('seqTermsSlider').oninput = e => {
                document.getElementById('seqTerms').textContent = e.target.value;
            };

            ['seqShowConnections', 'seqShowLabels', 'seqHighlightPeriod'].forEach(id => {
                document.getElementById(id).onchange = () => renderSequence();
            });

            document.getElementById('seqAnimate').onchange = e => {
                if (e.target.checked) startSeqAnimation();
                else stopSeqAnimation();
            };
        }

        function generateSequence() {
            const M = parseInt(document.getElementById('seqMInput').value) || 30;
            const terms = parseInt(document.getElementById('seqTermsSlider').value);
            const type = document.getElementById('seqPreset').value;
            
            seqData.M = M;
            seqData.type = type;
            seqData.sequence = [];
            seqData.modSequence = [];

            // Generate raw sequence
            if (type === 'custom') {
                const formula = document.getElementById('seqFormula').value;
                for (let n = 0; n < terms; n++) {
                    try {
                        const val = evaluateFormula(formula, n);
                        seqData.sequence.push(val);
                        seqData.modSequence.push(mod(val, M));
                    } catch(e) {
                        alert('Invalid formula: ' + e.message);
                        return;
                    }
                }
            } else {
                for (let n = 0; n < terms; n++) {
                    const val = getSequenceValue(type, n);
                    seqData.sequence.push(val);
                    seqData.modSequence.push(mod(val, M));
                }
            }

            analyzeSequencePeriod();
            analyzeDistribution();
            renderSequence();
            displaySequenceTable();
        }

        function getSequenceValue(type, n) {
            switch(type) {
                case 'fibonacci': return fibonacci(n);
                case 'primes': return nthPrime(n);
                case 'squares': return n * n;
                case 'cubes': return n * n * n;
                case 'triangular': return n * (n + 1) / 2;
                case 'pentagonal': return n * (3 * n - 1) / 2;
                case 'catalan': return catalan(n);
                case 'factorial': return factorial(n);
                case 'powers2': return Math.pow(2, n);
                case 'powers3': return Math.pow(3, n);
                case 'lucas': return lucas(n);
                case 'tribonacci': return tribonacci(n);
                case 'collatz': return collatz(n);
                default: return n;
            }
        }

        function fibonacci(n) {
            if (n <= 1) return n;
            let a = 0, b = 1;
            for (let i = 2; i <= n; i++) {
                [a, b] = [b, a + b];
            }
            return b;
        }

        function lucas(n) {
            if (n === 0) return 2;
            if (n === 1) return 1;
            let a = 2, b = 1;
            for (let i = 2; i <= n; i++) {
                [a, b] = [b, a + b];
            }
            return b;
        }

        function tribonacci(n) {
            if (n === 0) return 0;
            if (n === 1 || n === 2) return 1;
            let a = 0, b = 1, c = 1;
            for (let i = 3; i <= n; i++) {
                [a, b, c] = [b, c, a + b + c];
            }
            return c;
        }

        function catalan(n) {
            if (n <= 1) return 1;
            let cat = [1, 1];
            for (let i = 2; i <= n; i++) {
                cat[i] = 0;
                for (let j = 0; j < i; j++) {
                    cat[i] += cat[j] * cat[i - 1 - j];
                }
            }
            return cat[n];
        }

        function factorial(n) {
            if (n > 20) return Infinity; // Prevent overflow
            let result = 1;
            for (let i = 2; i <= n; i++) result *= i;
            return result;
        }

        function nthPrime(n) {
            if (n === 0) return 2;
            let count = 0, num = 2;
            while (count <= n) {
                if (isPrime(num)) {
                    if (count === n) return num;
                    count++;
                }
                num++;
            }
            return num;
        }

        function collatz(n) {
            if (n === 0) return 0;
            let val = n, steps = 0;
            while (val > 1 && steps < 1000) {
                val = val % 2 === 0 ? val / 2 : 3 * val + 1;
                steps++;
            }
            return steps;
        }

        function evaluateFormula(formula, n) {
            // Safe formula evaluation
            const sanitized = formula.replace(/\^/g, '**')
                                     .replace(/sqrt\(/g, 'Math.sqrt(')
                                     .replace(/abs\(/g, 'Math.abs(')
                                     .replace(/[^0-9+\-*/(). nMath.sqrt]/g, '');
            return eval(sanitized.replace(/n/g, n));
        }

        function mod(a, m) {
            return ((a % m) + m) % m;
        }

        function analyzeSequencePeriod() {
            const seq = seqData.modSequence;
            let period = 0;
            
            // Find period (Pisano-style)
            for (let p = 1; p < seq.length / 2; p++) {
                let isPeriod = true;
                for (let i = 0; i < Math.min(p, seq.length - p); i++) {
                    if (seq[i] !== seq[i + p]) {
                        isPeriod = false;
                        break;
                    }
                }
                if (isPeriod) {
                    period = p;
                    break;
                }
            }

            seqData.period = period;
            
            let html = `<div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem;">`;
            html += `<div><strong>Period:</strong></div><div>${period > 0 ? period : 'Not detected (> ' + (seq.length/2) + ')'}</div>`;
            if (period > 0) {
                html += `<div><strong>Repeating:</strong></div><div>${seq.slice(0, period).join(', ')}</div>`;
            }
            html += `<div><strong>First term:</strong></div><div>${seq[0]}</div>`;
            html += `<div><strong>Last term:</strong></div><div>${seq[seq.length-1]}</div>`;
            html += `</div>`;
            
            document.getElementById('seqPeriodInfo').innerHTML = html;
        }

        function analyzeDistribution() {
            const dist = new Map();
            seqData.modSequence.forEach(v => dist.set(v, (dist.get(v) || 0) + 1));
            
            const sorted = Array.from(dist.entries()).sort((a,b) => b[1] - a[1]);
            const unique = dist.size;
            const mostCommon = sorted[0];
            
            let html = `<div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem;">`;
            html += `<div><strong>Unique values:</strong></div><div>${unique} of ${seqData.M}</div>`;
            html += `<div><strong>Coverage:</strong></div><div>${(unique/seqData.M*100).toFixed(1)}%</div>`;
            html += `<div><strong>Most common:</strong></div><div>${mostCommon[0]} (${mostCommon[1]}×)</div>`;
            
            const zeros = dist.get(0) || 0;
            html += `<div><strong>Zeros:</strong></div><div>${zeros}</div>`;
            html += `</div>`;
            
            document.getElementById('seqDistInfo').innerHTML = html;
        }

        function renderSequence() {
            const M = seqData.M;
            const seq = seqData.modSequence;
            const ctx = seqCtx;
            const w = 1000, h = 1000;
            const cx = w / 2, cy = h / 2;
            const radius = 400;
            
            // Clear
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);
            
            // Draw circle
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0, Math.PI * 2);
            ctx.stroke();
            
            // Draw modulus points
            const points = [];
            for (let r = 0; r < M; r++) {
                const angle = -Math.PI / 2 + (2 * Math.PI * r / M);
                const x = cx + radius * Math.cos(angle);
                const y = cy + radius * Math.sin(angle);
                points.push({ x, y, r });
                
                ctx.fillStyle = '#444';
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Draw sequence path
            if (document.getElementById('seqShowConnections').checked) {
                ctx.strokeStyle = 'rgba(102, 126, 234, 0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                seq.forEach((v, i) => {
                    const p = points[v];
                    if (i === 0) ctx.moveTo(p.x, p.y);
                    else ctx.lineTo(p.x, p.y);
                });
                ctx.stroke();
            }
            
            // Highlight period
            if (document.getElementById('seqHighlightPeriod').checked && seqData.period > 0) {
                const period = Math.min(seqData.period, seq.length);
                for (let i = 0; i < period; i++) {
                    const p = points[seq[i]];
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.5)';
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 8, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // Draw sequence points
            seq.forEach((v, i) => {
                const p = points[v];
                const hue = (i / seq.length) * 360;
                ctx.fillStyle = `hsl(${hue}, 80%, 60%)`;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // Labels
            if (document.getElementById('seqShowLabels').checked) {
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                for (let r = 0; r < Math.min(M, 50); r++) {
                    const angle = -Math.PI / 2 + (2 * Math.PI * r / M);
                    const x = cx + (radius + 25) * Math.cos(angle);
                    const y = cy + (radius + 25) * Math.sin(angle);
                    ctx.fillText(r, x, y);
                }
            }
            
            // Title
            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${seqData.type} mod ${M}`, cx, 40);
        }

        function displaySequenceTable() {
            const terms = Math.min(100, seqData.sequence.length);
            let html = '<div style="display: grid; grid-template-columns: auto auto auto; gap: 0.5rem; font-size: 0.85rem;">';
            html += '<div style="font-weight: bold;">n</div><div style="font-weight: bold;">a(n)</div><div style="font-weight: bold;">a(n) mod M</div>';
            
            for (let i = 0; i < terms; i++) {
                html += `<div>${i}</div><div>${seqData.sequence[i]}</div><div style="color: #667eea; font-weight: bold;">${seqData.modSequence[i]}</div>`;
            }
            
            if (seqData.sequence.length > terms) {
                html += `<div colspan="3" style="grid-column: 1 / -1; text-align: center; color: #999; padding: 0.5rem;">... ${seqData.sequence.length - terms} more terms</div>`;
            }
            
            html += '</div>';
            document.getElementById('seqValuesTable').innerHTML = html;
        }

        function startSeqAnimation() {
            // Animate drawing sequence
            let currentTerm = 0;
            const animate = () => {
                if (currentTerm < seqData.modSequence.length) {
                    renderSequenceAnimated(currentTerm);
                    currentTerm++;
                    seqAnimFrame = setTimeout(animate, 50);
                }
            };
            animate();
        }

        function stopSeqAnimation() {
            if (seqAnimFrame) clearTimeout(seqAnimFrame);
            renderSequence();
        }

        function renderSequenceAnimated(upTo) {
            // Similar to renderSequence but only up to 'upTo' term
            const M = seqData.M;
            const seq = seqData.modSequence.slice(0, upTo + 1);
            const ctx = seqCtx;
            const w = 1000, h = 1000, cx = w / 2, cy = h / 2, radius = 400;
            
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0, Math.PI * 2);
            ctx.stroke();
            
            const points = [];
            for (let r = 0; r < M; r++) {
                const angle = -Math.PI / 2 + (2 * Math.PI * r / M);
                points.push({ x: cx + radius * Math.cos(angle), y: cy + radius * Math.sin(angle) });
                ctx.fillStyle = '#444';
                ctx.beginPath();
                ctx.arc(points[r].x, points[r].y, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Path
            ctx.strokeStyle = 'rgba(102, 126, 234, 0.5)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            seq.forEach((v, i) => {
                const p = points[v];
                if (i === 0) ctx.moveTo(p.x, p.y);
                else ctx.lineTo(p.x, p.y);
            });
            ctx.stroke();
            
            // Points
            seq.forEach((v, i) => {
                const p = points[v];
                const hue = (i / seqData.modSequence.length) * 360;
                ctx.fillStyle = `hsl(${hue}, 80%, 60%)`;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
                ctx.fill();
            });
            
            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${seqData.type} mod ${M} (n=0..${upTo})`, cx, 40);
        }

        function exportSequenceData() {
            let csv = 'n,value,mod_M\n';
            for (let i = 0; i < seqData.sequence.length; i++) {
                csv += `${i},${seqData.sequence[i]},${seqData.modSequence[i]}\n`;
            }
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${seqData.type}-mod${seqData.M}.csv`;
            link.click();
        }

        function exportSequenceImage() {
            const link = document.createElement('a');
            link.download = `${seqData.type}-mod${seqData.M}.png`;
            link.href = seqCanvas.toDataURL();
            link.click();
        }

        // ═══════════════════════════════════════════════════════════
        // ANALYSIS & PATTERNS TAB IMPLEMENTATION
        // ═══════════════════════════════════════════════════════════

        let analysisData = {};
        let analysisCharts = {};

        function runAnalysis() {
            const M1 = parseInt(document.getElementById('analysisM1').value);
            const M2 = parseInt(document.getElementById('analysisM2').value);
            const mode = document.getElementById('analysisRange').value;

            if (mode === 'single') {
                analyzeSingle(M1);
            } else if (mode === 'compare') {
                analyzeCompare(M1, M2);
            } else if (mode === 'range') {
                analyzeRange(Math.min(M1, M2), Math.max(M1, M2));
            }
        }

        function analyzeSingle(M) {
            analysisData = computeAnalysis(M);
            displayKeyStats(analysisData);
            displayChannelBreakdown(analysisData);
            displayPatterns(analysisData);
            createGapChart(analysisData);
            createDensityChart([analysisData]);
            createTotientChart([analysisData]);
            createDivisorChart(analysisData);
        }

        function analyzeCompare(M1, M2) {
            const data1 = computeAnalysis(M1);
            const data2 = computeAnalysis(M2);
            analysisData = data1; // Store for exports
            displayKeyStatsCompare(data1, data2);
            displayChannelBreakdown(data1); // Show M1's channels
            createGapChart(data1); // Show M1's gap distribution
            createDensityChart([data1, data2]);
            createTotientChart([data1, data2]);
            createDivisorChart(data1); // Show M1's divisor structure
            displayPatternsCompare(data1, data2);
        }

        function analyzeRange(start, end) {
            const dataArray = [];
            for (let M = start; M <= Math.min(end, start + 100); M++) {
                dataArray.push(computeAnalysis(M));
            }
            analysisData = dataArray[0]; // Store first value for exports
            displayKeyStats(dataArray[0]); // Show stats for first M
            displayChannelBreakdown(dataArray[0]); // Show channels for first M
            createGapChart(dataArray[0]); // Show gap distribution for first M
            createDensityChart(dataArray);
            createTotientChart(dataArray);
            createDivisorChart(dataArray[0]); // Show divisor structure for first M
            displayPatterns(dataArray[0]); // Show patterns for first M
        }

        function computeAnalysis(M) {
            const divisors = getDivisors(M);
            const phiM = phi(M);
            const coprimes = [];
            const nonCoprimes = [];
            const gaps = [];
            const channels = new Map();

            // Analyze residues
            let lastCoprime = -1;
            for (let r = 0; r < M; r++) {
                const g = gcd(r, M);
                if (g === 1) {
                    coprimes.push(r);
                    if (lastCoprime >= 0) {
                        gaps.push(r - lastCoprime);
                    }
                    lastCoprime = r;
                } else {
                    nonCoprimes.push(r);
                    const channel = M / g;
                    channels.set(channel, (channels.get(channel) || 0) + 1);
                }
            }

            // Gap statistics
            const gapCounts = new Map();
            gaps.forEach(g => gapCounts.set(g, (gapCounts.get(g) || 0) + 1));

            return {
                M,
                divisors,
                divisorCount: divisors.length,
                phi: phiM,
                density: phiM / M,
                coprimes,
                nonCoprimes,
                gaps,
                gapCounts,
                avgGap: gaps.length > 0 ? gaps.reduce((a,b) => a+b, 0) / gaps.length : 0,
                maxGap: gaps.length > 0 ? Math.max(...gaps) : 0,
                minGap: gaps.length > 0 ? Math.min(...gaps) : 0,
                channels,
                isPrime: isPrime(M),
                isPrimePower: isPrimePower(M),
                omegaM: omega(M),
                primeFactorization: getPrimeFactorization(M)
            };
        }

        function isPrimePower(n) {
            if (n < 2) return false;
            const o = omega(n);
            return o === 1;
        }

        function displayKeyStats(data) {
            const html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div><strong>Modulus M:</strong></div><div>${data.M}</div>
                    <div><strong>Prime Factorization:</strong></div><div>${data.primeFactorization}</div>
                    <div><strong>φ(M):</strong></div><div>${data.phi}</div>
                    <div><strong>Coprime Density:</strong></div><div>${(data.density * 100).toFixed(2)}%</div>
                    <div><strong>Lattice Levels (divisors):</strong></div><div>${data.divisorCount}</div>
                    <div><strong>Farey Chains:</strong></div><div>${data.nonCoprimes.length}</div>
                    <div><strong>ω(M) (distinct primes):</strong></div><div>${data.omegaM}</div>
                    <div><strong>Classification:</strong></div><div>${data.isPrime ? 'Prime' : data.isPrimePower ? 'Prime Power' : 'Composite'}</div>
                    <div><strong>Avg Coprime Gap:</strong></div><div>${data.avgGap.toFixed(2)}</div>
                    <div><strong>Max Coprime Gap:</strong></div><div>${data.maxGap}</div>
                </div>
            `;
            document.getElementById('keyStats').innerHTML = html;
        }

        function displayKeyStatsCompare(data1, data2) {
            const html = `
                <div style="display: grid; grid-template-columns: auto 1fr 1fr; gap: 0.5rem 1rem;">
                    <div style="font-weight: bold;"></div>
                    <div style="font-weight: bold; color: #667eea;">M = ${data1.M}</div>
                    <div style="font-weight: bold; color: #764ba2;">M = ${data2.M}</div>
                    
                    <div><strong>φ(M):</strong></div><div>${data1.phi}</div><div>${data2.phi}</div>
                    <div><strong>Density:</strong></div><div>${(data1.density * 100).toFixed(2)}%</div><div>${(data2.density * 100).toFixed(2)}%</div>
                    <div><strong>Divisors:</strong></div><div>${data1.divisorCount}</div><div>${data2.divisorCount}</div>
                    <div><strong>Chains:</strong></div><div>${data1.nonCoprimes.length}</div><div>${data2.nonCoprimes.length}</div>
                    <div><strong>Avg Gap:</strong></div><div>${data1.avgGap.toFixed(2)}</div><div>${data2.avgGap.toFixed(2)}</div>
                    <div><strong>Max Gap:</strong></div><div>${data1.maxGap}</div><div>${data2.maxGap}</div>
                </div>
            `;
            document.getElementById('keyStats').innerHTML = html;
        }

        function displayChannelBreakdown(data) {
            let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;"><thead><tr style="background: #667eea; color: white;"><th style="padding: 0.5rem; text-align: left;">Channel M\'</th><th style="padding: 0.5rem; text-align: right;">Count</th><th style="padding: 0.5rem; text-align: right;">%</th></tr></thead><tbody>';
            
            const sorted = Array.from(data.channels.entries()).sort((a, b) => a[0] - b[0]);
            sorted.forEach(([channel, count]) => {
                const pct = (count / data.M * 100).toFixed(1);
                html += `<tr style="border-bottom: 1px solid #eee;"><td style="padding: 0.5rem;">${channel}</td><td style="padding: 0.5rem; text-align: right;">${count}</td><td style="padding: 0.5rem; text-align: right;">${pct}%</td></tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('channelBreakdown').innerHTML = html;
        }

        function displayPatterns(data) {
            let patterns = [];
            
            if (data.isPrime) patterns.push('✓ M is prime → φ(M) = M-1 → maximum density');
            if (data.isPrimePower) patterns.push('✓ M is a prime power → simpler structure');
            if (data.divisorCount > 10) patterns.push('✓ Highly composite → many Farey channels');
            if (data.density > 0.5) patterns.push('✓ High coprime density (> 50%)');
            if (data.density < 0.3) patterns.push('⚠ Low coprime density (< 30%)');
            if (data.maxGap > M / 10) patterns.push('⚠ Large coprime gap detected');
            if (data.omegaM >= 4) patterns.push('✓ Many distinct prime factors → rich structure');
            
            const html = patterns.length > 0 ? patterns.map(p => `<div style="padding: 0.5rem; background: rgba(102,126,234,0.1); border-left: 3px solid #667eea; margin-bottom: 0.5rem;">${p}</div>`).join('') : '<p>Computing patterns...</p>';
            document.getElementById('patternDetection').innerHTML = html;
        }

        function displayPatternsCompare(data1, data2) {
            let patterns = [];
            const M1 = data1.M, M2 = data2.M;
            
            if (gcd(M1, M2) > 1) patterns.push(`✓ gcd(${M1}, ${M2}) = ${gcd(M1, M2)} → shared structure`);
            if (M2 % M1 === 0) patterns.push(`✓ ${M2} is a multiple of ${M1} → ${M1} divides ${M2}`);
            if (data1.density > data2.density) patterns.push(`✓ M=${M1} has higher coprime density`);
            else if (data2.density > data1.density) patterns.push(`✓ M=${M2} has higher coprime density`);
            
            const html = patterns.length > 0 ? patterns.map(p => `<div style="padding: 0.5rem; background: rgba(102,126,234,0.1); border-left: 3px solid #667eea; margin-bottom: 0.5rem;">${p}</div>`).join('') : '<p>No significant patterns detected.</p>';
            document.getElementById('patternDetection').innerHTML = html;
        }

        function createGapChart(data) {
            const ctx = document.getElementById('gapChart');
            if (analysisCharts.gap) analysisCharts.gap.destroy();
            
            const gapData = Array.from(data.gapCounts.entries()).sort((a,b) => a[0] - b[0]);
            
            analysisCharts.gap = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: gapData.map(([g]) => `Gap ${g}`),
                    datasets: [{
                        label: 'Frequency',
                        data: gapData.map(([,c]) => c),
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Count' } } }
                }
            });
        }

        function createDensityChart(dataArray) {
            const ctx = document.getElementById('densityChart');
            if (analysisCharts.density) analysisCharts.density.destroy();
            
            analysisCharts.density = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataArray.map(d => d.M),
                    datasets: [{
                        label: 'φ(M)/M',
                        data: dataArray.map(d => d.density),
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { beginAtZero: true, max: 1, title: { display: true, text: 'Density' } },
                        x: { title: { display: true, text: 'Modulus M' } }
                    }
                }
            });
        }

        function createTotientChart(dataArray) {
            const ctx = document.getElementById('totientChart');
            if (analysisCharts.totient) analysisCharts.totient.destroy();
            
            analysisCharts.totient = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataArray.map(d => d.M),
                    datasets: [{
                        label: 'φ(M)',
                        data: dataArray.map(d => d.phi),
                        borderColor: 'rgba(118, 75, 162, 1)',
                        backgroundColor: 'rgba(118, 75, 162, 0.2)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { beginAtZero: true, title: { display: true, text: 'φ(M)' } },
                        x: { title: { display: true, text: 'Modulus M' } }
                    }
                }
            });
        }

        function createDivisorChart(data) {
            const ctx = document.getElementById('divisorChart');
            if (analysisCharts.divisor) analysisCharts.divisor.destroy();
            
            analysisCharts.divisor = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Coprime', 'Reducible'],
                    datasets: [{
                        data: [data.phi, data.nonCoprimes.length],
                        backgroundColor: ['rgba(40, 167, 69, 0.7)', 'rgba(255, 193, 7, 0.7)'],
                        borderColor: ['rgba(40, 167, 69, 1)', 'rgba(255, 193, 7, 1)'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function exportAnalysisCSV() {
            if (!analysisData.M) { alert('Please run analysis first'); return; }
            
            let csv = 'Modulus,Totient,Density,Divisors,Chains,AvgGap,MaxGap\n';
            csv += `${analysisData.M},${analysisData.phi},${analysisData.density},${analysisData.divisorCount},${analysisData.nonCoprimes.length},${analysisData.avgGap},${analysisData.maxGap}\n`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `analysis-M${analysisData.M}.csv`;
            link.click();
        }

        function exportAnalysisJSON() {
            if (!analysisData.M) { alert('Please run analysis first'); return; }
            
            const blob = new Blob([JSON.stringify(analysisData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `analysis-M${analysisData.M}.json`;
            link.click();
        }

        function exportAnalysisReport() {
            if (!analysisData.M) { alert('Please run analysis first'); return; }
            
            let report = `MODULAR REDUCTION ANALYSIS REPORT\n`;
            report += `=====================================\n\n`;
            report += `Modulus M = ${analysisData.M}\n`;
            report += `Prime Factorization: ${analysisData.primeFactorization}\n\n`;
            report += `KEY STATISTICS:\n`;
            report += `- Euler Totient φ(M) = ${analysisData.phi}\n`;
            report += `- Coprime Density = ${(analysisData.density * 100).toFixed(2)}%\n`;
            report += `- Lattice Levels = ${analysisData.divisorCount}\n`;
            report += `- Farey Chains = ${analysisData.nonCoprimes.length}\n`;
            report += `- Average Gap = ${analysisData.avgGap.toFixed(2)}\n`;
            report += `- Maximum Gap = ${analysisData.maxGap}\n\n`;
            report += `CLASSIFICATION:\n`;
            report += `- Type: ${analysisData.isPrime ? 'Prime' : analysisData.isPrimePower ? 'Prime Power' : 'Composite'}\n`;
            report += `- Distinct Prime Factors ω(M) = ${analysisData.omegaM}\n\n`;
            report += `Generated by Modular Reduction Projection Research Portal\n`;
            report += `wessengetachew.github.io\n`;
            
            const blob = new Blob([report], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `report-M${analysisData.M}.txt`;
            link.click();
        }

        // ═══════════════════════════════════════════════════════════
        // 3D FAREY DIVISOR LATTICE TAB IMPLEMENTATION
        // ═══════════════════════════════════════════════════════════

        window.chandelierInitialized = false;
        let chandelier = {
            canvas: null, ctx: null, M: 30, xTilt: 45, yRot: 0, zSpin: 0, vSpace: 1.0, radScale: 1.0,
            innerSpeed: 0, outerSpeed: 0, indivSpeed: 0, animate: false, showChains: true, showLabels: false,
            autoRotate: false, autoRotateAngle: 0, ringRotations: new Map(), animFrame: null,
            isDragging: false, lastMouseX: 0, lastMouseY: 0
        };

        function initChandelier() {
            chandelier.canvas = document.getElementById('chandelier-canvas');
            chandelier.ctx = chandelier.canvas.getContext('2d');
            setupChandelierEvents();
            renderChandelier();
            startChandelierAnimation();
        }

        function project3DChand(x, y, z) {
            const xRad = chandelier.xTilt * Math.PI / 180;
            const yRad = (chandelier.yRot + chandelier.autoRotateAngle) * Math.PI / 180;
            const zRad = chandelier.zSpin * Math.PI / 180;
            let x1 = x * Math.cos(zRad) - y * Math.sin(zRad);
            let y1 = x * Math.sin(zRad) + y * Math.cos(zRad);
            let x2 = x1;
            let y2 = y1 * Math.cos(xRad) - z * Math.sin(xRad);
            let z2 = y1 * Math.sin(xRad) + z * Math.cos(xRad);
            let x3 = x2 * Math.cos(yRad) + z2 * Math.sin(yRad);
            let y3 = y2;
            let z3 = -x2 * Math.sin(yRad) + z2 * Math.cos(yRad);
            const perspective = 1500;
            const scale = perspective / (perspective + z3 + 500);
            return { x: 600 + x3 * scale, y: 600 - y3 * scale, z: z3, scale: scale, depth: z3 + 500 };
        }

        function getRingHeightChand(channelM, totalM) {
            return -chandelier.vSpace * 500 * (1 - channelM / totalM);
        }

        function calculateChandelierRings() {
            const M = chandelier.M;
            const divisors = getDivisors(M);
            const allElements = [];
            divisors.forEach(d => {
                const ringHeight = getRingHeightChand(d, M);
                const ringRot = (chandelier.ringRotations.get(d) || 0) * Math.PI / 180;
                const radius = 400 * (d / M) * chandelier.radScale;
                const circlePoints = [];
                for (let i = 0; i <= Math.max(60, d * 2); i++) {
                    const angle = (2 * Math.PI * i / Math.max(60, d * 2)) + ringRot;
                    circlePoints.push({ x: radius * Math.cos(angle), y: radius * Math.sin(angle), z: ringHeight });
                }
                allElements.push({ type: 'ring-circle', points: circlePoints, depth: ringHeight + 500 });
                for (let r = 0; r < d; r++) {
                    const g = gcd(r, d);
                    const angle = (2 * Math.PI * r / d) + ringRot;
                    const x = radius * Math.cos(angle), y = radius * Math.sin(angle);
                    allElements.push({ type: 'point', r: r, M: d, gcd: g, coprime: g === 1, x, y, z: ringHeight });
                    if (!((g === 1)) && d > 1 && chandelier.showChains) {
                        const targetM = d / g, targetR = r / g;
                        const targetAngle = (2 * Math.PI * targetR / targetM) + ((chandelier.ringRotations.get(targetM) || 0) * Math.PI / 180);
                        const targetRadius = 400 * (targetM / M) * chandelier.radScale;
                        allElements.push({ type: 'chain', x1: x, y1: y, z1: ringHeight,
                            x2: targetRadius * Math.cos(targetAngle), y2: targetRadius * Math.sin(targetAngle),
                            z2: getRingHeightChand(targetM, M) });
                    }
                }
            });
            return allElements;
        }

        function renderChandelier() {
            const ctx = chandelier.ctx, w = chandelier.canvas.width, h = chandelier.canvas.height;
            ctx.fillStyle = '#000'; ctx.fillRect(0, 0, w, h);
            const projected = [];
            calculateChandelierRings().forEach(el => {
                if (el.type === 'point') {
                    projected.push({ ...el, ...project3DChand(el.x, el.y, el.z) });
                } else if (el.type === 'chain') {
                    const p1 = project3DChand(el.x1, el.y1, el.z1), p2 = project3DChand(el.x2, el.y2, el.z2);
                    projected.push({ type: 'chain', x1: p1.x, y1: p1.y, x2: p2.x, y2: p2.y, depth: (p1.depth + p2.depth) / 2 });
                } else if (el.type === 'ring-circle') {
                    projected.push({ type: 'ring-circle', points: el.points.map(p => project3DChand(p.x, p.y, p.z)), depth: el.depth });
                }
            });
            projected.sort((a, b) => a.depth - b.depth);
            ctx.globalAlpha = 0.2; ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 1;
            projected.forEach(el => { if (el.type === 'ring-circle') { ctx.beginPath(); el.points.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y)); ctx.stroke(); } });
            ctx.globalAlpha = 0.4;
            projected.forEach(el => { if (el.type === 'chain') { const g = ctx.createLinearGradient(el.x1, el.y1, el.x2, el.y2); g.addColorStop(0, '#ffd700'); g.addColorStop(1, '#ffaa00'); ctx.strokeStyle = g; ctx.lineWidth = 1.5; ctx.beginPath(); ctx.moveTo(el.x1, el.y1); ctx.lineTo(el.x2, el.y2); ctx.stroke(); } });
            ctx.globalAlpha = 1.0;
            projected.forEach(el => {
                if (el.type === 'point') {
                    const size = Math.max(2, 5 * el.scale);
                    const [color, glow] = el.r === 0 ? ['#ff0000', 'rgba(255,0,0,0.5)'] : el.coprime ? ['#00ffff', 'rgba(0,255,255,0.5)'] : ['#ffff00', 'rgba(255,255,0,0.5)'];
                    ctx.shadowBlur = 8; ctx.shadowColor = glow; ctx.fillStyle = color;
                    ctx.beginPath(); ctx.arc(el.x, el.y, size, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0;
                    if (chandelier.showLabels && el.M === chandelier.M && el.r % Math.ceil(chandelier.M / 30) === 0) {
                        ctx.save(); ctx.fillStyle = '#fff'; ctx.strokeStyle = '#000'; ctx.lineWidth = 3;
                        ctx.font = `bold ${Math.max(10, 12 * el.scale)}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                        const ly = el.y - 15 * el.scale; ctx.strokeText(el.r, el.x, ly); ctx.fillText(el.r, el.x, ly); ctx.restore();
                    }
                }
            });
            const divisors = getDivisors(chandelier.M);
            document.getElementById('chandTitleM').textContent = chandelier.M;
            document.getElementById('chandTitleRings').textContent = divisors.length;
            document.getElementById('chandTitleChains').textContent = chandelier.M - phi(chandelier.M);
        }

        function animateChandelier() {
            if (chandelier.animate) {
                const dt = 1/60, M = chandelier.M;
                getDivisors(M).forEach(d => {
                    let rot = chandelier.ringRotations.get(d) || 0;
                    rot += chandelier.innerSpeed * (d / M) * dt + chandelier.outerSpeed * ((M - d) / M) * dt + chandelier.indivSpeed * dt;
                    chandelier.ringRotations.set(d, rot % 360);
                });
            }
            if (chandelier.autoRotate) chandelier.autoRotateAngle += 0.5;
            renderChandelier();
            chandelier.animFrame = requestAnimationFrame(animateChandelier);
        }

        function startChandelierAnimation() { if (!chandelier.animFrame) animateChandelier(); }
        function setChandM(m) { chandelier.M = m; document.getElementById('chandMSlider').value = m; document.getElementById('chandMInput').value = m; document.getElementById('chandM').textContent = m; chandelier.ringRotations.clear(); renderChandelier(); }
        function resetChandRotation() { chandelier.xTilt = 45; chandelier.yRot = 0; chandelier.zSpin = 0; chandelier.autoRotateAngle = 0; ['chandXTiltSlider', 'chandYRotSlider', 'chandZSpinSlider'].forEach((id, i) => document.getElementById(id).value = [45, 0, 0][i]); ['chandXTiltVal', 'chandYRotVal', 'chandZSpinVal'].forEach((id, i) => document.getElementById(id).textContent = [45, 0, 0][i]); renderChandelier(); }
        function resetChandRings() { chandelier.ringRotations.clear(); renderChandelier(); }
        
        function playChandAnimation() {
            chandelier.animate = true;
            document.getElementById('chandAnimateCheck').checked = true;
            document.getElementById('chandPlayBtn').style.display = 'none';
            document.getElementById('chandStopBtn').style.display = 'block';
        }
        
        function stopChandAnimation() {
            chandelier.animate = false;
            document.getElementById('chandAnimateCheck').checked = false;
            document.getElementById('chandPlayBtn').style.display = 'block';
            document.getElementById('chandStopBtn').style.display = 'none';
        }
        function exportChandelier() {
            // Create temporary high-res canvas
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = 1600;
            exportCanvas.height = 1800;
            const ctx = exportCanvas.getContext('2d');
            
            // Background
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, 1600, 1800);
            
            // Title section
            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('3D Farey Divisor Lattice', 800, 50);
            
            ctx.fillStyle = '#aaa';
            ctx.font = '18px Arial';
            ctx.fillText('Hierarchical Structure of Modular Reduction in ℤ/Mℤ', 800, 80);
            
            // Stats box (left side)
            ctx.fillStyle = 'rgba(102, 126, 234, 0.2)';
            ctx.fillRect(20, 110, 360, 180);
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.strokeRect(20, 110, 360, 180);
            
            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Configuration', 35, 140);
            
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            const M = chandelier.M;
            const divisors = getDivisors(M);
            ctx.fillText(`Modulus M = ${M}`, 35, 170);
            ctx.fillText(`Prime Factorization: ${getPrimeFactorization(M)}`, 35, 195);
            ctx.fillText(`Lattice Levels: ${divisors.length}`, 35, 220);
            ctx.fillText(`Coprime Residues: φ(${M}) = ${phi(M)}`, 35, 245);
            ctx.fillText(`Farey Chains: ${M - phi(M)}`, 35, 270);
            
            // Angles box (right side)
            ctx.fillStyle = 'rgba(102, 126, 234, 0.2)';
            ctx.fillRect(1220, 110, 360, 180);
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.strokeRect(1220, 110, 360, 180);
            
            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 20px Arial';
            ctx.fillText('3D Rotation Angles', 1235, 140);
            
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.fillText(`X-Tilt: ${chandelier.xTilt}°`, 1235, 170);
            ctx.fillText(`Y-Rotation: ${Math.round(chandelier.yRot + chandelier.autoRotateAngle)}°`, 1235, 195);
            ctx.fillText(`Z-Spin: ${chandelier.zSpin}°`, 1235, 220);
            ctx.fillText(`Vertical Spacing: ${chandelier.vSpace.toFixed(2)}`, 1235, 245);
            ctx.fillText(`Radial Scale: ${chandelier.radScale.toFixed(2)}`, 1235, 270);
            
            // Save current chandelier canvas state
            const oldCanvas = chandelier.canvas;
            const oldCtx = chandelier.ctx;
            
            // Temporarily use export canvas
            chandelier.canvas = exportCanvas;
            chandelier.ctx = ctx;
            
            // Render the 3D visualization in the middle area
            ctx.save();
            ctx.translate(0, 300);
            
            // Render main visualization
            const w = 1600, h = 1200;
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);
            
            // Use same rendering logic but with adjusted coordinates
            const projected = [];
            calculateChandelierRings().forEach(el => {
                if (el.type === 'point') {
                    const proj = project3DChand(el.x, el.y, el.z);
                    // Adjust coordinates for centered rendering
                    proj.x = (proj.x - 600) * 1.33 + 800;
                    proj.y = (proj.y - 600) * 1.33 + 600;
                    projected.push({ ...el, ...proj });
                } else if (el.type === 'chain') {
                    const p1 = project3DChand(el.x1, el.y1, el.z1);
                    const p2 = project3DChand(el.x2, el.y2, el.z2);
                    p1.x = (p1.x - 600) * 1.33 + 800;
                    p1.y = (p1.y - 600) * 1.33 + 600;
                    p2.x = (p2.x - 600) * 1.33 + 800;
                    p2.y = (p2.y - 600) * 1.33 + 600;
                    projected.push({ type: 'chain', x1: p1.x, y1: p1.y, x2: p2.x, y2: p2.y, depth: (p1.depth + p2.depth) / 2 });
                } else if (el.type === 'ring-circle') {
                    const projectedPoints = el.points.map(p => {
                        const proj = project3DChand(p.x, p.y, p.z);
                        proj.x = (proj.x - 600) * 1.33 + 800;
                        proj.y = (proj.y - 600) * 1.33 + 600;
                        return proj;
                    });
                    projected.push({ type: 'ring-circle', points: projectedPoints, depth: el.depth });
                }
            });
            
            projected.sort((a, b) => a.depth - b.depth);
            
            // Ring circles
            ctx.globalAlpha = 0.2;
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 1;
            projected.forEach(el => {
                if (el.type === 'ring-circle') {
                    ctx.beginPath();
                    el.points.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
                    ctx.stroke();
                }
            });
            ctx.globalAlpha = 1.0;
            
            // Chains
            if (chandelier.showChains) {
                ctx.globalAlpha = 0.4;
                projected.forEach(el => {
                    if (el.type === 'chain') {
                        const gradient = ctx.createLinearGradient(el.x1, el.y1, el.x2, el.y2);
                        gradient.addColorStop(0, '#ffd700');
                        gradient.addColorStop(1, '#ffaa00');
                        ctx.strokeStyle = gradient;
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(el.x1, el.y1);
                        ctx.lineTo(el.x2, el.y2);
                        ctx.stroke();
                    }
                });
                ctx.globalAlpha = 1.0;
            }
            
            // Points
            projected.forEach(el => {
                if (el.type === 'point') {
                    const size = Math.max(3, 6 * el.scale);
                    const [color, glow] = el.r === 0 ? ['#ff0000', 'rgba(255,0,0,0.5)'] : 
                                         el.coprime ? ['#00ffff', 'rgba(0,255,255,0.5)'] : 
                                         ['#ffff00', 'rgba(255,255,0,0.5)'];
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = glow;
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.arc(el.x, el.y, size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
            });
            
            ctx.restore();
            
            // Legend at bottom
            ctx.fillStyle = 'rgba(102, 126, 234, 0.2)';
            ctx.fillRect(500, 1520, 600, 240);
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.strokeRect(500, 1520, 600, 240);
            
            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 22px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Color Legend', 800, 1555);
            
            ctx.textAlign = 'left';
            ctx.font = '18px Arial';
            
            // Coprime
            ctx.fillStyle = '#00ffff';
            ctx.beginPath();
            ctx.arc(530, 1595, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.fillText('Coprime residues: gcd(r, M) = 1', 560, 1602);
            ctx.fillStyle = '#aaa';
            ctx.font = '14px Arial';
            ctx.fillText('Generate the unit group (ℤ/Mℤ)×', 560, 1622);
            
            // Reducible
            ctx.fillStyle = '#ffff00';
            ctx.beginPath();
            ctx.arc(530, 1660, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.font = '18px Arial';
            ctx.fillText('Reducible residues: gcd(r, M) > 1', 560, 1667);
            ctx.fillStyle = '#aaa';
            ctx.font = '14px Arial';
            ctx.fillText('Project to smaller quotient rings via Farey chains', 560, 1687);
            
            // Identity
            ctx.fillStyle = '#ff0000';
            ctx.beginPath();
            ctx.arc(530, 1725, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.font = '18px Arial';
            ctx.fillText('Identity element: r ≡ 0 (mod M)', 560, 1732);
            ctx.fillStyle = '#aaa';
            ctx.font = '14px Arial';
            ctx.fillText('Additive identity in each quotient ring', 560, 1752);
            
            // Footer
            ctx.fillStyle = '#667eea';
            ctx.font = 'italic 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Generated by Modular Reduction Projection Research Portal', 800, 1785);
            ctx.fillText('wessengetachew.github.io', 800, 1805);
            
            // Restore original canvas
            chandelier.canvas = oldCanvas;
            chandelier.ctx = oldCtx;
            
            // Download
            const link = document.createElement('a');
            link.download = `farey-divisor-lattice-M${M}-x${chandelier.xTilt}-y${Math.round(chandelier.yRot)}-z${chandelier.zSpin}.png`;
            link.href = exportCanvas.toDataURL();
            link.click();
        }
        
        function getPrimeFactorization(n) {
            if (n === 1) return '1';
            const factors = [];
            let temp = n;
            for (let p = 2; p * p <= temp; p++) {
                let count = 0;
                while (temp % p === 0) {
                    temp /= p;
                    count++;
                }
                if (count > 0) {
                    factors.push(count > 1 ? `${p}^${count}` : `${p}`);
                }
            }
            if (temp > 1) factors.push(`${temp}`);
            return factors.join(' × ');
        }

        function setupChandelierEvents() {
            ['chandMSlider', 'chandMInput'].forEach(id => document.getElementById(id).oninput = e => { const v = parseInt(e.target.value); if (v >= 6 && v <= 2000) setChandM(v); });
            [['chandXTiltSlider', 'chandXTiltVal', 'xTilt'], ['chandYRotSlider', 'chandYRotVal', 'yRot'], ['chandZSpinSlider', 'chandZSpinVal', 'zSpin']].forEach(([sid, vid, prop]) => {
                document.getElementById(sid).oninput = e => { chandelier[prop] = parseInt(e.target.value); document.getElementById(vid).textContent = e.target.value; renderChandelier(); };
            });
            document.getElementById('chandVSpaceSlider').oninput = e => { chandelier.vSpace = parseInt(e.target.value) / 100; document.getElementById('chandVSpaceVal').textContent = chandelier.vSpace.toFixed(1); renderChandelier(); };
            document.getElementById('chandRadScaleSlider').oninput = e => { chandelier.radScale = parseInt(e.target.value) / 100; document.getElementById('chandRadScaleVal').textContent = chandelier.radScale.toFixed(1); renderChandelier(); };
            [['chandInnerSpeedSlider', 'chandInnerSpeedVal', 'innerSpeed'], ['chandOuterSpeedSlider', 'chandOuterSpeedVal', 'outerSpeed'], ['chandIndivSpeedSlider', 'chandIndivSpeedVal', 'indivSpeed']].forEach(([sid, vid, prop]) => {
                document.getElementById(sid).oninput = e => { chandelier[prop] = parseInt(e.target.value); document.getElementById(vid).textContent = e.target.value; };
            });
            document.getElementById('chandAnimateCheck').onchange = e => {
                chandelier.animate = e.target.checked;
                if (e.target.checked) {
                    document.getElementById('chandPlayBtn').style.display = 'none';
                    document.getElementById('chandStopBtn').style.display = 'block';
                } else {
                    document.getElementById('chandPlayBtn').style.display = 'block';
                    document.getElementById('chandStopBtn').style.display = 'none';
                }
            };
            ['chandShowChains', 'chandShowLabels', 'chandAutoRotate'].forEach((id, i) => {
                document.getElementById(id).onchange = e => { chandelier[['showChains', 'showLabels', 'autoRotate'][i]] = e.target.checked; if (i < 2) renderChandelier(); };
            });
            const c = chandelier.canvas;
            c.addEventListener('mousedown', e => { chandelier.isDragging = true; chandelier.lastMouseX = e.clientX; chandelier.lastMouseY = e.clientY; c.style.cursor = 'grabbing'; });
            c.addEventListener('mousemove', e => { if (!chandelier.isDragging) return; const dx = e.clientX - chandelier.lastMouseX, dy = e.clientY - chandelier.lastMouseY; chandelier.yRot = (chandelier.yRot + dx * 0.5) % 360; chandelier.xTilt = Math.max(-90, Math.min(90, chandelier.xTilt - dy * 0.5)); document.getElementById('chandYRotSlider').value = chandelier.yRot; document.getElementById('chandXTiltSlider').value = chandelier.xTilt; document.getElementById('chandYRotVal').textContent = Math.round(chandelier.yRot); document.getElementById('chandXTiltVal').textContent = Math.round(chandelier.xTilt); chandelier.lastMouseX = e.clientX; chandelier.lastMouseY = e.clientY; renderChandelier(); });
            c.addEventListener('mouseup', () => { chandelier.isDragging = false; c.style.cursor = 'grab'; });
            c.addEventListener('mouseleave', () => { chandelier.isDragging = false; c.style.cursor = 'grab'; });
            c.style.cursor = 'grab';
            document.addEventListener('keydown', e => {
                const activeTab = document.querySelector('.tab-content.active');
                if (!activeTab || activeTab.id !== 'chandelier-tab') return;
                const k = e.key.toLowerCase();
                if (k === 'r') resetChandRotation();
                else if (k === ' ') { e.preventDefault(); chandelier.autoRotate = !chandelier.autoRotate; document.getElementById('chandAutoRotate').checked = chandelier.autoRotate; }
                else if (k === 'c') { chandelier.showChains = !chandelier.showChains; document.getElementById('chandShowChains').checked = chandelier.showChains; renderChandelier(); }
                else if (k === 'l') { chandelier.showLabels = !chandelier.showLabels; document.getElementById('chandShowLabels').checked = chandelier.showLabels; renderChandelier(); }
            });
        }

        // ═══════════════════════════════════════════════════════════
        // PAGE INITIALIZATION
        // ═══════════════════════════════════════════════════════════
        
        // Initialize portal tab on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Portal tab is active by default, so initialize it
            setupEvents();
            calculate();
            render();
            window.portalInitialized = true;
        });
    </script>
</body>
    </html>
